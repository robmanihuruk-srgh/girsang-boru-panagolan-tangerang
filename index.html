<!DOCTYPE html>                    
  
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üèõÔ∏è Girsang Boru Panagolan Tangerang - Management System</title>
    <style>
        *{margin:0;padding:0;box-sizing:border-box;}
        body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:#f8f9fa;color:#333;}
        .header{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;padding:20px;text-align:center;box-shadow:0 2px 10px rgba(0,0,0,0.1);position:relative;}
        .header h1{font-size:24px;margin:0;font-weight:600;}
        .header p{font-size:14px;opacity:0.9;margin-top:5px;}
        .close-btn-logout{position:absolute;top:20px;right:20px;cursor:pointer;font-size:24px;background:rgba(255,255,255,0.2);width:40px;height:40px;line-height:40px;border-radius:50%;}

        .status-indicator{position:absolute;top:20px;left:20px;display:flex;align-items:center;gap:5px;font-size:12px;}
        .status-dot{width:8px;height:8px;border-radius:50%;background:#28a745;}
        .status-offline{background:#dc3545;}
        .status-syncing{background:#ffc107;animation:pulse 1.5s infinite;}
        .status-admin-only{background:#17a2b8;color:white;}

        @keyframes pulse{0%,100%{opacity:1;}50%{opacity:0.5;}}

        .navbar{background:#fff;padding:15px;box-shadow:0 2px 5px rgba(0,0,0,0.1);position:sticky;top:0;z-index:100;overflow-x:auto;}
        .nav-links{display:flex;justify-content:center;gap:15px;white-space:nowrap;min-width:max-content;}
        .nav-links a{color:#495057;text-decoration:none;font-weight:500;padding:8px 16px;border-radius:20px;transition:all 0.3s;cursor:pointer;font-size:14px;}
        .nav-links a:hover,.nav-links a.active{background:#667eea;color:white;}
        .nav-users{display:none;}

        .container{max-width:1200px;margin:20px auto;padding:0 15px;}

        .stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:15px;margin-bottom:20px;}
        .stat-card{background:white;padding:20px;border-radius:12px;box-shadow:0 4px 6px rgba(0,0,0,0.05);text-align:center;}
        .stat-number{font-size:28px;font-weight:bold;color:#667eea;margin-bottom:5px;}
        .stat-label{color:#666;font-size:12px;text-transform:uppercase;letter-spacing:1px;}

        .section{background:white;margin-bottom:30px;border-radius:12px;overflow:hidden;box-shadow:0 4px 6px rgba(0,0,0,0.05);display:none;animation:fadeIn 0.5s;}
        .section.active{display:block;}
        @keyframes fadeIn{from{opacity:0;transform:translateY(10px);}to{opacity:1;transform:translateY(0);}}

        .section-header{padding:20px;background:linear-gradient(135deg,#f093fb 0%,#f5576c 100%);color:white;position:relative;}
        .section-header.admin-only::after{content:'üëë ADMIN ONLY';position:absolute;right:20px;top:50%;transform:translateY(-50%);font-size:12px;background:#17a2b8;padding:4px 8px;border-radius:12px;}
        .section-header h2{font-size:18px;margin:0;}
        .section-content{padding:20px;}

        .form-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin-bottom:20px;background:#f8f9fa;padding:20px;border-radius:10px;}
        input,select,textarea{width:100%;padding:10px;border:1px solid #ced4da;border-radius:6px;font-size:14px;}
        input:focus,select:focus,textarea:focus{outline:none;border-color:#667eea;box-shadow:0 0 0 3px rgba(102,126,234,0.1);}

        .btn{padding:10px 20px;border:none;border-radius:6px;cursor:pointer;font-size:14px;font-weight:600;transition:0.3s;width:100%;}
        .btn-primary{background:#667eea;color:white;}
        .btn-primary:hover{background:#5a6fd6;}
        .btn-danger{background:#ff6b6b;color:white;}
        .btn-success{background:#28a745;color:white;}
        .btn-warning{background:#ffc107;color:#212529;}
        .btn-sync{background:#17a2b8;color:white;margin-top:10px;}
        .btn-sync:hover{background:#138496;}
        .btn-sm{padding:6px 12px;font-size:12px;width:auto;}

        .table-responsive{overflow-x:auto;}
        table{width:100%;border-collapse:collapse;font-size:14px;}
        th{padding:12px;background:#f1f3f5;color:#495057;text-align:left;font-weight:600;}
        td{padding:12px;border-bottom:1px solid #dee2e6;}
        tr:last-child td{border-bottom:none;}

        .status-badge{padding:4px 10px;border-radius:12px;font-size:11px;font-weight:600;text-transform:uppercase;}
        .status-aktif{background:#d4edda;color:#155724;}
        .status-nonaktif{background:#f8d7da;color:#721c24;}
        .money-plus{color:#28a745;font-weight:bold;}
        .money-minus{color:#dc3545;font-weight:bold;}
        .sync-status{padding:10px;border-radius:6px;margin-bottom:15px;font-size:12px;}

        .login-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:#f8f9fa;display:flex;align-items:center;justify-content:center;z-index:2000;}
        .login-box{background:white;padding:40px;border-radius:20px;width:90%;max-width:350px;box-shadow:0 10px 25px rgba(0,0,0,0.1);text-align:center;}

        .config-status{background:#d4edda;padding:15px;border-radius:8px;margin-bottom:20px;border-left:4px solid #28a745;}
        .config-status h3{margin:0 0 10px 0;color:#155724;}
        .config-status.admin-only{display:none;}
        .user-info{display:flex;align-items:center;gap:10px;background:#e9ecef;padding:10px;border-radius:8px;margin-bottom:15px;}
        .user-role-badge{padding:4px 12px;border-radius:20px;font-size:12px;font-weight:600;}
        .role-admin{background:#17a2b8;color:white;}
        .role-user{background:#6c757d;color:white;}

        .users-section{background:#f8f9fa;padding:20px;border-radius:12px;margin-bottom:20px;}
        .user-row{display:flex;align-items:center;justify-content:space-between;padding:12px;background:white;margin-bottom:8px;border-radius:8px;box-shadow:0 2px 4px rgba(0,0,0,0.05);}
        .user-actions{display:flex;gap:5px;flex-wrap:wrap;}
        .edit-modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:none;align-items:center;justify-content:center;z-index:3000;}
        .modal-content{background:white;padding:30px;border-radius:12px;width:90%;max-width:500px;max-height:90vh;overflow-y:auto;}

        /* Import Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 3000;
        }
        
        .modal-box {
            background: white;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-close {
            cursor: pointer;
            font-size: 24px;
            color: #666;
        }
        
        .import-preview {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 6px;
            margin: 15px 0;
            padding: 10px;
            background: #f9f9f9;
        }
        
        .preview-table {
            width: 100%;
            font-size: 11px;
            border-collapse: collapse;
        }
        
        .preview-table th,
        .preview-table td {
            border: 1px solid #ddd;
            padding: 4px;
            text-align: left;
            white-space: nowrap;
        }
        
        .preview-table th {
            background: #f1f3f5;
            font-weight: bold;
        }
        
        .file-upload-area {
            border: 2px dashed #667eea;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            margin: 15px 0;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .file-upload-area:hover {
            background: #f0f4ff;
        }
        
        .file-upload-icon {
            font-size: 48px;
            color: #667eea;
            margin-bottom: 10px;
        }
        
        .file-upload-text {
            color: #666;
            font-size: 14px;
            margin-bottom: 5px;
        }
        
        .file-name {
            font-size: 12px;
            color: #28a745;
            margin-top: 10px;
        }
        
        .import-options {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
        
        .option-item {
            display: flex;
            align-items: center;
            margin: 10px 0;
        }
        
        .option-item input {
            width: auto;
            margin-right: 10px;
        }
        
        .option-label {
            font-size: 14px;
        }
        
        .import-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin: 15px 0;
        }
        
        .stat-item {
            background: #e9ecef;
            padding: 10px;
            border-radius: 6px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 18px;
            font-weight: bold;
            color: #667eea;
        }
        
        .stat-label {
            font-size: 10px;
            color: #666;
            line-height: 1.2;
        }
        
        .step-content {
            display: none;
        }
        
        .active-step {
            display: block;
        }
        
        /* Style untuk hide/show berdasarkan role */
        .admin-controls {
            display: none;
        }
        
        .admin-only-controls {
            display: none;
        }
        
        .user-view {
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .user-view h3 {
            color: #495057;
            margin-bottom: 15px;
            font-size: 16px;
        }
        
        .user-view-message {
            text-align: center;
            padding: 30px;
            color: #666;
            font-style: italic;
        }
        
        /* Export options */
        .export-options {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .export-btn-group {
            display: flex;
            gap: 5px;
        }
        
        .export-btn {
            padding: 8px 15px;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        @media(max-width:768px){
            .nav-links{justify-content:flex-start;padding-bottom:5px;}
            .btn{width:100% !important;}
            .user-row{flex-direction:column;gap:10px;text-align:center;}
            .user-actions{justify-content:center;}
            .import-stats{grid-template-columns:repeat(2,1fr);}
            .export-options{flex-direction:column;}
            .export-btn-group{flex-wrap:wrap;}
        }
    </style>
    
    <!-- SheetJS untuk Excel support -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <!-- jsPDF untuk export PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
</head>
<body>
    <!-- üî• FIREBASE SDK (CDN) -->
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

    <!-- IMPORT MODAL -->
    <div id="importModal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header">
                <h3>üìÅ Import Data Anggota</h3>
                <div class="modal-close" onclick="closeImportModal()">√ó</div>
            </div>
            
            <div class="import-steps">
                <!-- Step 1: Upload File -->
                <div id="step1" class="step-content active-step">
                    <p style="margin-bottom: 15px; color: #666; font-size: 14px;">
                        Upload file Excel (.xlsx, .xls) atau CSV dengan format berikut:
                    </p>
                    
                    <div style="background: #f1f3f5; padding: 10px; border-radius: 6px; margin-bottom: 15px; font-size: 12px;">
                        <div><strong>Format Excel/CSV yang didukung:</strong></div>
                        <div>Kolom: <code>NO, NAMA KEPALA KELUARGA, TANGGAL LAHIR, ALAMAT, JUMLAH ANAK, NAMA ANAK, TANGGAL LAHIR ANAK, PENDIDIKAN ANAK, ANGGOTA DEWASA</code></div>
                        <div><small>Atau format lain dengan kolom yang sesuai (nama bisa berbeda)</small></div>
                    </div>
                    
                    <div class="file-upload-area" onclick="document.getElementById('fileInput').click()" id="dropArea">
                        <div class="file-upload-icon">üìÇ</div>
                        <div class="file-upload-text">Klik untuk memilih file atau drop file di sini</div>
                        <div class="file-upload-text">Format: .xlsx, .xls, .csv</div>
                        <div id="selectedFileName" class="file-name"></div>
                    </div>
                    <input type="file" id="fileInput" accept=".csv,.xlsx,.xls,.xlsm,.xlsb,.ods" style="display: none;" onchange="handleFileSelect(event)">
                    
                    <div class="import-options">
                        <div class="option-item">
                            <input type="checkbox" id="overwriteData" checked>
                            <label for="overwriteData" class="option-label">Timpa data yang sudah ada</label>
                        </div>
                        <div class="option-item">
                            <input type="checkbox" id="skipDuplicates" checked>
                            <label for="skipDuplicates" class="option-label">Lewati data duplikat</label>
                        </div>
                        <div class="option-item">
                            <input type="checkbox" id="autoMapColumns" checked>
                            <label for="autoMapColumns" class="option-label">Otomatis mapping kolom</label>
                        </div>
                    </div>
                    
                    <!-- Column Mapping (akan muncul jika autoMapColumns tidak dicentang) -->
                    <div id="columnMappingSection" style="display: none; margin-top: 15px;">
                        <h4 style="margin-bottom: 10px; font-size: 14px;">Mapping Kolom Excel ke Database:</h4>
                        <div id="columnMappingGrid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 12px;"></div>
                    </div>
                </div>
                
                <!-- Step 2: Preview Data -->
                <div id="step2" class="step-content">
                    <h4>üîç Preview Data (10 baris pertama)</h4>
                    <div class="import-preview">
                        <table class="preview-table" id="previewTable">
                            <thead id="previewHeader"></thead>
                            <tbody id="previewBody"></tbody>
                        </table>
                    </div>
                    
                    <div class="import-stats" id="importStats">
                        <div class="stat-item">
                            <div class="stat-value" id="totalRows">0</div>
                            <div class="stat-label">Total Baris</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="validRows">0</div>
                            <div class="stat-label">Valid</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="duplicateRows">0</div>
                            <div class="stat-label">Duplikat</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="errorRows">0</div>
                            <div class="stat-label">Error</div>
                        </div>
                    </div>
                </div>
                
                <!-- Step 3: Import Progress -->
                <div id="step3" class="step-content">
                    <h4>‚è≥ Sedang Mengimport...</h4>
                    <div style="background: #f1f3f5; height: 20px; border-radius: 10px; margin: 20px 0;">
                        <div id="progressBar" style="background: #28a745; height: 100%; width: 0%; border-radius: 10px; transition: width 0.3s;"></div>
                    </div>
                    <div style="text-align: center;">
                        <div id="progressText" style="font-size: 14px; margin-bottom: 10px;">Menyiapkan...</div>
                        <div id="progressDetails" style="font-size: 12px; color: #666;"></div>
                    </div>
                </div>
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button id="prevBtn" onclick="prevStep()" class="btn btn-warning" style="flex: 1; display: none;">‚¨Ö Kembali</button>
                <button id="nextBtn" onclick="nextStep()" class="btn btn-primary" style="flex: 1;">Selanjutnya ‚Üí</button>
                <button id="importBtn" onclick="startImport()" class="btn btn-success" style="flex: 1; display: none;">üöÄ Import Data</button>
                <button id="closeBtn" onclick="closeImportModal()" class="btn btn-danger" style="flex: 1; display: none;">Tutup</button>
            </div>
        </div>
    </div>

    <!-- EDIT MEMBER MODAL -->
    <div id="editMemberModal" class="edit-modal">
        <div class="modal-content">
            <h3>‚úèÔ∏è Edit Anggota</h3>
            <input type="hidden" id="editMemberId">
            <div class="form-grid">
                <input type="text" id="editNama" placeholder="Nama Lengkap *">
                <input type="text" id="editAlamat" placeholder="Alamat *">
                <input type="text" id="editNoHp" placeholder="No. HP">
                <input type="text" id="editJabatan" placeholder="Jabatan">
                <select id="editStatus">
                    <option value="aktif">Aktif</option>
                    <option value="nonaktif">Nonaktif</option>
                </select>
                <div style="display:flex;gap:10px;">
                    <button onclick="saveMemberEdit()" class="btn btn-primary" style="flex:1;">üíæ Simpan</button>
                    <button onclick="closeEditModal()" class="btn btn-danger" style="flex:1;">‚ùå Batal</button>
                </div>
            </div>
        </div>
    </div>

    <!-- EDIT USER MODAL -->
    <div id="editUserModal" class="edit-modal">
        <div class="modal-content">
            <h3>‚úèÔ∏è Edit Pengguna</h3>
            <input type="hidden" id="editUserId">
            <div class="form-grid" style="grid-template-columns:1fr;">
                <input type="text" id="editUsername" placeholder="Username *">
                <input type="password" id="editPassword" placeholder="Password Baru (kosongkan jika tidak diubah)">
                <select id="editRole">
                    <option value="user">User Biasa</option>
                    <option value="admin">Administrator</option>
                </select>
                <div style="display:flex;gap:10px;">
                    <button onclick="saveUserEdit()" class="btn btn-primary" style="flex:1;">üíæ Simpan</button>
                    <button onclick="closeEditModal()" class="btn btn-danger" style="flex:1;">‚ùå Batal</button>
                </div>
            </div>
        </div>
    </div>

    <div id="loginOverlay" class="login-overlay">
        <div class="login-box">
            <h2 style="color:#667eea;margin-bottom:10px;">üèõÔ∏è Sistem Manajemen</h2>
            <p style="color:#666;margin-bottom:30px;font-size:14px;">Girsang Boru Panagolan Tangerang</p>
            <input type="text" id="username" placeholder="Username" style="margin-bottom:10px;">
            <input type="password" id="password" placeholder="Password" style="margin-bottom:20px;">
            <button onclick="login()" class="btn btn-primary">Masuk</button>
            <p style="margin-top:20px;font-size:12px;color:#aaa;">
                Admin: <strong>admin</strong> / <strong>admin123</strong><br>
                User: <strong>user1</strong> / <strong>user123</strong>
            </p>
        </div>
    </div>

    <div class="header" id="header" style="display:none;">
        <div class="status-indicator" id="statusIndicator">
            <div class="status-dot" id="statusDot"></div>
            <span id="statusText">Memuat...</span>
        </div>
        <h1>üèõÔ∏è Girsang Boru Panagolan</h1>
        <p id="headerSubtitle">Dashboard Manajemen & Keuangan - Offline + Auto Sync ‚úÖ</p>
        <div class="close-btn-logout" onclick="logout()" title="Keluar">‚èª</div>
    </div>

    <nav class="navbar" id="navbar" style="display:none;">
        <div class="nav-links">
            <a onclick="showSection('dashboard', this)" class="active">üìä Dashboard</a>
            <a onclick="showSection('members', this)">üë• Anggota</a>
            <a onclick="showSection('attendance', this)">üìã Absensi</a>
            <a onclick="showSection('finance', this)">üí∞ Keuangan</a>
            <a id="usersNav" class="nav-users" onclick="showSection('users', this)">üë®‚Äçüíº Pengguna</a>
        </div>
    </nav>

    <div class="container" id="mainContainer" style="display:none;">
        <!-- User Info Bar -->
        <div id="userInfoBar" class="user-info" style="display:none;">
            <span>üë§ <strong id="currentUsername"></strong></span>
            <span class="user-role-badge" id="currentRole"></span>
        </div>

        <!-- ‚úÖ FIREBASE CONFIG - ADMIN ONLY NOW -->
        <div id="configStatus" class="config-status admin-only">
            <h3>‚úÖ Firebase Terhubung!</h3>
            <p><strong>Project:</strong> girsangborupanagolantangerang<br>
            <strong>Database:</strong> Realtime Database (asia-southeast1)<br>
            <small>Status: Offline-first + Auto Sync Multi-Device</small></p>
        </div>

        <!-- USER MANAGEMENT SECTION (ADMIN ONLY) -->
        <section class="section" id="users">
            <div class="section-header admin-only"><h2>üë®‚Äçüíº Manajemen Pengguna</h2></div>
            <div class="section-content">
                <div class="users-section">
                    <h3>Tambah Pengguna Baru</h3>
                    <div class="form-grid">
                        <input type="text" id="newUsername" placeholder="Username *">
                        <input type="password" id="newPassword" placeholder="Password *">
                        <select id="newRole">
                            <option value="user">User Biasa</option>
                            <option value="admin">Administrator</option>
                        </select>
                        <button onclick="addUser()" class="btn btn-success">‚ûï Tambah User</button>
                    </div>
                </div>
                <h3>Daftar Pengguna</h3>
                <div id="usersList"></div>
            </div>
        </section>

        <section class="section active" id="dashboard">
            <div class="section-header"><h2>üìä Ringkasan Data</h2></div>
            <div class="section-content">
                <div class="stats">
                    <div class="stat-card">
                        <div class="stat-number" id="activeMembers">0</div>
                        <div class="stat-label">Anggota Aktif</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="todayAttendance">0</div>
                        <div class="stat-label">Hadir Hari Ini</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="saldoKas">Rp 0</div>
                        <div class="stat-label">Saldo Kas</div>
                    </div>
                </div>
                <div id="syncStatus" class="sync-status" style="display:none;"></div>
                <button id="manualSyncBtn" onclick="manualSync()" class="btn btn-sync" style="max-width:200px;">üîÑ Sinkron Manual</button>
            </div>
        </section>

        <section class="section" id="members">
            <div class="section-header admin-only"><h2>üë• Data Anggota</h2></div>
            <div class="section-content">
                <!-- EXPORT OPTIONS - HANYA UNTUK ADMIN -->
                <div id="importButtons" class="admin-controls" style="display: flex; flex-direction: column; gap: 15px; margin-bottom: 20px;">
                    <div class="export-options">
                        <div style="flex: 1;">
                            <h4 style="margin-bottom: 10px; font-size: 14px;">üìÅ Import Data</h4>
                            <button onclick="openImportModal()" class="btn btn-success" style="width: auto;">üìÅ Import Excel/CSV</button>
                        </div>
                        <div style="flex: 1;">
                            <h4 style="margin-bottom: 10px; font-size: 14px;">üì§ Export Data</h4>
                            <div class="export-btn-group">
                                <button onclick="downloadTemplate()" class="btn btn-warning export-btn">üì• Template</button>
                                <button onclick="exportToCSV()" class="btn btn-primary export-btn">üìä CSV</button>
                                <button onclick="exportToExcel()" class="btn btn-success export-btn">üìà Excel</button>
                                <button onclick="exportToPDF()" class="btn btn-danger export-btn">üìÑ PDF</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Quick Stats -->
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; font-size: 12px;">
                        <div style="background: #e9ecef; padding: 10px; border-radius: 6px; text-align: center;">
                            <div style="font-size: 16px; font-weight: bold; color: #667eea;" id="totalMembersStat">0</div>
                            <div>Total Anggota</div>
                        </div>
                        <div style="background: #e9ecef; padding: 10px; border-radius: 6px; text-align: center;">
                            <div style="font-size: 16px; font-weight: bold; color: #28a745;" id="activeMembersStat">0</div>
                            <div>Aktif</div>
                        </div>
                        <div style="background: #e9ecef; padding: 10px; border-radius: 6px; text-align: center;">
                            <div style="font-size: 16px; font-weight: bold; color: #17a2b8;" id="totalChildrenStat">0</div>
                            <div>Total Anak</div>
                        </div>
                    </div>
                </div>
                
                <!-- MESSAGE UNTUK USER BIASA -->
                <div id="userViewMessage" class="user-view-message" style="display: none;">
                    <h3>üëã Selamat Datang di Data Anggota</h3>
                    <p>Anda login sebagai <strong>User Biasa</strong>. Fitur ini hanya dapat diakses oleh Administrator.</p>
                    <p>Silakan hubungi Administrator jika Anda memerlukan akses untuk mengelola data anggota.</p>
                </div>
                
                <!-- FORM TAMBAH ANGGOTA - FIELDS LENGKAP (HANYA ADMIN) -->
                <div id="memberFormContainer" class="admin-controls">
                    <div class="form-grid">
                        <input type="text" id="no_kep" placeholder="No Kep. Keluarga">
                        <input type="text" id="tgl_lahir" placeholder="Tgl Lahir (YYYY-MM-DD)">
                        <input type="text" id="nama" placeholder="Nama Lengkap *">
                        <input type="text" id="alamat" placeholder="Alamat *">
                        <input type="text" id="no_hp" placeholder="No. HP">
                        <input type="text" id="jabatan" placeholder="Jabatan">
                        <input type="number" id="jumlah_anak" placeholder="Jumlah Anak" min="0" style="grid-column: span 2;">
                        <textarea id="nama_anak" placeholder="Nama Anak (pisahkan dengan koma)" rows="2" style="grid-column: span 2;"></textarea>
                        <input type="text" id="tgl_lahir_anak" placeholder="Tgl Lahir Anak (YYYY-MM-DD)">
                        <input type="text" id="pendidikan_anak" placeholder="Pendidikan Anak">
                        <input type="number" id="anggota_dewasa" placeholder="Anggota Dewasa" min="0">
                        <button onclick="addMember()" class="btn btn-primary">‚ûï Tambah</button>
                    </div>
                </div>
                
                <!-- TABEL DATA ANGGOTA (TAMPIL UNTUK SEMUA) -->
                <h3 style="margin:20px 0 10px;font-size:16px;">Daftar Anggota <span style="font-size: 12px; color: #666;">(Total: <span id="membersCount">0</span> anggota)</span></h3>
                <div class="table-responsive">
                    <table id="membersTable">
                        <thead>
                            <tr>
                                <th>No Kep</th>
                                <th>Nama</th>
                                <th>Tgl Lahir</th>
                                <th>Alamat</th>
                                <th>HP</th>
                                <th>Jabatan</th>
                                <th>Jml Anak</th>
                                <th>Nama Anak</th>
                                <th>Status</th>
                                <th id="actionColumnHeader">Aksi</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </section>

        <section class="section" id="attendance">
            <div class="section-header admin-only"><h2>üìã Input Absensi</h2></div>
            <div class="section-content">
                <!-- FORM ABSENSI - HANYA UNTUK ADMIN -->
                <div id="attendanceFormContainer" class="admin-controls">
                    <div class="form-grid">
                        <select id="member_id_att"><option value="">-- Pilih Anggota --</option></select>
                        <input type="date" id="tanggal_att">
                        <select id="status_hadir">
                            <option value="hadir">Hadir</option>
                            <option value="sakit">Sakit</option>
                            <option value="izin">Izin</option>
                        </select>
                        <button onclick="addAttendance()" class="btn btn-primary">‚úÖ Simpan</button>
                    </div>
                </div>
                
                <!-- MESSAGE UNTUK USER BIASA -->
                <div id="attendanceUserMessage" class="user-view-message" style="display: none; margin-bottom: 20px;">
                    <h3>üìã Data Absensi</h3>
                    <p>Anda login sebagai <strong>User Biasa</strong>. Fitur input absensi hanya dapat diakses oleh Administrator.</p>
                    <p>Berikut adalah riwayat absensi yang tersedia:</p>
                </div>
                
                <h3 style="margin:20px 0 10px;font-size:16px;">Riwayat Absensi</h3>
                <div class="table-responsive">
                    <table id="attendanceTable">
                        <thead><tr><th>Tanggal</th><th>Nama</th><th>Status</th><th>Waktu</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </section>

        <section class="section" id="finance">
            <div class="section-header admin-only"><h2>üí∞ Kas & Keuangan</h2></div>
            <div class="section-content">
                <!-- FORM KEUANGAN - HANYA UNTUK ADMIN -->
                <div id="financeFormContainer" class="admin-controls">
                    <div class="form-grid">
                        <input type="text" id="deskripsi_fin" placeholder="Keterangan Transaksi *">
                        <input type="number" id="jumlah_fin" placeholder="Nominal (Rp) *">
                        <select id="jenis_fin">
                            <option value="pemasukan">‚ûï Pemasukan</option>
                            <option value="pengeluaran">‚ûñ Pengeluaran</option>
                        </select>
                        <input type="date" id="tanggal_fin">
                        <button onclick="addFinance()" class="btn btn-primary">üí∏ Simpan Transaksi</button>
                    </div>
                </div>
                
                <!-- MESSAGE UNTUK USER BIASA -->
                <div id="financeUserMessage" class="user-view-message" style="display: none; margin-bottom: 20px;">
                    <h3>üí∞ Data Keuangan</h3>
                    <p>Anda login sebagai <strong>User Biasa</strong>. Fitur input keuangan hanya dapat diakses oleh Administrator.</p>
                    <p>Berikut adalah riwayat transaksi yang tersedia:</p>
                </div>
                
                <h3 style="margin:20px 0 10px;font-size:16px;">Riwayat Transaksi</h3>
                <div class="table-responsive">
                    <table id="financeTable">
                        <thead><tr><th>Tanggal</th><th>Keterangan</th><th>Jenis</th><th>Jumlah</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </section>
    </div>

    <script>
        // üî• FIREBASE CONFIG - SUDAH TERINSTAL
        const firebaseConfig = {
            apiKey: "AIzaSyCqF5VG2T03yaHOAq8dPhtvgMYrbVq-DIs",
            authDomain: "girsangborupanagolantangerang.firebaseapp.com",
            databaseURL: "https://girsangborupanagolantangerang-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "girsangborupanagolantangerang",
            storageBucket: "girsangborupanagolantangerang.firebasestorage.app",
            messagingSenderId: "823404152768",
            appId: "1:823404152768:web:c743fa07b22455452b2a25",
            measurementId: "G-716P2TK99Y"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // --- GLOBAL STATE ---
        let currentUser = {username: '', role: 'user'};
        let connectionStatus = 'offline';
        let syncQueue = [], isSyncing = false;
        let members = [], attendance = [], finance = [], users = [];
        let appInitialized = false;
        
        // Import state
        let currentStep = 1;
        let importData = [];
        let importFile = null;
        let excelHeaders = [];
        let columnMapping = {};
        let importStats = {
            total: 0,
            valid: 0,
            duplicate: 0,
            imported: 0,
            errors: 0
        };

        // Default users
        const defaultUsers = {
            admin: {username: 'admin', password: 'admin123', role: 'admin'},
            user1: {username: 'user1', password: 'user123', role: 'user'}
        };

        // Database field mapping
        const dbFields = {
            'no': 'no_kep',
            'nomor': 'no_kep',
            'no kep': 'no_kep',
            'no keluarga': 'no_kep',
            'nama': 'nama',
            'nama kepala keluarga': 'nama',
            'nama lengkap': 'nama',
            'tanggal lahir': 'tgl_lahir',
            'tgl lahir': 'tgl_lahir',
            'lahir': 'tgl_lahir',
            'alamat': 'alamat',
            'no hp': 'no_hp',
            'telepon': 'no_hp',
            'hp': 'no_hp',
            'jabatan': 'jabatan',
            'posisi': 'jabatan',
            'jumlah anak': 'jumlah_anak',
            'jml anak': 'jumlah_anak',
            'nama anak': 'nama_anak',
            'anak': 'nama_anak',
            'tanggal lahir anak': 'tgl_lahir_anak',
            'tgl lahir anak': 'tgl_lahir_anak',
            'pendidikan anak': 'pendidikan_anak',
            'pendidikan': 'pendidikan_anak',
            'anggota dewasa': 'anggota_dewasa',
            'jml dewasa': 'anggota_dewasa',
            'dewasa': 'anggota_dewasa'
        };

        // --- CONNECTION MONITOR (ADMIN ONLY) ---
        db.ref('.info/connected').on('value', (snap) => {
            if (snap.val() === true && connectionStatus !== 'online') {
                connectionStatus = 'online';
                if(currentUser.role === 'admin') {
                    updateStatus('üü¢ Online & Sinkron', '#28a745');
                    if(appInitialized) processSyncQueue();
                }
            } else if (snap.val() === false && connectionStatus !== 'offline') {
                connectionStatus = 'offline';
                if(currentUser.role === 'admin') updateStatus('üî¥ Offline (Lokal OK)', '#dc3545');
            }
        });

        function updateStatus(text, color) {
            if(currentUser.role === 'admin') {
                document.getElementById('statusText').textContent = text;
                document.getElementById('statusDot').style.background = color;
                document.getElementById('statusDot').className = color === '#ffc107' ? 'status-dot status-syncing' : 'status-dot';
            }
        }

        // --- AUTH SYSTEM ---
        function login() {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;

            // Check users array first, then defaults
            const user = users.find(u => u.username === username && u.password === password) || 
                        (defaultUsers[username] && defaultUsers[username].password === password ? defaultUsers[username] : null);

            if (user) {
                currentUser = user;
                localStorage.setItem('gbp_currentUser', JSON.stringify(currentUser));
                initApp();
            } else {
                alert('‚ùå Login Gagal! Cek username/password\nAdmin: admin/admin123\nUser: user1/user123');
            }
        }

        function logout() {
            if(confirm('Keluar dari sistem?')) {
                localStorage.clear();
                currentUser = {username: '', role: 'user'};
                location.reload();
            }
        }

        // --- APP INIT ---
        async function initApp() {
            document.getElementById('loginOverlay').style.display = 'none';
            document.getElementById('header').style.display = 'block';
            document.getElementById('navbar').style.display = 'block';
            document.getElementById('mainContainer').style.display = 'block';

            updateUserUI();

            const today = new Date().toISOString().split('T')[0];
            document.getElementById('tanggal_att').value = today;
            document.getElementById('tanggal_fin').value = today;

            await loadAllData();
            appInitialized = true;
        }

        function updateUserUI() {
            document.getElementById('currentUsername').textContent = currentUser.username;
            const roleBadge = document.getElementById('currentRole');
            roleBadge.textContent = currentUser.role.toUpperCase();
            roleBadge.className = `user-role-badge role-${currentUser.role}`;
            document.getElementById('userInfoBar').style.display = 'flex';

            document.getElementById('headerSubtitle').textContent = currentUser.role === 'admin' ? 
                'Dashboard Admin - Full Access + Sync' : 'Dashboard User - Read Only';

            // Show/hide admin features
            const adminNav = document.getElementById('usersNav');
            const adminElements = document.querySelectorAll('.admin-only');
            const configStatus = document.getElementById('configStatus');
            
            if(currentUser.role === 'admin') {
                // Show admin features
                adminNav.style.display = 'inline-block';
                adminElements.forEach(el => el.style.display = 'block');
                if(configStatus) configStatus.style.display = 'block';
                document.getElementById('statusIndicator').style.display = 'flex';
                updateStatus('üü¢ Siap!', '#28a745');
                
                // Show admin controls in members section
                document.getElementById('importButtons').style.display = 'flex';
                document.getElementById('memberFormContainer').style.display = 'block';
                document.getElementById('userViewMessage').style.display = 'none';
                document.getElementById('actionColumnHeader').style.display = 'table-cell';
                
                // Show admin controls in attendance section
                document.getElementById('attendanceFormContainer').style.display = 'block';
                document.getElementById('attendanceUserMessage').style.display = 'none';
                
                // Show admin controls in finance section
                document.getElementById('financeFormContainer').style.display = 'block';
                document.getElementById('financeUserMessage').style.display = 'none';
                
            } else {
                // Hide admin features
                adminNav.style.display = 'none';
                adminElements.forEach(el => el.style.display = 'none');
                if(configStatus) configStatus.style.display = 'none';
                document.getElementById('statusIndicator').style.display = 'none';
                
                // Hide admin controls in members section
                document.getElementById('importButtons').style.display = 'none';
                document.getElementById('memberFormContainer').style.display = 'none';
                document.getElementById('userViewMessage').style.display = 'block';
                document.getElementById('actionColumnHeader').style.display = 'none';
                
                // Hide admin controls in attendance section
                document.getElementById('attendanceFormContainer').style.display = 'none';
                document.getElementById('attendanceUserMessage').style.display = 'block';
                
                // Hide admin controls in finance section
                document.getElementById('financeFormContainer').style.display = 'none';
                document.getElementById('financeUserMessage').style.display = 'block';
            }
        }

        // --- ENHANCED IMPORT DATA FUNCTIONS WITH EXCEL SUPPORT ---
        function openImportModal() {
            if(currentUser.role !== 'admin') return alert('‚ùå Hanya admin yang bisa import data!');
            document.getElementById('importModal').style.display = 'flex';
            resetImportModal();
        }

        function closeImportModal() {
            document.getElementById('importModal').style.display = 'none';
            resetImportModal();
        }

        function resetImportModal() {
            currentStep = 1;
            importData = [];
            importFile = null;
            excelHeaders = [];
            columnMapping = {};
            importStats = { total: 0, valid: 0, duplicate: 0, imported: 0, errors: 0 };
            
            // Show step 1, hide others
            document.getElementById('step1').style.display = 'block';
            document.getElementById('step2').style.display = 'none';
            document.getElementById('step3').style.display = 'none';
            
            // Reset button visibility
            document.getElementById('prevBtn').style.display = 'none';
            document.getElementById('nextBtn').style.display = 'inline-block';
            document.getElementById('importBtn').style.display = 'none';
            document.getElementById('closeBtn').style.display = 'none';
            
            // Clear file info
            document.getElementById('selectedFileName').textContent = '';
            document.getElementById('previewHeader').innerHTML = '';
            document.getElementById('previewBody').innerHTML = '';
            document.getElementById('progressBar').style.width = '0%';
            document.getElementById('progressText').textContent = 'Menyiapkan...';
            document.getElementById('progressDetails').textContent = '';
            document.getElementById('columnMappingSection').style.display = 'none';
            
            // Reset stats
            document.getElementById('totalRows').textContent = '0';
            document.getElementById('validRows').textContent = '0';
            document.getElementById('duplicateRows').textContent = '0';
            document.getElementById('errorRows').textContent = '0';
        }

        function nextStep() {
            if (currentStep === 1) {
                if (!importFile) {
                    alert('‚ùå Silakan pilih file terlebih dahulu!');
                    return;
                }
                
                // Parse file
                parseImportFile();
            }
        }

        function prevStep() {
            if (currentStep === 2) {
                document.getElementById('step2').style.display = 'none';
                document.getElementById('step1').style.display = 'block';
                document.getElementById('prevBtn').style.display = 'none';
                document.getElementById('nextBtn').style.display = 'inline-block';
                document.getElementById('importBtn').style.display = 'none';
                currentStep = 1;
            } else if (currentStep === 3) {
                document.getElementById('step3').style.display = 'none';
                document.getElementById('step2').style.display = 'block';
                document.getElementById('prevBtn').style.display = 'inline-block';
                document.getElementById('importBtn').style.display = 'inline-block';
                document.getElementById('closeBtn').style.display = 'none';
                currentStep = 2;
            }
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const validTypes = ['text/csv', 'application/vnd.ms-excel', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', 'application/vnd.oasis.opendocument.spreadsheet'];
            const fileExt = file.name.split('.').pop().toLowerCase();
            const validExts = ['csv', 'xlsx', 'xls', 'xlsm', 'xlsb', 'ods'];
            
            if (!validTypes.includes(file.type) && !validExts.includes(fileExt)) {
                alert('‚ùå Format file tidak didukung! Gunakan Excel (.xlsx, .xls) atau CSV.');
                return;
            }
            
            importFile = file;
            document.getElementById('selectedFileName').textContent = file.name + ' (' + formatFileSize(file.size) + ')';
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function parseImportFile() {
            if (!importFile) return;
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const data = e.target.result;
                    let workbook, worksheet;
                    
                    // Handle CSV files
                    if (importFile.name.toLowerCase().endsWith('.csv')) {
                        const lines = data.split('\n').filter(line => line.trim() !== '');
                        if (lines.length < 2) {
                            alert('‚ùå File tidak memiliki data atau format tidak sesuai!');
                            return;
                        }
                        
                        excelHeaders = lines[0].split(',').map(h => h.trim().toLowerCase());
                        importData = [];
                        
                        for (let i = 1; i < lines.length; i++) {
                            const rowData = lines[i].split(',').map(cell => cell.trim());
                            if (rowData.length === excelHeaders.length) {
                                const rowObj = {};
                                excelHeaders.forEach((header, index) => {
                                    rowObj[header] = rowData[index] || '';
                                });
                                importData.push(rowObj);
                            }
                        }
                    } else {
                        // Handle Excel files using SheetJS
                        workbook = XLSX.read(data, { type: 'binary' });
                        
                        // Get first sheet
                        const firstSheetName = workbook.SheetNames[0];
                        worksheet = workbook.Sheets[firstSheetName];
                        
                        // Convert to JSON
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                        
                        if (jsonData.length < 2) {
                            alert('‚ùå File tidak memiliki data atau format tidak sesuai!');
                            return;
                        }
                        
                        excelHeaders = jsonData[0].map(h => String(h).trim().toLowerCase());
                        importData = [];
                        
                        for (let i = 1; i < jsonData.length; i++) {
                            const rowData = jsonData[i];
                            if (rowData && rowData.length > 0) {
                                const rowObj = {};
                                excelHeaders.forEach((header, index) => {
                                    rowObj[header] = rowData[index] !== undefined ? String(rowData[index]).trim() : '';
                                });
                                importData.push(rowObj);
                            }
                        }
                    }
                    
                    if (importData.length === 0) {
                        alert('‚ùå Tidak ada data yang valid ditemukan dalam file!');
                        return;
                    }
                    
                    // Auto-map columns
                    autoMapColumns();
                    
                    // Show column mapping if auto-map is disabled
                    const autoMap = document.getElementById('autoMapColumns').checked;
                    if (!autoMap) {
                        showColumnMapping();
                    }
                    
                    // Validate data and show preview
                    validateImportData();
                    showDataPreview();
                    
                    // Update stats
                    document.getElementById('totalRows').textContent = importStats.total;
                    document.getElementById('validRows').textContent = importStats.valid;
                    document.getElementById('duplicateRows').textContent = importStats.duplicate;
                    document.getElementById('errorRows').textContent = importStats.errors;
                    
                    // Move to step 2
                    document.getElementById('step1').style.display = 'none';
                    document.getElementById('step2').style.display = 'block';
                    document.getElementById('prevBtn').style.display = 'inline-block';
                    document.getElementById('nextBtn').style.display = 'none';
                    document.getElementById('importBtn').style.display = 'inline-block';
                    currentStep = 2;
                    
                } catch (error) {
                    console.error('Error parsing file:', error);
                    alert('‚ùå Gagal memproses file! Pastikan format file benar.');
                }
            };
            
            if (importFile.name.toLowerCase().endsWith('.csv')) {
                reader.readAsText(importFile);
            } else {
                reader.readAsBinaryString(importFile);
            }
        }

        function autoMapColumns() {
            columnMapping = {};
            
            excelHeaders.forEach(excelHeader => {
                // Find best matching database field
                let bestMatch = null;
                let bestScore = 0;
                
                for (const [dbField, dbFieldName] of Object.entries(dbFields)) {
                    const similarity = calculateSimilarity(excelHeader, dbField);
                    if (similarity > bestScore && similarity > 0.6) {
                        bestScore = similarity;
                        bestMatch = dbFieldName;
                    }
                }
                
                if (bestMatch) {
                    columnMapping[excelHeader] = bestMatch;
                } else {
                    // If no match found, map to itself
                    columnMapping[excelHeader] = excelHeader;
                }
            });
        }

        function calculateSimilarity(str1, str2) {
            // Simple similarity calculation
            const s1 = str1.toLowerCase();
            const s2 = str2.toLowerCase();
            
            if (s1 === s2) return 1.0;
            if (s1.includes(s2) || s2.includes(s1)) return 0.8;
            
            return 0;
        }

        function showColumnMapping() {
            const mappingSection = document.getElementById('columnMappingSection');
            const mappingGrid = document.getElementById('columnMappingGrid');
            
            mappingSection.style.display = 'block';
            mappingGrid.innerHTML = '';
            
            excelHeaders.forEach(header => {
                const mappingDiv = document.createElement('div');
                mappingDiv.innerHTML = `
                    <div style="font-weight: bold; margin-bottom: 3px;">${header}</div>
                    <select style="width: 100%; padding: 5px; font-size: 12px;" 
                            onchange="updateColumnMapping('${header}', this.value)">
                        <option value="">-- Pilih Kolom Database --</option>
                        ${Object.entries(dbFields).map(([key, value]) => 
                            `<option value="${value}" ${columnMapping[header] === value ? 'selected' : ''}>
                                ${key} ‚Üí ${value}
                            </option>`
                        ).join('')}
                        <option value="custom" ${!Object.values(dbFields).includes(columnMapping[header]) ? 'selected' : ''}>Custom/Kosong</option>
                    </select>
                `;
                mappingGrid.appendChild(mappingDiv);
            });
        }

        function updateColumnMapping(excelHeader, dbField) {
            columnMapping[excelHeader] = dbField;
        }

        function validateImportData() {
            importStats.total = importData.length;
            importStats.valid = 0;
            importStats.duplicate = 0;
            importStats.errors = 0;
            
            const autoMap = document.getElementById('autoMapColumns').checked;
            
            importData.forEach(row => {
                row.isValid = false;
                row.isDuplicate = false;
                row.mappedData = {};
                
                try {
                    // Map data based on column mapping
                    Object.keys(columnMapping).forEach(excelHeader => {
                        const dbField = columnMapping[excelHeader];
                        if (dbField && dbField !== 'custom' && row[excelHeader] !== undefined) {
                            row.mappedData[dbField] = row[excelHeader];
                        }
                    });
                    
                    // Check for required fields
                    if (row.mappedData['nama'] && row.mappedData['alamat']) {
                        row.isValid = true;
                        
                        // Check for duplicates
                        const isDuplicate = members.some(m => 
                            m.nama?.toLowerCase() === row.mappedData['nama'].toLowerCase() && 
                            m.alamat?.toLowerCase() === row.mappedData['alamat'].toLowerCase()
                        );
                        
                        row.isDuplicate = isDuplicate;
                        if (isDuplicate) importStats.duplicate++;
                        
                        importStats.valid++;
                    } else {
                        importStats.errors++;
                    }
                } catch (error) {
                    console.error('Error validating row:', error);
                    importStats.errors++;
                }
            });
        }

        function showDataPreview() {
            const previewHeader = document.getElementById('previewHeader');
            const previewBody = document.getElementById('previewBody');
            
            // Clear previous content
            previewHeader.innerHTML = '';
            previewBody.innerHTML = '';
            
            // Create header
            const headerRow = document.createElement('tr');
            headerRow.innerHTML = '<th>#</th>';
            
            excelHeaders.forEach(header => {
                const dbField = columnMapping[header] || header;
                headerRow.innerHTML += `<th title="Excel: ${header}\nDatabase: ${dbField}">${header}<br><small>‚Üí ${dbField}</small></th>`;
            });
            
            headerRow.innerHTML += '<th>Status</th>';
            previewHeader.appendChild(headerRow);
            
            // Create preview rows (first 10)
            const previewRows = importData.slice(0, 10);
            
            previewRows.forEach((row, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${index + 1}</td>`;
                
                excelHeaders.forEach(header => {
                    const value = row[header] || '';
                    tr.innerHTML += `<td>${value}</td>`;
                });
                
                // Add status cell
                let statusText = '';
                let statusClass = '';
                
                if (!row.isValid) {
                    statusText = '‚ùå Invalid';
                    statusClass = 'background:#f8d7da;';
                } else if (row.isDuplicate) {
                    statusText = '‚ö†Ô∏è Duplikat';
                    statusClass = 'background:#fff3cd;';
                } else {
                    statusText = '‚úÖ Valid';
                    statusClass = 'background:#d4edda;';
                }
                
                tr.innerHTML += `<td style="${statusClass} font-size:10px; text-align:center;">${statusText}</td>`;
                
                if (!row.isValid) {
                    tr.style.backgroundColor = '#f8d7da';
                } else if (row.isDuplicate) {
                    tr.style.backgroundColor = '#fff3cd';
                }
                
                previewBody.appendChild(tr);
            });
        }

        async function startImport() {
            if(currentUser.role !== 'admin') return;
            
            // Move to step 3
            document.getElementById('step2').style.display = 'none';
            document.getElementById('step3').style.display = 'block';
            document.getElementById('prevBtn').style.display = 'none';
            document.getElementById('importBtn').style.display = 'none';
            document.getElementById('closeBtn').style.display = 'inline-block';
            currentStep = 3;
            
            const overwrite = document.getElementById('overwriteData').checked;
            const skipDuplicates = document.getElementById('skipDuplicates').checked;
            
            let importedCount = 0;
            const totalToImport = importData.filter(d => d.isValid && (!d.isDuplicate || !skipDuplicates)).length;
            
            for (let i = 0; i < importData.length; i++) {
                const row = importData[i];
                
                // Update progress
                const progress = Math.round((i / importData.length) * 100);
                document.getElementById('progressBar').style.width = progress + '%';
                document.getElementById('progressText').textContent = `Memproses ${i + 1} dari ${importData.length} data...`;
                document.getElementById('progressDetails').textContent = `Sedang mengimport: ${row.mappedData['nama'] || 'Data'}`;
                
                if (!row.isValid) continue;
                if (skipDuplicates && row.isDuplicate) continue;
                
                // Create member object
                const newMember = {
                    id: Date.now() + i,
                    no_kep: row.mappedData['no_kep'] || '',
                    nama: row.mappedData['nama'] || '',
                    tgl_lahir: row.mappedData['tgl_lahir'] || '',
                    alamat: row.mappedData['alamat'] || '',
                    no_hp: row.mappedData['no_hp'] || '',
                    jabatan: row.mappedData['jabatan'] || '',
                    jumlah_anak: parseInt(row.mappedData['jumlah_anak']) || 0,
                    nama_anak: row.mappedData['nama_anak'] || '',
                    tgl_lahir_anak: row.mappedData['tgl_lahir_anak'] || '',
                    pendidikan_anak: row.mappedData['pendidikan_anak'] || '',
                    anggota_dewasa: parseInt(row.mappedData['anggota_dewasa']) || 0,
                    status: 'aktif',
                    createdAt: Date.now(),
                    imported: true,
                    importDate: new Date().toISOString()
                };
                
                // Check if exists
                const existingIndex = members.findIndex(m => 
                    m.nama?.toLowerCase() === newMember.nama.toLowerCase() && 
                    m.alamat?.toLowerCase() === newMember.alamat.toLowerCase()
                );
                
                if (existingIndex >= 0) {
                    if (overwrite) {
                        members[existingIndex] = { ...members[existingIndex], ...newMember };
                    }
                } else {
                    members.unshift(newMember);
                    queueAction('addMember', newMember);
                }
                
                importedCount++;
                
                // Small delay for UI
                await new Promise(resolve => setTimeout(resolve, 50));
            }
            
            // Final update
            document.getElementById('progressBar').style.width = '100%';
            document.getElementById('progressText').textContent = '‚úÖ Import selesai!';
            document.getElementById('progressDetails').textContent = `${importedCount} data berhasil diimport dari ${importData.length} baris`;
            
            // Save to storage
            localStorage.setItem('gbp_members', JSON.stringify(members));
            
            // Update UI
            setTimeout(() => {
                renderAll();
                alert(`‚úÖ Import data selesai!\n${importedCount} data berhasil diimport dari ${importData.length} baris.`);
                closeImportModal();
            }, 1000);
        }

        // --- EXPORT FUNCTIONS ---
        function downloadTemplate() {
            // Create Excel workbook
            const wb = XLSX.utils.book_new();
            
            // Data for template
            const templateData = [
                ['NO', 'NAMA KEPALA KELUARGA', 'TANGGAL LAHIR', 'ALAMAT', 'JUMLAH ANAK', 'NAMA ANAK', 'TANGGAL LAHIR ANAK', 'PENDIDIKAN ANAK', 'ANGGOTA DEWASA'],
                ['1', 'Joko Widodo', '1961-06-21', 'Jl. Contoh No. 123', '2', 'Anak 1, Anak 2', '1990-01-01, 1992-02-02', 'S1, SMA', '3'],
                ['2', 'Budi Santoso', '1975-03-15', 'Jl. Merdeka No. 45', '1', 'Siti', '2005-08-20', 'SMP', '2'],
                ['3', 'Siti Aminah', '1980-11-30', 'Jl. Bahagia No. 78', '0', '', '', '', '1'],
                ['', '', '', '', '', '', '', '', ''],
                ['CATATAN:', '', '', '', '', '', '', '', ''],
                ['- Format tanggal: YYYY-MM-DD', '', '', '', '', '', '', '', ''],
                ['- Nama anak dipisahkan koma jika lebih dari 1', '', '', '', '', '', '', '', ''],
                ['- Tanggal lahir anak dipisahkan koma jika lebih dari 1', '', '', '', '', '', '', '', ''],
                ['- Pendidikan anak dipisahkan koma jika lebih dari 1', '', '', '', '', '', '', '', '']
            ];
            
            const ws = XLSX.utils.aoa_to_sheet(templateData);
            
            // Set column widths
            const colWidths = [
                { wch: 5 },  // NO
                { wch: 25 }, // NAMA
                { wch: 15 }, // TGL LAHIR
                { wch: 30 }, // ALAMAT
                { wch: 12 }, // JML ANAK
                { wch: 25 }, // NAMA ANAK
                { wch: 20 }, // TGL LAHIR ANAK
                { wch: 20 }, // PENDIDIKAN
                { wch: 15 }  // ANGGOTA DEWASA
            ];
            ws['!cols'] = colWidths;
            
            // Add to workbook
            XLSX.utils.book_append_sheet(wb, ws, 'Template Anggota');
            
            // Generate and download
            const date = new Date().toISOString().split('T')[0];
            XLSX.writeFile(wb, `template_data_anggota_${date}.xlsx`);
        }

        function exportToCSV() {
            if(currentUser.role !== 'admin') return alert('‚ùå Hanya admin yang bisa export data!');
            
            // Prepare data
            const headers = ['NO', 'NAMA KEPALA KELUARGA', 'TANGGAL LAHIR', 'ALAMAT', 'NO. HP', 'JABATAN', 'JUMLAH ANAK', 'NAMA ANAK', 'TANGGAL LAHIR ANAK', 'PENDIDIKAN ANAK', 'ANGGOTA DEWASA', 'STATUS'];
            
            let csvContent = headers.join(',') + '\n';
            
            members.forEach((member, index) => {
                const row = [
                    index + 1,
                    member.nama || '',
                    member.tgl_lahir || '',
                    member.alamat || '',
                    member.no_hp || '',
                    member.jabatan || '',
                    member.jumlah_anak || '0',
                    member.nama_anak || '',
                    member.tgl_lahir_anak || '',
                    member.pendidikan_anak || '',
                    member.anggota_dewasa || '0',
                    member.status || 'aktif'
                ];
                
                // Escape commas and quotes
                csvContent += row.map(cell => {
                    if (typeof cell === 'string' && (cell.includes(',') || cell.includes('"'))) {
                        return `"${cell.replace(/"/g, '""')}"`;
                    }
                    return cell;
                }).join(',') + '\n';
            });
            
            // Create download link
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            const date = new Date().toISOString().split('T')[0];
            
            link.setAttribute('href', url);
            link.setAttribute('download', `data_anggota_${date}.csv`);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function exportToExcel() {
            if(currentUser.role !== 'admin') return alert('‚ùå Hanya admin yang bisa export data!');
            
            // Create Excel workbook
            const wb = XLSX.utils.book_new();
            
            // Prepare data
            const excelData = [
                ['DATA ANGGOTA - GIRSANG BORU PANAGOLAN TANGERANG'],
                ['Tanggal Export: ' + new Date().toLocaleDateString('id-ID')],
                ['Total Anggota: ' + members.length],
                [''],
                ['NO', 'NAMA KEPALA KELUARGA', 'TANGGAL LAHIR', 'ALAMAT', 'NO. HP', 'JABATAN', 'JUMLAH ANAK', 'NAMA ANAK', 'TANGGAL LAHIR ANAK', 'PENDIDIKAN ANAK', 'ANGGOTA DEWASA', 'STATUS']
            ];
            
            // Add member data
            members.forEach((member, index) => {
                excelData.push([
                    index + 1,
                    member.nama || '',
                    member.tgl_lahir || '',
                    member.alamat || '',
                    member.no_hp || '',
                    member.jabatan || '',
                    member.jumlah_anak || '0',
                    member.nama_anak || '',
                    member.tgl_lahir_anak || '',
                    member.pendidikan_anak || '',
                    member.anggota_dewasa || '0',
                    member.status || 'aktif'
                ]);
            });
            
            // Add summary
            const activeCount = members.filter(m => m.status === 'aktif').length;
            const totalChildren = members.reduce((sum, m) => sum + (parseInt(m.jumlah_anak) || 0), 0);
            
            excelData.push(['']);
            excelData.push(['RINGKASAN:']);
            excelData.push(['Total Anggota', members.length]);
            excelData.push(['Anggota Aktif', activeCount]);
            excelData.push(['Anggota Nonaktif', members.length - activeCount]);
            excelData.push(['Total Anak', totalChildren]);
            
            const ws = XLSX.utils.aoa_to_sheet(excelData);
            
            // Set column widths
            const colWidths = [
                { wch: 5 },   // NO
                { wch: 25 },  // NAMA
                { wch: 12 },  // TGL LAHIR
                { wch: 30 },  // ALAMAT
                { wch: 15 },  // NO HP
                { wch: 15 },  // JABATAN
                { wch: 10 },  // JML ANAK
                { wch: 25 },  // NAMA ANAK
                { wch: 18 },  // TGL LAHIR ANAK
                { wch: 20 },  // PENDIDIKAN
                { wch: 15 },  // ANGGOTA DEWASA
                { wch: 10 }   // STATUS
            ];
            ws['!cols'] = colWidths;
            
            // Add to workbook
            XLSX.utils.book_append_sheet(wb, ws, 'Data Anggota');
            
            // Generate and download
            const date = new Date().toISOString().split('T')[0];
            XLSX.writeFile(wb, `data_anggota_${date}.xlsx`);
        }

        function exportToPDF() {
            if(currentUser.role !== 'admin') return alert('‚ùå Hanya admin yang bisa export data!');
            
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('landscape');
                
                // Title
                doc.setFontSize(16);
                doc.text('DATA ANGGOTA - GIRSANG BORU PANAGOLAN TANGERANG', 14, 15);
                
                // Subtitle
                doc.setFontSize(10);
                doc.text(`Tanggal Export: ${new Date().toLocaleDateString('id-ID')} | Total Anggota: ${members.length}`, 14, 22);
                
                // Prepare table data
                const tableData = members.map((member, index) => [
                    index + 1,
                    member.nama || '-',
                    member.tgl_lahir || '-',
                    member.alamat || '-',
                    member.no_hp || '-',
                    member.jabatan || 'Anggota',
                    member.jumlah_anak || '0',
                    member.nama_anak || '-',
                    member.status === 'aktif' ? 'Aktif' : 'Nonaktif'
                ]);
                
                // Table headers
                const headers = [
                    ['NO', 'NAMA', 'TGL LAHIR', 'ALAMAT', 'NO. HP', 'JABATAN', 'JML ANAK', 'NAMA ANAK', 'STATUS']
                ];
                
                // Create table
                doc.autoTable({
                    head: headers,
                    body: tableData,
                    startY: 30,
                    theme: 'grid',
                    headStyles: { fillColor: [102, 126, 234] },
                    styles: { fontSize: 8 },
                    columnStyles: {
                        0: { cellWidth: 10 },
                        1: { cellWidth: 30 },
                        2: { cellWidth: 20 },
                        3: { cellWidth: 40 },
                        4: { cellWidth: 25 },
                        5: { cellWidth: 20 },
                        6: { cellWidth: 15 },
                        7: { cellWidth: 35 },
                        8: { cellWidth: 15 }
                    }
                });
                
                // Add summary on new page if needed
                const finalY = doc.lastAutoTable.finalY || 30;
                if (finalY < 180) {
                    doc.setFontSize(10);
                    doc.text('Ringkasan:', 14, finalY + 10);
                    
                    const activeCount = members.filter(m => m.status === 'aktif').length;
                    const totalChildren = members.reduce((sum, m) => sum + (parseInt(m.jumlah_anak) || 0), 0);
                    
                    doc.text(`- Total Anggota: ${members.length}`, 20, finalY + 20);
                    doc.text(`- Anggota Aktif: ${activeCount}`, 20, finalY + 27);
                    doc.text(`- Anggota Nonaktif: ${members.length - activeCount}`, 20, finalY + 34);
                    doc.text(`- Total Anak: ${totalChildren}`, 20, finalY + 41);
                }
                
                // Save PDF
                const date = new Date().toISOString().split('T')[0];
                doc.save(`data_anggota_${date}.pdf`);
                
            } catch (error) {
                console.error('Error generating PDF:', error);
                alert('‚ùå Gagal membuat PDF! Pastikan library jsPDF tersedia.');
            }
        }

        // --- UPDATE: exportMembers function renamed for consistency ---
        function exportMembers() {
            exportToCSV(); // Default to CSV export
        }

        // --- USER MANAGEMENT (ADMIN ONLY) ---
        function addUser() {
            if(currentUser.role !== 'admin') return alert('‚ùå Hanya admin yang bisa menambah user!');

            const username = document.getElementById('newUsername').value.trim();
            const password = document.getElementById('newPassword').value;
            const role = document.getElementById('newRole').value;

            if(!username || !password) return alert('‚ùå Username dan password wajib diisi!');
            if(users.find(u => u.username === username)) return alert('‚ùå Username sudah ada!');

            const newUser = {
                id: Date.now(),
                username, password, role,
                createdAt: Date.now(),
                createdBy: currentUser.username
            };

            users.push(newUser);
            saveUsersToStorage();
            loadUsersTable();
            
            document.getElementById('newUsername').value = '';
            document.getElementById('newPassword').value = '';
            alert('‚úÖ User baru ditambahkan!');
        }

        function editUser(userId) {
            if(currentUser.role !== 'admin') return;
            const user = users.find(u => u.id === userId);
            if(!user) return;

            document.getElementById('editUserId').value = user.id;
            document.getElementById('editUsername').value = user.username;
            document.getElementById('editPassword').value = '';
            document.getElementById('editRole').value = user.role;
            document.getElementById('editUserModal').style.display = 'flex';
        }

        function saveUserEdit() {
            if(currentUser.role !== 'admin') return;
            const userId = parseInt(document.getElementById('editUserId').value);
            const username = document.getElementById('editUsername').value.trim();
            const password = document.getElementById('editPassword').value;
            const role = document.getElementById('editRole').value;

            if(!username) return alert('‚ùå Username wajib diisi!');

            const userIdx = users.findIndex(u => u.id === userId);
            if(userIdx === -1) return;

            users[userIdx].username = username;
            if(password) users[userIdx].password = password;
            users[userIdx].role = role;
            users[userIdx].updatedAt = Date.now();

            saveUsersToStorage();
            loadUsersTable();
            closeEditModal();
            alert('‚úÖ User berhasil diupdate!');
        }

        function deleteUser(userId) {
            if(currentUser.role !== 'admin') return;
            if(!confirm('Hapus user ini? Data tidak bisa dikembalikan!')) return;

            users = users.filter(u => u.id !== userId);
            saveUsersToStorage();
            loadUsersTable();
            alert('‚úÖ User dihapus!');
        }

        // --- MEMBER MANAGEMENT - EDIT MODAL FUNCTIONS ---
        function editMember(memberId) {
            if(currentUser.role !== 'admin') return;
            const member = members.find(m => m.id === memberId);
            if(!member) return;

            document.getElementById('editMemberId').value = member.id;
            document.getElementById('editNama').value = member.nama || '';
            document.getElementById('editAlamat').value = member.alamat || '';
            document.getElementById('editNoHp').value = member.no_hp || '';
            document.getElementById('editJabatan').value = member.jabatan || '';
            document.getElementById('editStatus').value = member.status || 'aktif';
            document.getElementById('editMemberModal').style.display = 'flex';
        }

        function saveMemberEdit() {
            if(currentUser.role !== 'admin') return;
            const memberId = parseInt(document.getElementById('editMemberId').value);
            const nama = document.getElementById('editNama').value.trim();
            const alamat = document.getElementById('editAlamat').value.trim();
            
            if(!nama || !alamat) return alert('‚ùå Nama dan Alamat wajib diisi!');

            const memberIdx = members.findIndex(m => m.id === memberId);
            if(memberIdx === -1) return;

            members[memberIdx] = {
                ...members[memberIdx],
                nama, alamat,
                no_hp: document.getElementById('editNoHp').value.trim(),
                jabatan: document.getElementById('editJabatan').value.trim(),
                status: document.getElementById('editStatus').value,
                updatedAt: Date.now()
            };

            queueAction('updateMember', members[memberIdx]);
            localStorage.setItem('gbp_members', JSON.stringify(members));
            renderAll();
            closeEditModal();
            alert('‚úÖ Anggota berhasil diupdate!');
        }

        function closeEditModal() {
            document.getElementById('editMemberModal').style.display = 'none';
            document.getElementById('editUserModal').style.display = 'none';
        }

        function loadUsersTable() {
            const container = document.getElementById('usersList');
            if(!container) return;
            
            container.innerHTML = users.map(user => `
                <div class="user-row">
                    <div>
                        <strong>${user.username}</strong> 
                        <span style="color:#666;font-size:12px;">(${user.role})</span>
                        ${user.createdBy ? `<br><small>Dibuat: ${new Date(user.createdAt).toLocaleDateString('id-ID')}</small>` : ''}
                        ${user.updatedAt ? `<br><small>Update: ${new Date(user.updatedAt).toLocaleDateString('id-ID')}</small>` : ''}
                    </div>
                    <div class="user-actions">
                        <button onclick="editUser(${user.id})" class="btn btn-warning btn-sm">Edit</button>
                        <button onclick="deleteUser(${user.id})" class="btn btn-danger btn-sm">Hapus</button>
                    </div>
                </div>
            `).join('');
        }

        function saveUsersToStorage() {
            localStorage.setItem('gbp_users', JSON.stringify(users));
            if(connectionStatus === 'online' && currentUser.role === 'admin') {
                db.ref('users').set(users);
            }
        }

        // --- DATA SYSTEM (ALL FEATURES MAINTAINED) ---
        async function loadAllData() {
            // Load users
            users = JSON.parse(localStorage.getItem('gbp_users')) || Object.values(defaultUsers);
            
            // Load other data
            members = JSON.parse(localStorage.getItem('gbp_members')) || [];
            attendance = JSON.parse(localStorage.getItem('gbp_attendance')) || [];
            finance = JSON.parse(localStorage.getItem('gbp_finance')) || [];
            syncQueue = JSON.parse(localStorage.getItem('gbp_syncQueue')) || [];

            // Admin sync from Firebase
            if(currentUser.role === 'admin' && connectionStatus === 'online') {
                try {
                    const snapshot = await db.ref().once('value');
                    if (snapshot.exists()) {
                        const data = snapshot.val();
                        if (data.members) members = Object.values(data.members).map(m => ({...m, id: m.id || Date.now()}));
                        if (data.attendance) attendance = Object.values(data.attendance);
                        if (data.finance) finance = Object.values(data.finance);
                        if (data.users) users = Object.values(data.users);
                    }
                    localStorage.setItem('gbp_members', JSON.stringify(members));
                    localStorage.setItem('gbp_attendance', JSON.stringify(attendance));
                    localStorage.setItem('gbp_finance', JSON.stringify(finance));
                    localStorage.setItem('gbp_users', JSON.stringify(users));
                } catch(e) {
                    console.error('Sync failed:', e);
                }
            }

            renderAll();
            if(currentUser.role === 'admin') loadUsersTable();
        }

        // --- ALL EXISTING FUNCTIONS MAINTAINED ---
        function renderAll() {
            loadDashboard();
            loadMembersTable();
            loadAttendanceTable();
            loadFinanceTable();
            loadDropdowns();
            updateMemberStats();
        }

        function updateMemberStats() {
            const totalMembers = members.length;
            const activeMembers = members.filter(m => m.status === 'aktif').length;
            const totalChildren = members.reduce((sum, m) => sum + (parseInt(m.jumlah_anak) || 0), 0);
            
            document.getElementById('membersCount').textContent = totalMembers;
            document.getElementById('totalMembersStat').textContent = totalMembers;
            document.getElementById('activeMembersStat').textContent = activeMembers;
            document.getElementById('totalChildrenStat').textContent = totalChildren;
        }

        function loadDashboard() {
            document.getElementById('activeMembers').innerText = members.filter(m => m.status === 'aktif').length;
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('todayAttendance').innerText = attendance.filter(a => a.tanggal === today && a.status === 'hadir').length;
            const total = finance.reduce((acc, curr) => curr.jenis === 'pemasukan' ? acc + Number(curr.jumlah) : acc - Number(curr.jumlah), 0);
            document.getElementById('saldoKas').innerText = 'Rp ' + total.toLocaleString('id-ID');
        }

        // *** MODIFIED: TABLE HEADER & DATA SESUAI SCREENSHOT DENGAN KOLOM BARU ***
        function loadMembersTable() {
            const tbody = document.querySelector('#membersTable tbody');
            tbody.innerHTML = '';
            
            if (members.length === 0) {
                tbody.innerHTML = `<tr><td colspan="10" style="text-align: center; padding: 40px; color: #666;">Tidak ada data anggota. Silakan tambah data atau import dari Excel.</td></tr>`;
                return;
            }
            
            members.forEach(m => {
                // Show/hide action buttons based on user role
                const actionButtons = currentUser.role === 'admin' ? 
                    `<td>
                        <button onclick="editMember(${m.id})" class="btn btn-warning btn-sm">Edit</button>
                        <button onclick="toggleMember(${m.id})" class="btn btn-danger btn-sm">${m.status === 'aktif' ? 'Nonaktif' : 'Aktif'}</button>
                    </td>` : 
                    `<td>-</td>`;
                
                const row = `<tr>
                    <td>${m.no_kep || '-'}</td>
                    <td><strong>${m.nama}</strong></td>
                    <td>${m.tgl_lahir || '-'}</td>
                    <td>${m.alamat}</td>
                    <td>${m.no_hp || '-'}</td>
                    <td>${m.jabatan || 'Anggota'}</td>
                    <td>${m.jumlah_anak || '0'}</td>
                    <td>${m.nama_anak || '-'}</td>
                    <td><span class="status-badge ${m.status === 'aktif' ? 'status-aktif' : 'status-nonaktif'}">${m.status}</span></td>
                    ${actionButtons}
                </tr>`;
                tbody.innerHTML += row;
            });
        }

        function loadAttendanceTable() {
            const tbody = document.querySelector('#attendanceTable tbody');
            tbody.innerHTML = '';
            const sorted = [...attendance].sort((a,b) => new Date(b.tanggal) - new Date(a.tanggal));
            sorted.slice(0, 50).forEach(a => {
                const member = members.find(m => m.id == a.member_id);
                const name = member ? member.nama : 'Anggota Terhapus';
                tbody.innerHTML += `<tr>
                    <td>${a.tanggal}</td>
                    <td>${name}</td>
                    <td>${a.status.toUpperCase()}</td>
                    <td>${a.waktu}</td>
                </tr>`;
            });
        }

        function loadFinanceTable() {
            const tbody = document.querySelector('#financeTable tbody');
            tbody.innerHTML = '';
            const sorted = [...finance].sort((a,b) => new Date(b.tanggal) - new Date(a.tanggal));
            sorted.slice(0, 50).forEach(f => {
                const colorClass = f.jenis === 'pemasukan' ? 'money-plus' : 'money-minus';
                const sign = f.jenis === 'pemasukan' ? '+' : '-';
                tbody.innerHTML += `<tr>
                    <td>${f.tanggal}</td>
                    <td>${f.deskripsi}</td>
                    <td>${f.jenis.toUpperCase()}</td>
                    <td class="${colorClass}">${sign} Rp ${Number(f.jumlah).toLocaleString('id-ID')}</td>
                </tr>`;
            });
        }

        function loadDropdowns() {
            const sel = document.getElementById('member_id_att');
            const currentVal = sel.value;
            sel.innerHTML = '<option value="">-- Pilih Anggota --</option>';
            members.filter(m => m.status === 'aktif').forEach(m => {
                sel.innerHTML += `<option value="${m.id}">${m.nama}</option>`;
            });
            sel.value = currentVal;
        }

        // *** MODIFIED: addMember() DENGAN FIELDS BARU ***
        function addMember() {
            if(currentUser.role !== 'admin') return alert('‚ùå Hanya admin yang bisa tambah anggota!');
            const nama = document.getElementById('nama').value.trim();
            const alamat = document.getElementById('alamat').value.trim();
            if(!nama || !alamat) return alert('‚ùå Nama dan Alamat wajib diisi!');

            const newMember = {
                id: Date.now(),
                no_kep: document.getElementById('no_kep').value.trim(),
                tgl_lahir: document.getElementById('tgl_lahir').value.trim(),
                nama, alamat,
                no_hp: document.getElementById('no_hp').value.trim(),
                jabatan: document.getElementById('jabatan').value.trim() || 'Anggota',
                jumlah_anak: parseInt(document.getElementById('jumlah_anak').value) || 0,
                nama_anak: document.getElementById('nama_anak').value.trim(),
                tgl_lahir_anak: document.getElementById('tgl_lahir_anak').value.trim(),
                pendidikan_anak: document.getElementById('pendidikan_anak').value.trim(),
                anggota_dewasa: parseInt(document.getElementById('anggota_dewasa').value) || 0,
                status: 'aktif',
                createdAt: Date.now()
            };

            members.unshift(newMember);
            queueAction('addMember', newMember);
            localStorage.setItem('gbp_members', JSON.stringify(members));
            
            // Clear form
            document.getElementById('no_kep').value = '';
            document.getElementById('tgl_lahir').value = '';
            document.getElementById('nama').value = '';
            document.getElementById('alamat').value = '';
            document.getElementById('no_hp').value = '';
            document.getElementById('jabatan').value = '';
            document.getElementById('jumlah_anak').value = '';
            document.getElementById('nama_anak').value = '';
            document.getElementById('tgl_lahir_anak').value = '';
            document.getElementById('pendidikan_anak').value = '';
            document.getElementById('anggota_dewasa').value = '';
            
            renderAll();
            alert('‚úÖ Anggota ditambah!');
        }

        function toggleMember(id) {
            if(currentUser.role !== 'admin') return;
            const idx = members.findIndex(m => m.id === id);
            if(idx > -1) {
                members[idx].status = members[idx].status === 'aktif' ? 'nonaktif' : 'aktif';
                queueAction('toggleMember', members[idx]);
                localStorage.setItem('gbp_members', JSON.stringify(members));
                renderAll();
            }
        }

        function addAttendance() {
            if(currentUser.role !== 'admin') return alert('‚ùå Hanya admin yang bisa input absensi!');
            const mid = document.getElementById('member_id_att').value;
            const tgl = document.getElementById('tanggal_att').value;
            if(!mid || !tgl) return alert('‚ùå Pilih anggota dan tanggal!');

            const newAtt = {
                id: Date.now(),
                member_id: mid,
                tanggal: tgl,
                status: document.getElementById('status_hadir').value,
                waktu: new Date().toLocaleTimeString('id-ID'),
                createdAt: Date.now()
            };

            attendance.unshift(newAtt);
            queueAction('addAttendance', newAtt);
            localStorage.setItem('gbp_attendance', JSON.stringify(attendance));
            renderAll();
            alert('‚úÖ Absensi tersimpan!');
        }

        function addFinance() {
            if(currentUser.role !== 'admin') return alert('‚ùå Hanya admin yang bisa input keuangan!');
            const desc = document.getElementById('deskripsi_fin').value.trim();
            const jml = document.getElementById('jumlah_fin').value;
            if(!desc || !jml) return alert('‚ùå Keterangan dan nominal wajib diisi!');

            const newFin = {
                id: Date.now(),
                deskripsi: desc,
                jumlah: Math.abs(Number(jml)),
                jenis: document.getElementById('jenis_fin').value,
                tanggal: document.getElementById('tanggal_fin').value,
                createdAt: Date.now()
            };

            finance.unshift(newFin);
            queueAction('addFinance', newFin);
            localStorage.setItem('gbp_finance', JSON.stringify(finance));
            
            document.getElementById('deskripsi_fin').value = '';
            document.getElementById('jumlah_fin').value = '';
            renderAll();
            alert('‚úÖ Transaksi tersimpan!');
        }

        // *** MODIFIED: Support updateMember di sync ***
        async function processSyncQueue() {
            if (currentUser.role !== 'admin' || isSyncing || syncQueue.length === 0 || connectionStatus !== 'online') return;
            
            isSyncing = true;
            updateStatus('üîÑ Sinkron ' + syncQueue.length + '...', '#ffc107');
            
            while (syncQueue.length > 0) {
                const item = syncQueue.shift();
                try {
                    await executeFirebaseAction(item);
                    localStorage.setItem('gbp_syncQueue', JSON.stringify(syncQueue));
                } catch (e) {
                    console.error('Sync failed:', e);
                    syncQueue.unshift(item);
                    break;
                }
            }
            
            isSyncing = false;
            updateStatus('üü¢ Sinkron Selesai', '#28a745');
        }

        async function executeFirebaseAction(item) {
            const {action, data} = item;
            switch(action) {
                case 'addMember':
                    await db.ref('members').push(data);
                    break;
                case 'toggleMember':
                    await db.ref(`members/${data.id}`).update({status: data.status});
                    break;
                case 'updateMember':  // *** NEW: Support edit member ***
                    await db.ref(`members/${data.id}`).update({
                        no_kep: data.no_kep,
                        tgl_lahir: data.tgl_lahir,
                        nama: data.nama,
                        alamat: data.alamat,
                        no_hp: data.no_hp,
                        jabatan: data.jabatan,
                        status: data.status
                    });
                    break;
                case 'addAttendance':
                    await db.ref('attendance').push(data);
                    break;
                case 'addFinance':
                    await db.ref('finance').push(data);
                    break;
            }
        }

        function manualSync() {
            if(currentUser.role !== 'admin') return alert('‚ùå Hanya admin yang bisa sync manual!');
            if (connectionStatus === 'online') {
                processSyncQueue();
                loadAllData();
                alert('üîÑ Sinkronisasi manual selesai!');
            } else {
                alert('‚ùå Tidak ada koneksi internet!');
            }
        }

        function queueAction(action, data) {
            if(currentUser.role !== 'admin') return alert('‚ùå Hanya admin yang bisa sync data!');
            const queueItem = {action, data, timestamp: Date.now(), id: Date.now()};
            syncQueue.unshift(queueItem);
            localStorage.setItem('gbp_syncQueue', JSON.stringify(syncQueue));
            if (connectionStatus === 'online' && !isSyncing) processSyncQueue();
        }

        function showSection(id, element) {
            document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            if(element) {
                document.querySelectorAll('.nav-links a').forEach(el => el.classList.remove('active'));
                element.classList.add('active');
            }
        }

        // --- AUTO INIT ---
        const savedUser = localStorage.getItem('gbp_currentUser');
        if(savedUser) {
            currentUser = JSON.parse(savedUser);
            initApp();
        }
        
        // Drag and drop for import
        document.addEventListener('DOMContentLoaded', function() {
            const dropArea = document.getElementById('dropArea');
            
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, preventDefaults, false);
            });
            
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            ['dragenter', 'dragover'].forEach(eventName => {
                dropArea.addEventListener(eventName, highlight, false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, unhighlight, false);
            });
            
            function highlight() {
                dropArea.style.background = '#f0f4ff';
                dropArea.style.borderColor = '#5a6fd6';
            }
            
            function unhighlight() {
                dropArea.style.background = '';
                dropArea.style.borderColor = '#667eea';
            }
            
            dropArea.addEventListener('drop', handleDrop, false);
            
            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                
                if (files.length) {
                    const file = files[0];
                    const validTypes = ['text/csv', 'application/vnd.ms-excel', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'];
                    const fileExt = file.name.split('.').pop().toLowerCase();
                    
                    if (!validTypes.includes(file.type) && !['csv', 'xlsx', 'xls'].includes(fileExt)) {
                        alert('‚ùå Format file tidak didukung! Gunakan CSV atau Excel.');
                        return;
                    }
                    
                    importFile = file;
                    document.getElementById('selectedFileName').textContent = file.name + ' (' + formatFileSize(file.size) + ')';
                    document.getElementById('fileInput').files = dt.files;
                    
                    // Auto trigger parsing if modal is open
                    if (document.getElementById('importModal').style.display === 'flex') {
                        setTimeout(() => parseImportFile(), 500);
                    }
                }
            }
        });
    </script>
</body>
</html>

