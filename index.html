<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üèõÔ∏è Girsang Boru Panagolan Tangerang - Management System OFFLINE</title>
    <!-- PWA Manifest -->
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiR2lyc2FuZyBCb3J1IFBhbmFnb2xhbiIsInNob3J0X25hbWUiOiJHYXAiLCJzdGFydF91cmwiOiIvIiwidGhlbWVfY29sb3IiOiIjNjY3ZWVhIiwiYmFja2dyb3VuZF9jb2xvciI6IiNmOGY5ZmEiLCJkaXNwbGF5Ijoic3RhbmRhbG9uZSIsImljb25zIjpbeyJzcmMiOiJkYXRhOmltYWdlL3N2Zyt4bWw7YmFzZTY0LGV5SnBjM01pT2lKMFBpSktWMVFpTENKamIyNTJJaUI1SUVGeVJXVXROUVFuSU5qUXlNelFuUVRoTmJ3dU5tWmtPRGt0TVRSMFFtUm9ZWE5sSWpvaU1qUXNJbk5tSWpFMUxDSXNJbTkwWXpJMlptUm9MQ0lzSW01bEluTnZiV0ZwYldRaU1qUXNJbk4wSWlCNE16UXNJbk5sTVRJeE1EazJOamszT1RJeU1qSXdNREkzTmpReU1URT1NRGoxTVRjNU1UZ3hNaTB4SWlCNE1qRXNJbU5sTVRSNlptUXNJbTl6TXpRMU1ETXdNREkzTVRjeU1qUXNJbU5sTVRSNlptUXNJbTkwWXpJMlptRm1JaXNJbTl6TVRReU1ETXdNREkzTVRjeU1qUXNJbU5sTVRSNlptUXNJbTkwWXpJMlptUm9MQ0lzSW01bEluTnZiV0ZwYldRaU1qUXNJbk4wSWlCNE16UXNJbk5sTVRJeE1EazJOamszT1RJeU1qSXdNREkzTmpReU1URT1NRGoxTVRjNU1UZ3hNaTB4IiwiZm9ybWF0Ijoic3ZnIiwidHlwZSI6ImltYWdlL3N2Zyt4bWwiLCJzaXplcyI6IjUxMng1MTIifV19">
    <meta name="theme-color" content="#667eea">
    <style>
        *{margin:0;padding:0;box-sizing:border-box;}
        body{font-family:system-ui,-apple-system,sans-serif;background:#f8f9fa;min-height:100vh;}
        .header{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;padding:20px;text-align:center;position:sticky;top:0;z-index:100;box-shadow:0 4px 20px rgba(0,0,0,0.1);}
        .header h1{font-size:clamp(1.5rem,5vw,2.5rem);margin:0;font-weight:300;}
        .header p{font-size:clamp(0.9rem,3vw,1.1rem);opacity:0.95;}
        .navbar{background:#fff;padding:15px;box-shadow:0 2px 10px rgba(0,0,0,0.08);position:sticky;top:80px;z-index:99;}
        .nav-links{display:flex;justify-content:center;gap:8px;flex-wrap:wrap;}
        .nav-links a{color:#495057;text-decoration:none;padding:12px 20px;border-radius:25px;font-weight:500;font-size:clamp(0.85rem,2.5vw,1rem);transition:all 0.3s;}
        .nav-links a.active,.nav-links a:hover{background:#667eea;color:white;}
        .container{max-width:1400px;margin:20px auto;padding:0 15px;}
        .section{background:white;border-radius:20px;padding:30px;margin:20px 0;box-shadow:0 10px 30px rgba(0,0,0,0.08);display:none;overflow:hidden;}
        .section.active{display:block;}
        .section-header{padding:25px 30px;background:linear-gradient(135deg,#f093fb 0%,#f5576c 100%);color:white;margin:-30px -30px 30px -30px;position:relative;}
        .section-header h2{margin:0;font-size:1.8rem;font-weight:400;}
        .stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:20px;margin:25px 0;}
        .stat-card{background:#f8f9fa;padding:30px;border-radius:20px;text-align:center;transition:all 0.3s;cursor:pointer;}
        .stat-card:hover{transform:translateY(-8px);box-shadow:0 20px 40px rgba(0,0,0,0.15);}
        .stat-number{font-size:clamp(2rem,8vw,3.5rem);font-weight:700;color:#667eea;margin-bottom:10px;}
        .stat-label{color:#666;font-size:clamp(0.9rem,3vw,1.1rem);font-weight:500;}
        .form-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:20px;margin:25px 0;}
        input,select{padding:16px;border:2px solid #e9ecef;border-radius:15px;font-size:16px;width:100%;transition:all 0.3s;font-family:inherit;}
        input:focus,select:focus{outline:none;border-color:#667eea;box-shadow:0 0 0 4px rgba(102,126,234,0.15);}
        .btn{padding:16px 32px;border:none;border-radius:15px;cursor:pointer;font-size:16px;font-weight:600;transition:all 0.3s;margin:10px 5px 0 0;display:inline-flex;align-items:center;gap:8px;}
        .btn-primary{background:linear-gradient(135deg,#28a745,#20c997);color:white;}
        .btn-primary:hover{background:linear-gradient(135deg,#218838,#1ea085);transform:translateY(-2px);}
        .btn-danger{background:linear-gradient(135deg,#dc3545,#c82333);color:white;}
        .btn-danger:hover{background:linear-gradient(135deg,#c82333,#b21f2d);transform:translateY(-2px);}
        table{width:100%;border-collapse:collapse;margin:25px 0;border-radius:15px;overflow:hidden;box-shadow:0 8px 25px rgba(0,0,0,0.1);}
        th{background:linear-gradient(135deg,#667eea,#5a67d8);color:white;padding:18px;font-weight:500;font-size:1rem;}
        td{padding:18px;border-bottom:1px solid #f0f0f0;vertical-align:middle;}
        tr:hover{background:#f9fcff;}
        .status-badge{padding:10px 20px;border-radius:30px;font-size:14px;font-weight:600;display:inline-block;box-shadow:0 4px 15px rgba(0,0,0,0.1);}
        .aktif{background:linear-gradient(135deg,#d4edda,#c3e6cb);color:#155724;border:2px solid #28a745;}
        .nonaktif{background:linear-gradient(135deg,#f8d7da,#f5c6cb);color:#721c24;border:2px solid #dc3545;}
        .login-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.85);display:flex;align-items:center;justify-content:center;z-index:1000;}
        .login-box{background:white;padding:50px;border-radius:25px;width:90%;max-width:450px;text-align:center;box-shadow:0 25px 50px rgba(0,0,0,0.3);backdrop-filter:blur(10px);}
        .status{display:inline-flex;align-items:center;gap:8px;padding:8px 16px;border-radius:25px;font-size:14px;font-weight:600;position:absolute;top:25px;right:25px;}
        .online{background:linear-gradient(135deg,#28a745,#20c997);color:white;}
        .offline{background:linear-gradient(135deg,#dc3545,#c82333);color:white;}
        .syncing{background:linear-gradient(135deg,#ffc107,#e0a800);color:#212529;}
        .success-msg{background:linear-gradient(135deg,#d4edda,#c3e6cb);color:#155724;padding:20px;border-radius:15px;margin:20px 0;border-left:5px solid #28a745;font-weight:500;display:none;box-shadow:0 5px 15px rgba(40,167,69,0.2);}
        @media(max-width:768px){.form-grid{grid-template-columns:1fr;}.nav-links a{font-size:0.9rem;padding:10px 15px;}}
    </style>
</head>
<body>
    <!-- Login Overlay -->
    <div id="loginOverlay" class="login-overlay">
        <div class="login-box">
            <h1 style="color:#667eea;font-size:2.5rem;margin-bottom:20px;">üèõÔ∏è Girsang Boru Panagolan</h1>
            <p style="color:#666;font-size:1.1rem;margin-bottom:30px;">Sistem Informasi Manajemen Tangerang</p>
            <input type="text" id="username" placeholder="üë§ Username" value="admin" style="margin-bottom:20px;padding:20px;font-size:18px;">
            <input type="password" id="password" placeholder="üîí Password" value="admin123" style="margin-bottom:25px;padding:20px;font-size:18px;">
            <button onclick="doLogin()" class="btn btn-primary" style="width:100%;padding:20px;font-size:18px;">üöÄ MASUK KE SISTEM</button>
            <p style="margin-top:25px;color:#666;font-size:15px;">Default: <strong>admin</strong> / <strong>admin123</strong></p>
        </div>
    </div>

    <!-- Main Application -->
    <div id="mainApp" style="display:none;">
        <div class="header">
            <h1>üèõÔ∏è Kumpulan Girsang Boru Panagolan Tangerang</h1>
            <p>Real-time Management System <span id="connectionStatus" class="status online">üü¢ Online & Sinkron</span></p>
            <button onclick="logout()" class="btn btn-danger" style="position:absolute;top:25px;right:25px;padding:12px 24px;border-radius:50%;width:65px;height:65px;font-size:22px;font-weight:bold;">√ó</button>
        </div>

        <nav class="navbar">
            <div class="nav-links">
                <a onclick="showSection('dashboard')" class="active">üìä Dashboard</a>
                <a onclick="showSection('members')">üë• Keanggotaan</a>
                <a onclick="showSection('attendance')">üìã Absensi</a>
                <a onclick="showSection('finance')">üí∞ Keuangan</a>
            </div>
        </nav>

        <div class="container">
            <!-- DASHBOARD -->
            <section id="dashboard" class="section active">
                <div class="section-header">
                    <h2>üìä Dashboard Overview</h2>
                </div>
                <div class="stats">
                    <div class="stat-card">
                        <div class="stat-number" id="activeMembersCount">0</div>
                        <div class="stat-label">Anggota Aktif</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="todayAttendanceCount">0</div>
                        <div class="stat-label">Hadir Hari Ini</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="currentBalance">Rp 0</div>
                        <div class="stat-label">Saldo Kas</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalMembersCount">0</div>
                        <div class="stat-label">Total Anggota</div>
                    </div>
                    <div class="stat-card" style="background:linear-gradient(135deg,#17a2b8,#138496);color:white;">
                        <div class="stat-number" id="pendingSyncCount">0</div>
                        <div class="stat-label">Data Offline Menunggu</div>
                    </div>
                </div>
            </section>

            <!-- MEMBERS -->
            <section id="members" class="section">
                <div class="section-header">
                    <h2>üë• Manajemen Keanggotaan</h2>
                </div>
                <div class="form-grid">
                    <input id="newMemberName" placeholder="Nama Lengkap *">
                    <input id="newMemberAddress" placeholder="Alamat Lengkap *">
                    <input id="newMemberPhone" placeholder="No. HP">
                    <input id="newMemberEmail" placeholder="Email">
                    <input id="newMemberPosition" placeholder="Jabatan / Status">
                    <button onclick="addNewMember()" class="btn btn-primary">‚ûï Tambah Anggota Baru</button>
                </div>
                <div id="memberSuccessMsg" class="success-msg"></div>
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Nama Lengkap</th>
                            <th>Alamat</th>
                            <th>HP/Email</th>
                            <th>Jabatan</th>
                            <th>Status</th>
                            <th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="membersTableBody"></tbody>
                </table>
            </section>

            <!-- ATTENDANCE -->
            <section id="attendance" class="section">
                <div class="section-header">
                    <h2>üìã Daftar Hadir & Absensi</h2>
                </div>
                <div class="form-grid">
                    <select id="attendanceMemberSelect">
                        <option value="">Pilih Anggota</option>
                    </select>
                    <input type="date" id="attendanceDate">
                    <select id="attendanceStatus">
                        <option value="hadir">‚úÖ Hadir</option>
                        <option value="alfa">‚ùå Alfa</option>
                        <option value="izin">üìÑ Izin</option>
                        <option value="sakit">üè• Sakit</option>
                    </select>
                    <button onclick="recordAttendance()" class="btn btn-primary">‚úÖ Catat Absensi</button>
                </div>
                <h3 style="margin:35px 0 25px 0;color:#667eea;font-size:1.4rem;">üìä Daftar Hadir Hari Ini</h3>
                <table>
                    <thead>
                        <tr><th>Nama Anggota</th><th>Status</th><th>Waktu Absen</th><th>Keterangan</th></tr>
                    </thead>
                    <tbody id="attendanceTableBody"></tbody>
                </table>
            </section>

            <!-- FINANCE -->
            <section id="finance" class="section">
                <div class="section-header">
                    <h2>üí∞ Manajemen Keuangan</h2>
                </div>
                <div class="form-grid">
                    <select id="financeMemberSelect">
                        <option value="">[Transaksi Umum]</option>
                    </select>
                    <input id="financeDescription" placeholder="Deskripsi Transaksi *">
                    <input type="number" id="financeAmount" placeholder="Jumlah (Rp) *" step="1000">
                    <input type="date" id="financeDate">
                    <select id="financeType">
                        <option value="pemasukan">üí∞ Pemasukan / Iuran</option>
                        <option value="pengeluaran">üì§ Pengeluaran</option>
                    </select>
                    <button onclick="addFinanceTransaction()" class="btn btn-primary">üí∏ Simpan Transaksi</button>
                </div>
                <div id="financeSuccessMsg" class="success-msg"></div>
                <h3 style="margin:35px 0 25px 0;color:#667eea;font-size:1.4rem;">üìà 15 Transaksi Terakhir</h3>
                <table>
                    <thead>
                        <tr><th>Deskripsi</th><th>Jumlah</th><th>Tanggal</th><th>Jenis</th><th>Anggota</th></tr>
                    </thead>
                    <tbody id="financeTableBody"></tbody>
                </table>
            </section>
        </div>
    </div>

    <!-- Firebase SDK v9 Compat -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script>
        // üî• FULL OFFLINE SUPPORT + AUTO SYNC SYSTEM
        const firebaseConfig = {
            apiKey: "AIzaSyCqF5VG2T03yaHOAq8dPhtvgMYrbVq-DIs",
            authDomain: "girsangborupanagolantangerang.firebaseapp.com",
            databaseURL: "https://girsangborupanagolantangerang-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "girsangborupanagolantangerang",
            storageBucket: "girsangborupanagolantangerang.firebasestorage.app",
            messagingSenderId: "823404152768",
            appId: "1:823404152768:web:c743fa07b22455452b2a25",
            measurementId: "G-716P2TK99Y"
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Global state
        let allMembers = [], allAttendance = [], allFinances = [], isAuthenticated = false;
        let db, pendingSyncCount = 0;

        // üî• INDEXEDDB Setup
        const idbRequest = indexedDB.open('GirsangOfflineDB', 3);
        idbRequest.onupgradeneeded = e => {
            db = e.target.result;
            if (!db.objectStoreNames.contains('pendingSync')) {
                db.createObjectStore('pendingSync', {autoIncrement: true});
            }
            if (!db.objectStoreNames.contains('localData')) {
                db.createObjectStore('localData', {keyPath: 'type'});
            }
        };
        idbRequest.onsuccess = () => { db = idbRequest.result; loadOfflineData(); };
        idbRequest.onerror = () => console.error('IndexedDB error');

        // üî• Network Status
        function updateConnectionStatus() {
            const statusEl = document.getElementById('connectionStatus');
            if (navigator.onLine) {
                statusEl.textContent = 'üü¢ Online & Sinkron';
                statusEl.className = 'status online';
                syncAllPendingData();
            } else {
                statusEl.textContent = 'üî¥ Offline Mode';
                statusEl.className = 'status offline';
            }
            updatePendingCount();
        }
        window.addEventListener('online', updateConnectionStatus);
        window.addEventListener('offline', updateConnectionStatus);

        // üî• OFFLINE QUEUE SYSTEM
        async function queueOfflineAction(action, data) {
            const item = {action, data, timestamp: Date.now(), id: Date.now()};
            
            if (navigator.onLine) {
                await executeFirebaseAction(item);
            } else {
                // Save to IndexedDB
                const tx = db.transaction('pendingSync', 'readwrite');
                tx.objectStore('pendingSync').add(item);
                pendingSyncCount++;
                updatePendingCount();
                showNotification('memberSuccessMsg', 'üíæ Disimpan offline - Auto sync saat online!', 'success');
            }
            updateLocalData();
        }

        async function syncAllPendingData() {
            if (!db || !navigator.onLine) return;
            
            const tx = db.transaction('pendingSync', 'readwrite');
            const store = tx.objectStore('pendingSync');
            const allPending = await store.getAll();
            
            for (const item of allPending) {
                try {
                    await executeFirebaseAction(item);
                    store.delete(item.id || item.timestamp);
                    pendingSyncCount--;
                } catch (e) {
                    console.error('Sync failed:', e);
                    break;
                }
            }
            updatePendingCount();
            showNotification('memberSuccessMsg', `‚úÖ ${allPending.length} data berhasil di-sync!`, 'success');
        }

        async function executeFirebaseAction(item) {
            switch(item.action) {
                case 'addMember':
                    await database.ref('members').push(item.data);
                    break;
                case 'addAttendance':
                    await database.ref('attendance').push(item.data);
                    break;
                case 'addFinance':
                    await database.ref('finances').push(item.data);
                    break;
            }
        }

        // üî• Local Data Management
        function updateLocalData() {
            localStorage.setItem('offlineMembers', JSON.stringify(allMembers));
            localStorage.setItem('offlineAttendance', JSON.stringify(allAttendance));
            localStorage.setItem('offlineFinances', JSON.stringify(allFinances));
        }

        async function loadOfflineData() {
            allMembers = JSON.parse(localStorage.getItem('offlineMembers') || '[]');
            allAttendance = JSON.parse(localStorage.getItem('offlineAttendance') || '[]');
            allFinances = JSON.parse(localStorage.getItem('offlineFinances') || '[]');
            renderAllTables();
            updateDashboardStats();
        }

        function updatePendingCount() {
            document.getElementById('pendingSyncCount').textContent = pendingSyncCount;
        }

        // üî• Authentication
        function doLogin() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            if (username === 'admin' && password === 'admin123') {
                isAuthenticated = true;
                document.getElementById('loginOverlay').style.display = 'none';
                document.getElementById('mainApp').style.display = 'block';
                initializeRealtimeListeners();
                updateConnectionStatus();
            } else {
                alert('‚ùå Username atau password salah!');
            }
        }

        function logout() {
            isAuthenticated = false;
            document.getElementById('loginOverlay').style.display = 'flex';
            document.getElementById('mainApp').style.display = 'none';
        }

        // üî• Navigation
        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-links a').forEach(a => a.classList.remove('active'));
            document.getElementById(sectionId).classList.add('active');
            event.target.classList.add('active');
            if (sectionId === 'dashboard') updateDashboardStats();
        }

        // üî• Firebase Listeners with Offline Fallback
        function initializeRealtimeListeners() {
            database.ref('members').on('value', snapshot => {
                const data = snapshot.val();
                allMembers = data ? Object.values(data) : [];
                updateLocalData();
                renderMembersTable();
                updateMemberSelects();
                updateDashboardStats();
            }, error => {
                console.log('Firebase offline, using local data');
            });

            database.ref('attendance').on('value', snapshot => {
                const data = snapshot.val();
                allAttendance = data ? Object.values(data) : [];
                updateLocalData();
                renderAttendanceTable();
                updateDashboardStats();
            });

            database.ref('finances').on('value', snapshot => {
                const data = snapshot.val();
                allFinances = data ? Object.values(data) : [];
                updateLocalData();
                renderFinancesTable();
                updateDashboardStats();
            });
        }

        // üî• CRUD Functions with Offline Support
        function addNewMember() {
            const memberData = {
                id: Date.now(),
                name: document.getElementById('newMemberName').value.trim(),
                address: document.getElementById('newMemberAddress').value.trim(),
                phone: document.getElementById('newMemberPhone').value.trim(),
                email: document.getElementById('newMemberEmail').value.trim(),
                position: document.getElementById('newMemberPosition').value.trim(),
                status: 'aktif',
                createdAt: firebase.database.ServerValue.TIMESTAMP,
                updatedAt: firebase.database.ServerValue.TIMESTAMP
            };

            if (!memberData.name || !memberData.address) {
                showNotification('memberSuccessMsg', '‚ùå Nama dan alamat wajib diisi!', 'error');
                return;
            }

            queueOfflineAction('addMember', memberData);
            clearMemberForm();
        }

        function recordAttendance() {
            const memberId = document.getElementById('attendanceMemberSelect').value;
            if (!memberId) return alert('‚ùå Pilih anggota terlebih dahulu!');

            const attendanceData = {
                id: Date.now(),
                memberId: memberId,
                date: document.getElementById('attendanceDate').value,
                status: document.getElementById('attendanceStatus').value,
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                time: new Date().toLocaleTimeString('id-ID', {hour12: false}).slice(0, 5)
            };

            queueOfflineAction('addAttendance', attendanceData);
            document.getElementById('attendanceMemberSelect').value = '';
        }

        function addFinanceTransaction() {
            const financeData = {
                id: Date.now(),
                memberId: document.getElementById('financeMemberSelect').value || null,
                description: document.getElementById('financeDescription').value.trim(),
                amount: parseFloat(document.getElementById('financeAmount').value) || 0,
                date: document.getElementById('financeDate').value,
                type: document.getElementById('financeType').value,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            };

            if (!financeData.description || financeData.amount <= 0) {
                showNotification('financeSuccessMsg', '‚ùå Deskripsi dan jumlah wajib!', 'error');
                return;
            }

            queueOfflineAction('addFinance', financeData);
            clearFinanceForm();
        }

        // üî• Render Functions
        function renderMembersTable() {
            const tbody = document.getElementById('membersTableBody');
            tbody.innerHTML = '';
            allMembers.slice(-25).forEach(member => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${member.id?.toString().slice(-8) || '-'}</td>
                    <td><strong>${member.name || '-'}</strong></td>
                    <td>${(member.address || '').slice(0, 30)}${(member.address || '').length > 30 ? '...' : ''}</td>
                    <td>${member.phone || ''}<br><small>${member.email || ''}</small></td>
                    <td>${member.position || '-'}</td>
                    <td><span class="status-badge ${member.status || 'aktif'}">${member.status || 'aktif'}</span></td>
                    <td><button onclick="toggleMemberStatus('${member.id}')" class="btn btn-danger" style="padding:8px 16px;font-size:13px;">${member.status === 'aktif' ? 'Nonaktif' : 'Aktifkan'}</button></td>
                `;
            });
        }

        function renderAttendanceTable() {
            const today = new Date().toISOString().split('T')[0];
            const todayAttendance = allAttendance.filter(a => a.date === today);
            const tbody = document.getElementById('attendanceTableBody');
            tbody.innerHTML = '';
            todayAttendance.slice(-15).reverse().forEach(record => {
                const member = allMembers.find(m => m.id == record.memberId);
                if (member) {
                    const row = tbody.insertRow();
                    const color = record.status === 'hadir' ? '#155724' : record.status === 'alfa' ? '#721c24' : '#856404';
                    const bg = record.status === 'hadir' ? '#d4edda' : record.status === 'alfa' ? '#f8d7da' : '#fff3cd';
                    row.innerHTML = `<td><strong>${member.name}</strong></td><td><span style="padding:8px 16px;border-radius:20px;background:${bg};color:${color};">${record.status}</span></td><td>${record.time || '-'}</td><td>${record.notes || '-'}</td>`;
                }
            });
        }

        function renderFinancesTable() {
            const tbody = document.getElementById('financeTableBody');
            tbody.innerHTML = '';
            allFinances.slice(0, 15).reverse().forEach(finance => {
                const member = allMembers.find(m => m.id == finance.memberId);
                const row = tbody.insertRow();
                const isIncome = finance.type === 'pemasukan';
                row.innerHTML = `
                    <td>${finance.description || '-'}</td>
                    <td style="color:${isIncome ? '#28a745' : '#dc3545'};font-weight:700;font-size:1.1rem;">Rp ${Math.round(finance.amount || 0).toLocaleString()}</td>
                    <td>${finance.date || '-'}</td>
                    <td><span style="padding:8px 16px;border-radius:20px;background:${isIncome ? '#d4edda' : '#f8d7da'};color:${isIncome ? '#155724' : '#721c24'};">${finance.type}</span></td>
                    <td>${member ? member.name : 'Umum'}</td>
                `;
            });
        }

        function renderAllTables() {
            renderMembersTable();
            renderAttendanceTable();
            renderFinancesTable();
        }

        function updateMemberSelects() {
            const attSelect = document.getElementById('attendanceMemberSelect');
            const finSelect = document.getElementById('financeMemberSelect');
            attSelect.innerHTML = '<option value="">Pilih Anggota</option>';
            finSelect.innerHTML = '<option value="">[Transaksi Umum]</option>';
            allMembers.filter(m => m.status === 'aktif').forEach(m => {
                attSelect.innerHTML += `<option value="${m.id}">${m.name}</option>`;
                finSelect.innerHTML += `<option value="${m.id}">${m.name}</option>`;
            });
        }

        function updateDashboardStats() {
            const today = new Date().toISOString().split('T')[0];
            const activeMembersCount = allMembers.filter(m => m.status === 'aktif').length;
            const todayAttendanceCount = allAttendance.filter(a => a.date === today).length;
            const totalMembersCount = allMembers.length;
            const balance = allFinances.reduce((total, f) => f.type === 'pemasukan' ? total + (f.amount || 0) : total - (f.amount || 0), 0);

            document.getElementById('activeMembersCount').textContent = activeMembersCount;
            document.getElementById('todayAttendanceCount').textContent = todayAttendanceCount;
            document.getElementById('currentBalance').textContent = `Rp ${Math.abs(balance).toLocaleString()}`;
            document.getElementById('totalMembersCount').textContent = totalMembersCount;
            document.getElementById('pendingSyncCount').textContent = pendingSyncCount;
        }

        function toggleMemberStatus(memberId) {
            const member = allMembers.find(m => m.id == memberId);
            if (member) {
                member.status = member.status === 'aktif' ? 'nonaktif' : 'aktif';
                updateLocalData();
                renderMembersTable();
                updateMemberSelects();
                updateDashboardStats();
            }
        }

        // üî• Utility Functions
        function clearMemberForm() {
            ['newMemberName', 'newMemberAddress', 'newMemberPhone', 'newMemberEmail', 'newMemberPosition'].forEach(id => 
                document.getElementById(id).value = ''
            );
        }

        function clearFinanceForm() {
            document.getElementById('financeDescription').value = '';
            document.getElementById('financeAmount').value = '';
        }

        function showNotification(elementId, message, type = 'success') {
            const el = document.getElementById(elementId);
            el.textContent = message;
            el.style.display = 'block';
            el.style.background = type === 'success' ? 'linear-gradient(135deg,#d4edda,#c3e6cb)' : 'linear-gradient(135deg,#f8d7da,#f5c6cb)';
            setTimeout(() => el.style.display = 'none', 4000);
        }

        // üî• FULL PWA SERVICE WORKER
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register(new Blob([`
                const CACHE_NAME = 'girsang-offline-v3';
                const urlsToCache = [
                    location.href,
                    'https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js',
                    'https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js'
                ];

                self.addEventListener('install', e => {
                    e.waitUntil(
                        caches.open(CACHE_NAME).then(cache => 
                            cache.addAll(urlsToCache).then(() => self.skipWaiting())
                        )
                    );
                });

                self.addEventListener('fetch', e => {
                    e.respondWith(
                        caches.match(e.request).then(cached => 
                            cached || fetch(e.request).then(net => {
                                return caches.open(CACHE_NAME).then(cache => {
                                    cache.put(e.request, net.clone());
                                    return net;
                                });
                            }).catch(() => caches.match('/') || new Response('Offline Mode', {
                                status: 200,
                                headers: {'Content-Type': 'text/html'}
                            }))
                        )
                    );
                });

                self.addEventListener('activate', e => {
                    e.waitUntil(
                        caches.keys().then(names => 
                            Promise.all(names.map(name => 
                                name !== CACHE_NAME ? caches.delete(name) : null
                            )).then(() => self.clients.claim())
                        )
                    );
                });

                self.addEventListener('sync', e => {
                    if (e.tag === 'sync-offline-data') {
                        e.waitUntil(syncOfflineData());
                    }
                });

                async function syncOfflineData() {
                    const clients = await self.clients.matchAll();
                    clients.forEach(client => client.postMessage({type: 'SYNC_PENDING'}));
                }
            `], {type: 'application/javascript'}));
        }

        // üî• Initialize App
        document.addEventListener('DOMContentLoaded', () => {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('attendanceDate').value = today;
            document.getElementById('financeDate').value = today;
            
            document.getElementById('username').addEventListener('keypress', e => e.key === 'Enter' && doLogin());
            document.getElementById('password').addEventListener('keypress', e => e.key === 'Enter' && doLogin());
            updateConnectionStatus();
        });

        // üî• Handle Service Worker Messages
        navigator.serviceWorker.addEventListener('message', e => {
            if (e.data.type === 'SYNC_PENDING') {
                syncAllPendingData();
            }
        });
    </script>
</body>
</html>
