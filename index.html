<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚õ™ Girsang Boru Panagolan Tangerang - Management System</title>
    
    <style>
        /* RESET & BASE STYLES */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; background: white; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); overflow: hidden; }

        /* HEADER STYLES */
        .header { background: linear-gradient(135deg, #2c3e50, #4a6491); color: white; padding: 25px 40px; display: flex; justify-content: space-between; align-items: center; border-bottom: 5px solid #3498db; }
        .logo-section { display: flex; align-items: center; gap: 20px; }
        .logo { width: 80px; height: 80px; background: #fff; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 40px; color: #2c3e50; font-weight: bold; border: 3px solid #3498db; }
        .title-section h1 { font-size: 28px; margin-bottom: 5px; font-weight: 700; }
        .title-section h2 { font-size: 18px; opacity: 0.9; font-weight: 400; }
        .user-section { display: flex; align-items: center; gap: 15px; }
        .user-info { text-align: right; }
        .user-name { font-weight: 600; font-size: 18px; }
        .user-role { font-size: 14px; opacity: 0.8; background: rgba(255,255,255,0.2); padding: 3px 10px; border-radius: 15px; display: inline-block; }
        .btn-logout { background: #e74c3c; color: white; border: none; padding: 10px 20px; border-radius: 10px; cursor: pointer; font-weight: 600; transition: all 0.3s; display: flex; align-items: center; gap: 8px; }
        .btn-logout:hover { background: #c0392b; transform: translateY(-2px); }

        /* CONNECTION STATUS */
        .connection-status { display: flex; align-items: center; gap: 10px; font-size: 14px; margin-top: 10px; }
        .status-indicator { width: 12px; height: 12px; border-radius: 50%; display: inline-block; }
        .status-online { background: #2ecc71; box-shadow: 0 0 10px #2ecc71; }
        .status-offline { background: #e74c3c; box-shadow: 0 0 10px #e74c3c; }

        /* NAVIGATION STYLES */
        .nav-tabs { display: flex; background: #f8f9fa; padding: 0 40px; border-bottom: 2px solid #e9ecef; gap: 5px; }
        .tab-btn { padding: 15px 25px; background: none; border: none; font-size: 16px; font-weight: 600; color: #6c757d; cursor: pointer; transition: all 0.3s; position: relative; display: flex; align-items: center; gap: 8px; }
        .tab-btn:hover { color: #495057; background: #e9ecef; }
        .tab-btn.active { color: #3498db; background: white; border-bottom: 3px solid #3498db; }

        /* MAIN CONTENT */
        .main-content { padding: 30px 40px; min-height: 600px; }
        .tab-content { display: none; animation: fadeIn 0.5s ease-in-out; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* DASHBOARD CONTENT */
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 25px; margin-bottom: 30px; }
        .stat-card { background: white; border-radius: 15px; padding: 25px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); border-left: 5px solid; transition: transform 0.3s; }
        .stat-card:hover { transform: translateY(-5px); }
        .stat-card.total { border-left-color: #3498db; }
        .stat-card.active { border-left-color: #2ecc71; }
        .stat-card.inactive { border-left-color: #e74c3c; }
        .stat-card.pending { border-left-color: #f39c12; }
        .stat-icon { font-size: 40px; margin-bottom: 15px; }
        .stat-value { font-size: 32px; font-weight: 700; margin-bottom: 5px; }
        .stat-label { color: #6c757d; font-size: 16px; }

        /* TABLE STYLES */
        .table-container { background: white; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); overflow: hidden; margin-top: 20px; }
        .table-header { background: linear-gradient(135deg, #3498db, #2980b9); color: white; padding: 20px; display: flex; justify-content: space-between; align-items: center; }
        .table-header h3 { font-size: 22px; font-weight: 600; }
        .table-tools { display: flex; gap: 10px; flex-wrap: wrap; }
        .btn { padding: 10px 20px; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 8px; transition: all 0.3s; white-space: nowrap; }
        .btn-primary { background: #3498db; color: white; }
        .btn-primary:hover { background: #2980b9; transform: translateY(-2px); }
        .btn-success { background: #2ecc71; color: white; }
        .btn-success:hover { background: #27ae60; transform: translateY(-2px); }
        .btn-warning { background: #f39c12; color: white; }
        .btn-warning:hover { background: #d35400; transform: translateY(-2px); }
        .btn-danger { background: #e74c3c; color: white; }
        .btn-danger:hover { background: #c0392b; transform: translateY(-2px); }
        .btn-export { background: #9b59b6; color: white; }
        .btn-export:hover { background: #8e44ad; transform: translateY(-2px); }
        .table-wrapper { overflow-x: auto; padding: 20px; }
        table { width: 100%; border-collapse: collapse; min-width: 800px; }
        th { background: #f8f9fa; padding: 15px; text-align: left; font-weight: 600; color: #2c3e50; border-bottom: 2px solid #e9ecef; }
        td { padding: 15px; border-bottom: 1px solid #e9ecef; vertical-align: middle; }
        tr:hover { background: #f8f9fa; }
        .status-badge { padding: 5px 15px; border-radius: 20px; font-size: 12px; font-weight: 600; display: inline-block; }
        .status-aktif { background: #d4edda; color: #155724; }
        .status-nonaktif { background: #f8d7da; color: #721c24; }
        .action-buttons { display: flex; gap: 5px; flex-wrap: wrap; }
        .action-btn { width: 35px; height: 35px; border: none; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 14px; transition: all 0.3s; }
        .action-btn.edit { background: #3498db; color: white; }
        .action-btn.edit:hover { background: #2980b9; }
        .action-btn.delete { background: #e74c3c; color: white; }
        .action-btn.delete:hover { background: #c0392b; }
        .action-btn.view { background: #2ecc71; color: white; }
        .action-btn.view:hover { background: #27ae60; }
        
        /* FIX: Tambahan style untuk tombol reset password */
        .action-btn.reset { background: #f39c12; color: white; }
        .action-btn.reset:hover { background: #d35400; }

        /* FORM STYLES */
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #2c3e50; }
        .form-control { width: 100%; padding: 12px 15px; border: 2px solid #e9ecef; border-radius: 10px; font-size: 16px; transition: all 0.3s; }
        .form-control:focus { border-color: #3498db; outline: none; box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1); }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }

        /* MODAL STYLES */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 1000; padding: 20px; }
        .modal-box { background: white; border-radius: 15px; width: 100%; max-width: 900px; max-height: 90vh; overflow-y: auto; animation: modalSlideIn 0.3s ease-out; }
        @keyframes modalSlideIn { from { opacity: 0; transform: translateY(-50px); } to { opacity: 1; transform: translateY(0); } }
        .modal-header { background: linear-gradient(135deg, #3498db, #2980b9); color: white; padding: 20px; border-radius: 15px 15px 0 0; display: flex; justify-content: space-between; align-items: center; }
        .modal-close { font-size: 28px; cursor: pointer; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: all 0.3s; }
        .modal-close:hover { background: rgba(255,255,255,0.2); transform: rotate(90deg); }
        .modal-body { padding: 30px; }
        .modal-footer { padding: 20px 30px; border-top: 1px solid #e9ecef; display: flex; justify-content: flex-end; gap: 10px; }

        /* SEARCH AND FILTER STYLES */
        .search-box { position: relative; margin-bottom: 20px; }
        .search-input { width: 100%; padding: 12px 45px 12px 15px; border: 2px solid #e9ecef; border-radius: 10px; font-size: 16px; transition: all 0.3s; }
        .search-input:focus { border-color: #3498db; outline: none; box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1); }
        .search-icon { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: #6c757d; font-size: 18px; }
        .filter-buttons { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .filter-btn { padding: 8px 15px; background: #f8f9fa; border: 2px solid #e9ecef; border-radius: 20px; cursor: pointer; font-size: 14px; transition: all 0.3s; }
        .filter-btn:hover { background: #e9ecef; }
        .filter-btn.active { background: #3498db; color: white; border-color: #3498db; }

        /* LOGIN FORM */
        .login-container { display: flex; align-items: center; justify-content: center; min-height: 100vh; padding: 20px; }
        .login-box { background: white; border-radius: 20px; padding: 40px; width: 100%; max-width: 400px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); text-align: center; }
        .login-logo { width: 80px; height: 80px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 50%; margin: 0 auto 20px; display: flex; align-items: center; justify-content: center; font-size: 40px; color: white; font-weight: bold; }
        .login-title { font-size: 24px; margin-bottom: 10px; color: #2c3e50; }
        .login-subtitle { color: #6c757d; margin-bottom: 30px; }

        /* IMPORT MODAL STYLES */
        .import-steps { padding: 20px; }
        .step-content { display: none; }
        .step-content.active-step { display: block; }
        .file-upload-area { border: 3px dashed #3498db; border-radius: 15px; padding: 40px; text-align: center; cursor: pointer; transition: all 0.3s; background: #f8f9fa; margin-bottom: 20px; }
        .file-upload-area:hover { background: #e9ecef; border-color: #2980b9; }
        .file-upload-icon { font-size: 60px; margin-bottom: 15px; color: #3498db; }
        .file-upload-text { font-size: 16px; color: #6c757d; margin-bottom: 5px; }
        .file-name { margin-top: 10px; padding: 10px; background: #e9ecef; border-radius: 8px; font-size: 14px; color: #495057; }
        .import-options { background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 20px; }
        .option-item { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
        .option-label { font-size: 14px; color: #495057; }
        .import-preview { max-height: 300px; overflow-y: auto; border: 1px solid #e9ecef; border-radius: 10px; margin: 15px 0; }
        .preview-table { width: 100%; border-collapse: collapse; font-size: 12px; }
        .preview-table th, .preview-table td { padding: 8px; border: 1px solid #e9ecef; text-align: left; }
        .preview-table th { background: #f8f9fa; font-weight: 600; }
        .import-stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 20px; }
        .stat-item { background: #f8f9fa; padding: 15px; border-radius: 10px; text-align: center; }
        .stat-value { font-size: 24px; font-weight: 700; margin-bottom: 5px; }
        .stat-label { font-size: 12px; color: #6c757d; }

        /* RESPONSIVE DESIGN */
        @media (max-width: 1024px) {
            .form-row { grid-template-columns: 1fr; }
            .dashboard-grid { grid-template-columns: repeat(2, 1fr); }
        }
        @media (max-width: 768px) {
            .header { flex-direction: column; text-align: center; gap: 20px; }
            .user-section { flex-direction: column; }
            .user-info { text-align: center; }
            .nav-tabs { overflow-x: auto; padding: 0 20px; }
            .tab-btn { white-space: nowrap; padding: 12px 15px; }
            .dashboard-grid { grid-template-columns: 1fr; }
            .table-tools { flex-wrap: wrap; }
            .main-content { padding: 20px; }
            .table-header { flex-direction: column; gap: 15px; text-align: center; }
            .import-stats { grid-template-columns: repeat(2, 1fr); }
        }
        @media (max-width: 480px) {
            .header { padding: 20px; }
            .title-section h1 { font-size: 22px; }
            .title-section h2 { font-size: 16px; }
            .btn { padding: 8px 12px; font-size: 14px; }
            .modal-body { padding: 15px; }
            .action-buttons { flex-direction: column; }
            .action-btn { width: 100%; }
            .import-stats { grid-template-columns: 1fr; }
        }

        /* CUSTOM SCROLLBAR */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb { background: #3498db; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #2980b9; }

        /* TOAST STYLES */
        .toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px; max-width: 350px; }
        .toast { background: white; border-radius: 10px; padding: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); display: flex; align-items: center; gap: 15px; animation: slideIn 0.3s ease-out; border-left: 5px solid; }
        .toast.success { border-left-color: #2ecc71; }
        .toast.error { border-left-color: #e74c3c; }
        .toast.warning { border-left-color: #f39c12; }
        .toast.info { border-left-color: #3498db; }
        .toast-icon { font-size: 24px; }
        .toast-content { flex: 1; }
        .toast-title { font-weight: 600; margin-bottom: 5px; color: #2c3e50; }
        .toast-message { font-size: 14px; color: #666; }
        .toast-close { cursor: pointer; font-size: 18px; color: #999; padding: 5px; }
        .toast-close:hover { color: #333; }
        @keyframes slideIn { from { opacity: 0; transform: translateX(100%); } to { opacity: 1; transform: translateX(0); } }

        /* STYLES UNTUK DATA ANAK */
        .children-section { background: #f8f9fa; border-radius: 10px; padding: 20px; margin-bottom: 20px; }
        .children-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .children-header h4 { color: #2c3e50; font-size: 16px; margin: 0; }
        .children-list { display: flex; flex-direction: column; gap: 15px; }
        .child-item { background: white; border-radius: 8px; padding: 15px; border: 1px solid #e9ecef; }
        .child-item-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .child-item-title { font-weight: 600; color: #2c3e50; }
        .child-item-remove { background: #e74c3c; color: white; border: none; width: 25px; height: 25px; border-radius: 5px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .child-item-remove:hover { background: #c0392b; }
        .btn-add-child { background: #3498db; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; display: flex; align-items: center; gap: 5px; font-size: 14px; }
        .btn-add-child:hover { background: #2980b9; }

        /* STYLES UNTUK NOMOR KK */
        .kk-info { background: #e8f4fc; border-radius: 8px; padding: 15px; margin-bottom: 20px; border-left: 4px solid #3498db; }
        .kk-info h4 { color: #2c3e50; margin-bottom: 10px; font-size: 16px; }
        .kk-format { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; text-align: center; }
        .kk-part { background: white; padding: 10px; border-radius: 5px; font-weight: 600; border: 1px solid #3498db; }
        .kk-label { font-size: 11px; color: #666; margin-top: 5px; }

        /* FAMILY TREE STYLES */
        .family-tree { font-family: monospace; line-height: 1.6; white-space: pre; }
        .family-member { padding-left: 20px; position: relative; }
        .family-member:before { content: '‚îú‚îÄ '; position: absolute; left: 0; }
        .family-member.last:before { content: '‚îî‚îÄ '; }

        /* CHART STYLES */
        .chart-container { background: white; border-radius: 15px; padding: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .chart-title { font-size: 18px; font-weight: 600; margin-bottom: 15px; color: #2c3e50; }
        .chart-wrapper { height: 300px; position: relative; }

        /* DETAIL VIEW STYLES */
        .detail-view { background: #f8f9fa; border-radius: 10px; padding: 20px; margin-bottom: 20px; }
        .detail-row { display: flex; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid #e9ecef; }
        .detail-label { font-weight: 600; width: 150px; color: #2c3e50; }
        .detail-value { flex: 1; color: #495057; }

        /* ATTENDANCE STATUS BADGES */
        .attendance-hadir { background: #d4edda; color: #155724; }
        .attendance-sakit { background: #fff3cd; color: #856404; }
        .attendance-izin { background: #d1ecf1; color: #0c5460; }
        .attendance-alfa { background: #f8d7da; color: #721c24; }

        /* --- TAMBAHAN CSS UNTUK LAPORAN & CETAK --- */
        @media print {
            body * { visibility: hidden; }
            #printArea, #printArea * { visibility: visible; }
            #printArea { position: absolute; left: 0; top: 0; width: 100%; background: white; padding: 20px; }
            .report-section { margin-bottom: 30px; border-bottom: 2px dashed #ccc; padding-bottom: 20px; }
            .page-break { page-break-after: always; display: block; }
            .btn, .no-print, .modal-close { display: none !important; }
        }

        /* Styling Tabel Laporan Standar */
        .report-table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 12px; }
        .report-table th, .report-table td { border: 1px solid #000; padding: 8px; text-align: left; }
        .report-table th { background-color: #f0f0f0; font-weight: bold; }
        .report-header { text-align: center; margin-bottom: 20px; border-bottom: 3px double #000; padding-bottom: 10px; }
    </style>
</head>
<body>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
    
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <div id="importModal" class="modal-overlay">
        <div class="modal-box">
             <div class="modal-header">
                <h3>üì• Import Data Anggota</h3>
                <div class="modal-close" onclick="closeImportModal()">√ó</div>
            </div>
            <div class="modal-body">
                <p>Fitur Import Excel...</p>
                 <div class="file-upload-area" onclick="document.getElementById('fileInput').click()" id="dropArea">
                     <div class="file-upload-icon">üìÇ</div>
                     <div class="file-upload-text">Klik untuk memilih file</div>
                 </div>
                 <input type="file" id="fileInput" style="display:none">
            </div>
             <div class="modal-footer">
                <button onclick="closeImportModal()" class="btn btn-danger">Tutup</button>
            </div>
        </div>
    </div>

    <div id="detailModal" class="modal-overlay">
        <div class="modal-box" style="max-width: 700px;">
            <div class="modal-header">
                <h3>üìã Detail Anggota</h3>
                <div class="modal-close" onclick="closeDetailModal()">√ó</div>
            </div>
            <div class="modal-body">
                <div id="detailContent"></div>
            </div>
            <div class="modal-footer">
                <button onclick="printDetail()" class="btn btn-primary">üñ®Ô∏è Cetak</button>
                <button onclick="closeDetailModal()" class="btn btn-danger">Tutup</button>
            </div>
        </div>
    </div>

    <div id="memberReportModal" class="modal-overlay">
        <div class="modal-box" style="max-width: 800px;">
            <div class="modal-header">
                <h3>üìä Laporan Data</h3>
                <div class="modal-close" onclick="closeMemberReportModal()">√ó</div>
            </div>
            <div class="modal-body">
                <div class="print-section">
                    <div id="memberReportContent"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button onclick="printMemberReport()" class="btn btn-primary">üñ®Ô∏è Cetak</button>
                <button onclick="closeMemberReportModal()" class="btn btn-danger">Tutup</button>
            </div>
        </div>
    </div>

    <div id="attendanceModal" class="modal-overlay">
        <div class="modal-box" style="max-width: 600px;">
            <div class="modal-header">
                <h3 id="attendanceModalTitle">üìù Tambah Kehadiran</h3>
                <div class="modal-close" onclick="closeAttendanceModal()">√ó</div>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="attendanceDate">Tanggal *</label>
                    <input type="date" id="attendanceDate" class="form-control" value="">
                </div>
                <div class="form-group">
                    <label for="attendanceMember">Anggota *</label>
                    <select id="attendanceMember" class="form-control">
                        <option value="">Pilih Anggota</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="attendanceStatus">Status *</label>
                    <select id="attendanceStatus" class="form-control">
                        <option value="hadir">Hadir</option>
                        <option value="sakit">Sakit</option>
                        <option value="izin">Izin</option>
                        <option value="alfa">Alfa</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="attendanceNote">Keterangan</label>
                    <textarea id="attendanceNote" class="form-control" rows="3" placeholder="Keterangan kehadiran"></textarea>
                </div>
                <input type="hidden" id="attendanceId">
            </div>
            <div class="modal-footer">
                <button onclick="closeAttendanceModal()" class="btn btn-danger">Batal</button>
                <button onclick="saveAttendance()" class="btn btn-success">Simpan</button>
            </div>
        </div>
    </div>

    <div id="financeModal" class="modal-overlay">
        <div class="modal-box" style="max-width: 600px;">
            <div class="modal-header">
                <h3 id="financeModalTitle">üí∞ Transaksi Baru</h3>
                <div class="modal-close" onclick="closeFinanceModal()">√ó</div>
            </div>
            <div class="modal-body">
                <div class="form-row">
                    <div class="form-group">
                        <label for="financeDate">Tanggal *</label>
                        <input type="date" id="financeDate" class="form-control" value="">
                    </div>
                    <div class="form-group">
                        <label for="financeType">Jenis *</label>
                        <select id="financeType" class="form-control">
                            <option value="pemasukan">Pemasukan</option>
                            <option value="pengeluaran">Pengeluaran</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label for="financeCategory">Kategori *</label>
                    <select id="financeCategory" class="form-control">
                        <option value="">Pilih Kategori</option>
                        <option value="iuran">Iuran Anggota</option>
                        <option value="donasi">Donasi</option>
                        <option value="kegiatan">Kegiatan</option>
                        <option value="administrasi">Administrasi</option>
                        <option value="lainnya">Lainnya</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="financeAmount">Jumlah (Rp) *</label>
                    <input type="number" id="financeAmount" class="form-control" placeholder="0" min="0">
                </div>
                <div class="form-group">
                    <label for="financeDescription">Keterangan *</label>
                    <textarea id="financeDescription" class="form-control" rows="3" placeholder="Deskripsi transaksi" required></textarea>
                </div>
                <input type="hidden" id="financeId">
            </div>
            <div class="modal-footer">
                <button onclick="closeFinanceModal()" class="btn btn-danger">Batal</button>
                <button onclick="saveFinance()" class="btn btn-success">Simpan</button>
            </div>
        </div>
    </div>

    <div id="userModal" class="modal-overlay">
        <div class="modal-box" style="max-width: 500px;">
            <div class="modal-header">
                <h3 id="userModalTitle">üë§ Tambah Pengguna Baru</h3>
                <div class="modal-close" onclick="closeUserModal()">√ó</div>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="userUsername">Username *</label>
                    <input type="text" id="userUsername" class="form-control" placeholder="Username untuk login" required>
                </div>
                <div class="form-group">
                    <label for="userPassword">Password *</label>
                    <input type="password" id="userPassword" class="form-control" placeholder="Password (Kosongkan jika tidak ingin mengubah)">
                </div>
                <div class="form-group">
                    <label for="userFullName">Nama Lengkap *</label>
                    <input type="text" id="userFullName" class="form-control" placeholder="Nama lengkap pengguna" required>
                </div>
                <div class="form-group">
                    <label for="userRole">Role *</label>
                    <select id="userRole" class="form-control">
                        <option value="admin">Administrator - Akses Penuh</option>
                        <option value="manager">Manager - Mengelola Data & Laporan</option>
                        <option value="supervisor">Supervisor - Mengelola Data Anggota</option>
                        <option value="user" selected>Pengguna Biasa - Hanya Melihat Data</option>
                    </select>
                </div>
                <input type="hidden" id="userId">
            </div>
            <div class="modal-footer">
                <button onclick="closeUserModal()" class="btn btn-danger">Batal</button>
                <button onclick="saveUser()" class="btn btn-success">Simpan</button>
            </div>
        </div>
    </div>

    <div id="financeReportModal" class="modal-overlay">
        <div class="modal-box" style="max-width: 900px;">
            <div class="modal-header">
                <h3>üìà Laporan Keuangan</h3>
                <div class="modal-close" onclick="closeFinanceReportModal()">√ó</div>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 20px;">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="reportStartDate">Dari Tanggal</label>
                            <input type="date" id="reportStartDate" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="reportEndDate">Sampai Tanggal</label>
                            <input type="date" id="reportEndDate" class="form-control">
                        </div>
                    </div>
                    <button onclick="generateFinanceReport()" class="btn btn-primary">üîÑ Generate Laporan</button>
                </div>
                <div id="financeReportContent"></div>
            </div>
            <div class="modal-footer">
                <button onclick="printFinanceReport()" class="btn btn-primary">üñ®Ô∏è Cetak</button>
                <button onclick="closeFinanceReportModal()" class="btn btn-danger">Tutup</button>
            </div>
        </div>
    </div>

    <div id="loginPage" class="login-container">
        <div class="login-box">
            <div class="login-logo">‚õ™</div>
            <h2 class="login-title">Girsang Boru Panagolan</h2>
            <p class="login-subtitle">Management System Tangerang</p>
            <div class="form-group">
                <label for="username">Username</label>
                <input type="text" id="username" class="form-control" placeholder="Masukkan username" value="admin">
            </div>
            <div class="form-group">
                <label for="password">Password</label>
                <input type="password" id="password" class="form-control" placeholder="Masukkan password" value="admin123">
            </div>
            <button onclick="login()" class="btn btn-primary" style="width: 100%; margin-top: 20px;">üîì Login</button>
            <div style="margin-top: 20px; font-size: 12px; color: #666;">
                <p>Default login: <strong>admin</strong> / <strong>admin123</strong></p>
            </div>
        </div>
    </div>

    <div id="app" class="container" style="display: none;">
        <div class="header">
            <div class="logo-section">
                <div class="logo">‚õ™</div>
                <div class="title-section">
                    <h1>Girsang Boru Panagolan Tangerang</h1>
                    <h2>Management System</h2>
                </div>
            </div>
            <div class="user-section">
                <div class="user-info">
                    <div class="user-name" id="userDisplayName">User</div>
                    <div class="user-role" id="userRoleBadge">Role</div>
                    <div class="connection-status">
                        <span class="status-indicator" id="statusIndicator"></span>
                        <span id="connectionText">Sedang menyinkronkan...</span>
                    </div>
                </div>
                <button onclick="logout()" class="btn-logout"><span>üîì Logout</span></button>
            </div>
        </div>
        
        <div class="nav-tabs">
            <button class="tab-btn active" onclick="switchTab('dashboard')">üìä Dashboard</button>
            <button class="tab-btn" onclick="switchTab('members')">üë• Anggota</button>
            <button class="tab-btn" onclick="switchTab('attendance')">üìù Kehadiran</button>
            <button class="tab-btn" onclick="switchTab('finance')">üí∞ Keuangan</button>
            <button class="tab-btn" onclick="switchTab('reports')">üìà Laporan</button>
            <button class="tab-btn" onclick="switchTab('users')" id="adminTab" style="display: none;">üë§ Admin</button>
        </div>
        
        <div class="main-content">
            <div id="dashboard" class="tab-content active">
                <h2>üè† Dashboard Utama</h2>
                <div class="dashboard-grid">
                     <div class="stat-card total"><div class="stat-value" id="totalMembers">0</div><div class="stat-label">Total Anggota</div></div>
                     <div class="stat-card active"><div class="stat-value" id="activeMembers">0</div><div class="stat-label">Anggota Aktif</div></div>
                </div>
            </div>
            
            <div id="members" class="tab-content">
                <div class="table-header">
                    <h3>üë• Data Anggota</h3>
                    <div class="table-tools">
                        <button onclick="showAddMemberForm()" class="btn btn-success">‚ûï Tambah</button>
                        <button onclick="showImportModal()" class="btn btn-primary">üì• Import</button>
                    </div>
                </div>
                <div class="search-box">
                    <input type="text" id="searchMember" class="search-input" placeholder="üîç Cari..." onkeyup="filterMembers()">
                </div>
                <div class="table-wrapper">
                    <table>
                        <thead><tr><th>No</th><th>Nama & KK</th><th>Alamat</th><th>No HP</th><th>Aksi</th></tr></thead>
                        <tbody id="membersTable"></tbody>
                    </table>
                </div>
            </div>
            
            <div id="attendance" class="tab-content">
                <div class="table-header">
                    <h3>üìù Data Kehadiran</h3>
                    <div class="table-tools">
                        <button onclick="showAddAttendanceForm()" class="btn btn-success">‚ûï Tambah</button>
                    </div>
                </div>
                <div class="table-wrapper">
                    <tbody id="attendanceTable"></tbody>
                </div>
            </div>
            
            <div id="finance" class="tab-content">
                <div class="table-header">
                    <h3>üí∞ Data Keuangan</h3>
                    <div class="table-tools">
                        <button onclick="showAddFinanceForm()" class="btn btn-success">‚ûï Transaksi Baru</button>
                        <button onclick="showFinanceReport()" class="btn btn-primary">üìà Laporan</button>
                    </div>
                </div>
                 <div class="dashboard-grid">
                     <div class="stat-card"><div class="stat-value" id="totalBalance">Rp 0</div><div class="stat-label">Saldo</div></div>
                 </div>
                <div class="table-wrapper">
                    <table>
                        <thead><tr><th>Tanggal</th><th>Jenis</th><th>Jml</th><th>Ket</th><th>Aksi</th></tr></thead>
                        <tbody id="financeTable"></tbody>
                    </table>
                </div>
            </div>
            
            <div id="reports" class="tab-content">
                <div class="table-header">
                    <h3>üìà Laporan & Analisis</h3>
                    <div class="table-tools">
                        <button onclick="generateMemberReport()" class="btn btn-primary">üìä Laporan Anggota</button>
                        <button onclick="generateFamilyHierarchyReport()" class="btn btn-success">üå≥ Laporan Keluarga</button>
                        <button onclick="generateAttendanceReport()" class="btn btn-warning">üìù Laporan Kehadiran</button>
                        <button onclick="showFinanceReport()" class="btn btn-export">üí∞ Laporan Keuangan</button>
                        <button onclick="printAllReports()" class="btn btn-warning">üñ®Ô∏è Cetak Semua</button>
                    </div>
                </div>
                </div>
            
            <div id="users" class="tab-content">
                <div class="table-header">
                    <h3>üë§ Manajemen Pengguna</h3>
                    <div class="table-tools">
                        <button onclick="showAddUserForm()" class="btn btn-success">‚ûï Tambah Pengguna</button>
                    </div>
                </div>
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>Username</th>
                                <th>Role</th>
                                <th>Tanggal Dibuat</th>
                                <th>Status</th>
                                <th>Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="usersTable"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="memberModal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header">
                <h3 id="memberModalTitle">Tambah Anggota Baru</h3>
                <div class="modal-close" onclick="closeMemberModal()">√ó</div>
            </div>
            <div class="modal-body">
                <div class="form-group"><label>Nomor KK</label><input type="text" id="memberNoKep" class="form-control"></div>
                <div class="form-group"><label>Nama</label><input type="text" id="memberName" class="form-control"></div>
                <div class="form-group"><label>Tanggal Lahir</label><input type="date" id="memberBirthDate" class="form-control"></div>
                <div class="form-group"><label>No HP</label><input type="text" id="memberPhone" class="form-control"></div>
                <div class="form-group"><label>Alamat</label><textarea id="memberAddress" class="form-control"></textarea></div>
                <div class="form-group">
                    <label>Jabatan</label>
                    <select id="memberPosition" class="form-control"><option>Anggota</option><option>Ketua</option></select>
                </div>
                <div class="form-group">
                    <label>Status</label>
                    <select id="memberStatus" class="form-control"><option value="aktif">Aktif</option><option value="nonaktif">Nonaktif</option></select>
                </div>
                
                <div class="children-section">
                    <div class="children-header">
                         <h4>üë∂ Data Anak</h4>
                         <button type="button" class="btn-add-child" onclick="addChildField()">‚ûï Tambah</button>
                    </div>
                    <div class="children-list" id="childrenList"></div>
                </div>
                <input type="hidden" id="memberId">
            </div>
            <div class="modal-footer">
                <button onclick="closeMemberModal()" class="btn btn-danger">Batal</button>
                <button onclick="saveMember()" class="btn btn-success">Simpan</button>
            </div>
        </div>
    </div>

    <div class="toast-container" id="toastContainer"></div>

    <script>
        // ==================== KONFIGURASI FIREBASE ====================
        const firebaseConfig = {
            apiKey: "AIzaSyCqF5VG2T03yaHOAq8dPhtvgMYrbVq-DIs",
            authDomain: "girsangborupanagolantangerang.firebaseapp.com",
            databaseURL: "https://girsangborupanagolantangerang-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "girsangborupanagolantangerang",
            storageBucket: "girsangborupanagolantangerang.firebasestorage.app",
            messagingSenderId: "823404152768",
            appId: "1:823404152768:web:c743fa07b22455452b2a25",
            measurementId: "G-716P2TK99Y"
        };

        // Inisialisasi Firebase
        let firebaseApp, db, auth;
        try {
            firebaseApp = firebase.initializeApp(firebaseConfig);
            db = firebase.database();
            auth = firebase.auth();
            console.log("üî• Firebase berhasil diinisialisasi");
            updateConnectionStatus(true);
        } catch (error) {
            console.error("‚ùå Error inisialisasi Firebase:", error);
            updateConnectionStatus(false);
        }

        // ==================== VARIABEL GLOBAL ====================
        let currentUser = {username: '', role: 'user'};
        let members = [], attendance = [], finance = [], users = [];
        let appInitialized = false;
        let childCounter = 0;
        let currentChart = null;

        // Default users
        const defaultUsers = [
            {firebaseKey: 'admin', username: 'admin', password: 'admin123', role: 'admin', fullName: 'Administrator', createdAt: Date.now()},
            {firebaseKey: 'user1', username: 'user1', password: 'user123', role: 'user', fullName: 'Pengguna Biasa', createdAt: Date.now()},
            {firebaseKey: 'manager', username: 'manager', password: 'manager123', role: 'manager', fullName: 'Manager', createdAt: Date.now()}
        ];

        // ==================== FUNGSI UTAMA YANG DIPERBAIKI ====================

        // PERBAIKAN 1, 2, 3: Fungsi menutup Laporan Anggota/Keluarga/Kehadiran
        function closeMemberReportModal() {
            document.getElementById('memberReportModal').style.display = 'none';
        }

        // PERBAIKAN 4: Fungsi membuka & menutup Laporan Keuangan
        function showFinanceReport() {
            // Reset tanggal filter ke kosong atau default
            document.getElementById('reportStartDate').value = '';
            document.getElementById('reportEndDate').value = '';
            // Tampilkan modal
            document.getElementById('financeReportModal').style.display = 'flex';
            // Bersihkan konten sebelumnya
            document.getElementById('financeReportContent').innerHTML = '<div style="text-align:center; padding:20px; color:#666">Silakan pilih tanggal dan klik Generate Laporan</div>';
        }

        function closeFinanceReportModal() {
            document.getElementById('financeReportModal').style.display = 'none';
        }

        // PERBAIKAN 5: Fitur Reset Password
        async function resetUserPassword(firebaseKey) {
            if (currentUser.role !== 'admin') {
                showToast('error', 'Akses Ditolak', 'Hanya Admin yang bisa mereset password.');
                return;
            }

            const userToReset = users.find(u => u.firebaseKey === firebaseKey);
            if (!userToReset) return;

            const newPassword = prompt(`Masukkan password baru untuk user ${userToReset.username}:`);
            
            if (newPassword !== null && newPassword.trim() !== "") {
                try {
                    await db.ref(`users/${firebaseKey}`).update({
                        password: newPassword,
                        updatedBy: currentUser.username,
                        updatedAt: Date.now()
                    });
                    showToast('success', 'Berhasil', `Password untuk ${userToReset.username} berhasil direset.`);
                } catch (error) {
                    showToast('error', 'Gagal', 'Gagal mereset password: ' + error.message);
                }
            }
        }

        // ==================== FUNGSI STANDAR LAINNYA ====================

        function showToast(type, title, message) {
            const toastContainer = document.getElementById('toastContainer');
            const toastId = 'toast_' + Date.now();
            const iconMap = { success: '‚úÖ', error: '‚ùå', warning: '‚ö†Ô∏è', info: '‚ÑπÔ∏è' };
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.id = toastId;
            toast.innerHTML = `<div class="toast-icon">${iconMap[type]}</div><div class="toast-content"><div class="toast-title">${title}</div><div class="toast-message">${message}</div></div><div class="toast-close" onclick="document.getElementById('${toastId}').remove()">√ó</div>`;
            toastContainer.appendChild(toast);
            setTimeout(() => { if(document.getElementById(toastId)) document.getElementById(toastId).remove(); }, 5000);
        }

        function updateConnectionStatus(isConnected) {
            const indicator = document.getElementById('statusIndicator');
            const text = document.getElementById('connectionText');
            if (isConnected) { indicator.className = 'status-indicator status-online'; text.textContent = 'Terhubung ke Firebase'; } 
            else { indicator.className = 'status-indicator status-offline'; text.textContent = 'Koneksi terputus'; }
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            if (tabName === 'dashboard') updateDashboard();
            if (tabName === 'finance') updateFinanceSummary();
            if (tabName === 'reports') updateReports();
        }

        function login() {
            const u = document.getElementById('username').value.trim();
            const p = document.getElementById('password').value.trim();
            let userFound = defaultUsers.find(user => user.username === u && user.password === p);
            if (!userFound && users.length > 0) userFound = users.find(user => user.username === u && user.password === p);
            
            if (userFound) {
                currentUser = userFound;
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                document.getElementById('loginPage').style.display = 'none';
                document.getElementById('app').style.display = 'block';
                initializeApp();
            } else {
                showToast('error', 'Login Gagal', 'Username atau password salah.');
            }
        }

        function logout() {
            currentUser = {username: '', role: 'user'};
            localStorage.removeItem('currentUser');
            document.getElementById('loginPage').style.display = 'flex';
            document.getElementById('app').style.display = 'none';
        }

        async function initializeApp() {
            document.getElementById('userDisplayName').textContent = currentUser.username;
            document.getElementById('userRoleBadge').textContent = currentUser.role.toUpperCase();
            if(currentUser.role === 'admin') document.getElementById('adminTab').style.display = 'flex';
            
            await loadAllData();
            setupFirebaseListeners();
            appInitialized = true;
        }

        async function loadAllData() {
            // Load members
            db.ref('members').once('value', s => { 
                const d = s.val(); 
                members = d ? Object.keys(d).map(k => ({firebaseKey: k, ...d[k]})) : []; 
                renderMembersTable(); updateDashboard();
            });
            // Load attendance
            db.ref('attendance').once('value', s => { 
                const d = s.val(); 
                attendance = d ? Object.keys(d).map(k => ({firebaseKey: k, ...d[k]})) : []; 
                renderAttendanceTable();
            });
            // Load finance
            db.ref('finance').once('value', s => { 
                const d = s.val(); 
                finance = d ? Object.keys(d).map(k => ({firebaseKey: k, ...d[k]})) : []; 
                renderFinanceTable(); updateFinanceSummary();
            });
            // Load users
            db.ref('users').once('value', s => { 
                const d = s.val(); 
                users = d ? Object.keys(d).map(k => ({firebaseKey: k, ...d[k]})) : defaultUsers; 
                renderUsersTable();
            });
        }

        function setupFirebaseListeners() {
            db.ref('members').on('value', s => { const d = s.val(); members = d ? Object.keys(d).map(k => ({firebaseKey: k, ...d[k]})) : []; renderMembersTable(); });
            db.ref('attendance').on('value', s => { const d = s.val(); attendance = d ? Object.keys(d).map(k => ({firebaseKey: k, ...d[k]})) : []; renderAttendanceTable(); });
            db.ref('finance').on('value', s => { const d = s.val(); finance = d ? Object.keys(d).map(k => ({firebaseKey: k, ...d[k]})) : []; renderFinanceTable(); updateFinanceSummary(); });
            db.ref('users').on('value', s => { const d = s.val(); users = d ? Object.keys(d).map(k => ({firebaseKey: k, ...d[k]})) : []; renderUsersTable(); });
        }

        // --- Render Functions (Simplified for Fix focus) ---
        function renderMembersTable() {
            const tbody = document.getElementById('membersTable'); tbody.innerHTML = '';
            members.forEach((m, i) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${i+1}</td><td><strong>${m.nama}</strong><br><small>${m.no_kep||''}</small></td><td>${m.alamat||'-'}</td><td>${m.no_hp||'-'}</td>
                <td>
                    <button class="action-btn edit" onclick="showEditMemberForm('${m.firebaseKey}')">‚úèÔ∏è</button>
                    <button class="action-btn delete" onclick="deleteMember('${m.firebaseKey}')">üóëÔ∏è</button>
                </td>`;
                tbody.appendChild(tr);
            });
        }

        function renderUsersTable() {
            const tbody = document.getElementById('usersTable');
            tbody.innerHTML = '';
            users.forEach(user => {
                const tr = document.createElement('tr');
                // PERBAIKAN: Menambahkan tombol Reset Password (üîë)
                const resetBtn = currentUser.role === 'admin' ? 
                    `<button onclick="resetUserPassword('${user.firebaseKey}')" class="action-btn reset" title="Reset Password">üîë</button>` : '';
                
                tr.innerHTML = `
                    <td><strong>${user.username}</strong><br><small>${user.fullName}</small></td>
                    <td>${user.role}</td>
                    <td>${new Date(user.createdAt).toLocaleDateString()}</td>
                    <td><span class="status-badge status-aktif">Aktif</span></td>
                    <td><div class="action-buttons">
                        ${resetBtn}
                        <button onclick="showEditUserForm('${user.firebaseKey}')" class="action-btn edit">‚úèÔ∏è</button>
                        <button onclick="deleteUser('${user.firebaseKey}')" class="action-btn delete">üóëÔ∏è</button>
                    </div></td>
                `;
                tbody.appendChild(tr);
            });
        }

        function renderFinanceTable() {
             const tbody = document.getElementById('financeTable'); tbody.innerHTML = '';
             finance.sort((a,b)=>new Date(b.date)-new Date(a.date)).forEach(f => {
                 const tr = document.createElement('tr');
                 tr.innerHTML = `<td>${f.date}</td><td>${f.type}</td><td>Rp ${parseInt(f.amount).toLocaleString()}</td><td>${f.description}</td><td><button class="action-btn delete" onclick="deleteFinance('${f.firebaseKey}')">üóëÔ∏è</button></td>`;
                 tbody.appendChild(tr);
             });
        }

        function renderAttendanceTable() {
            const tbody = document.getElementById('attendanceTable'); tbody.innerHTML = '';
            attendance.sort((a,b)=>new Date(b.date)-new Date(a.date)).forEach(a => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${a.date}</td><td>${a.memberName}</td><td>${a.status}</td><td>${a.note||'-'}</td><td><button class="action-btn delete" onclick="deleteAttendance('${a.firebaseKey}')">üóëÔ∏è</button></td>`;
                tbody.appendChild(tr);
            });
        }

        // --- CRUD Helper Functions (Shortened) ---
        function showAddMemberForm() { document.getElementById('memberModal').style.display = 'flex'; document.getElementById('memberId').value=''; document.getElementById('memberName').value=''; }
        function showEditMemberForm(k) { const m = members.find(x=>x.firebaseKey===k); if(m){document.getElementById('memberId').value=k; document.getElementById('memberName').value=m.nama; document.getElementById('memberNoKep').value=m.no_kep; document.getElementById('memberModal').style.display='flex';} }
        function closeMemberModal() { document.getElementById('memberModal').style.display = 'none'; }
        async function saveMember() { 
            const k = document.getElementById('memberId').value;
            const data = { nama: document.getElementById('memberName').value, no_kep: document.getElementById('memberNoKep').value, alamat: document.getElementById('memberAddress').value, no_hp: document.getElementById('memberPhone').value, status: document.getElementById('memberStatus').value };
            if(k) await db.ref('members/'+k).update(data); else await db.ref('members').push(data);
            closeMemberModal();
        }
        async function deleteMember(k) { if(confirm('Hapus?')) await db.ref('members/'+k).remove(); }

        function showAddUserForm() { document.getElementById('userModal').style.display = 'flex'; }
        function closeUserModal() { document.getElementById('userModal').style.display = 'none'; }
        async function saveUser() {
             const k = document.getElementById('userId').value;
             const p = document.getElementById('userPassword').value;
             const data = { username: document.getElementById('userUsername').value, fullName: document.getElementById('userFullName').value, role: document.getElementById('userRole').value };
             if(p) data.password = p; // Hanya update password jika diisi
             if(!k && !p) { alert('Password wajib untuk user baru'); return; }
             
             if(k) await db.ref('users/'+k).update(data); else { data.createdAt = Date.now(); await db.ref('users').push(data); }
             closeUserModal();
        }
        function showEditUserForm(k) {
             const u = users.find(x=>x.firebaseKey===k);
             document.getElementById('userId').value = k;
             document.getElementById('userUsername').value = u.username;
             document.getElementById('userFullName').value = u.fullName;
             document.getElementById('userRole').value = u.role;
             document.getElementById('userPassword').value = ''; // Kosongkan password saat edit
             document.getElementById('userModal').style.display = 'flex';
        }
        async function deleteUser(k) { if(confirm('Hapus user ini?')) await db.ref('users/'+k).remove(); }

        function showAddFinanceForm() { document.getElementById('financeModal').style.display = 'flex'; }
        function closeFinanceModal() { document.getElementById('financeModal').style.display = 'none'; }
        async function saveFinance() {
             await db.ref('finance').push({
                 date: document.getElementById('financeDate').value,
                 type: document.getElementById('financeType').value,
                 category: document.getElementById('financeCategory').value,
                 amount: document.getElementById('financeAmount').value,
                 description: document.getElementById('financeDescription').value
             });
             closeFinanceModal();
        }
        async function deleteFinance(k) { if(confirm('Hapus transaksi?')) await db.ref('finance/'+k).remove(); }

        function showAddAttendanceForm() { populateMemberSelect(); document.getElementById('attendanceModal').style.display = 'flex'; }
        function closeAttendanceModal() { document.getElementById('attendanceModal').style.display = 'none'; }
        async function saveAttendance() {
             const mId = document.getElementById('attendanceMember').value;
             const m = members.find(x=>x.firebaseKey===mId);
             await db.ref('attendance').push({
                 date: document.getElementById('attendanceDate').value,
                 memberId: mId, memberName: m.nama,
                 status: document.getElementById('attendanceStatus').value,
                 note: document.getElementById('attendanceNote').value
             });
             closeAttendanceModal();
        }
        function populateMemberSelect() {
             const s = document.getElementById('attendanceMember'); s.innerHTML='<option value="">Pilih</option>';
             members.filter(m=>m.status==='aktif').forEach(m => { const o=document.createElement('option'); o.value=m.firebaseKey; o.textContent=m.nama; s.appendChild(o); });
        }
        async function deleteAttendance(k) { if(confirm('Hapus?')) await db.ref('attendance/'+k).remove(); }

        // --- Report Generation Functions ---
        function generateMemberReport() {
            let html = '<h3 style="text-align:center">Laporan Anggota</h3><table class="report-table"><thead><tr><th>No</th><th>Nama</th><th>Alamat</th><th>Status</th></tr></thead><tbody>';
            members.forEach((m,i) => html += `<tr><td>${i+1}</td><td>${m.nama}</td><td>${m.alamat}</td><td>${m.status}</td></tr>`);
            html += '</tbody></table>';
            document.getElementById('memberReportContent').innerHTML = html;
            document.getElementById('memberReportModal').style.display = 'flex';
        }

        function generateAttendanceReport() {
             let html = '<h3 style="text-align:center">Laporan Kehadiran</h3><table class="report-table"><thead><tr><th>Tanggal</th><th>Nama</th><th>Status</th></tr></thead><tbody>';
             attendance.forEach(a => html += `<tr><td>${a.date}</td><td>${a.memberName}</td><td>${a.status}</td></tr>`);
             html += '</tbody></table>';
             document.getElementById('memberReportContent').innerHTML = html; // Reusing modal body
             document.getElementById('memberReportModal').style.display = 'flex';
        }

        function generateFinanceReport() {
             const start = document.getElementById('reportStartDate').value;
             const end = document.getElementById('reportEndDate').value;
             let data = finance;
             if(start && end) data = finance.filter(f => f.date >= start && f.date <= end);

             let html = '<h3 style="text-align:center">Laporan Keuangan</h3><table class="report-table"><thead><tr><th>Tanggal</th><th>Jenis</th><th>Nominal</th><th>Ket</th></tr></thead><tbody>';
             let total = 0;
             data.forEach(f => {
                 total += (f.type==='pemasukan'?1:-1) * parseInt(f.amount);
                 html += `<tr><td>${f.date}</td><td>${f.type}</td><td>${parseInt(f.amount).toLocaleString()}</td><td>${f.description}</td></tr>`;
             });
             html += `</tbody></table><h4 style="text-align:right">Saldo Periode: Rp ${total.toLocaleString()}</h4>`;
             document.getElementById('financeReportContent').innerHTML = html;
        }

        // Print functions
        function printMemberReport() { 
            const content = document.getElementById('memberReportContent').innerHTML;
            document.body.innerHTML = content; window.print(); location.reload(); 
        }
        function printFinanceReport() { 
            const content = document.getElementById('financeReportContent').innerHTML;
            document.body.innerHTML = content; window.print(); location.reload(); 
        }
        function printDetail() { window.print(); }
        function printAllReports() { alert('Fitur cetak semua akan mencetak halaman ini.'); window.print(); }

        // Init
        window.onload = function() {
            if(localStorage.getItem('currentUser')) {
                currentUser = JSON.parse(localStorage.getItem('currentUser'));
                document.getElementById('loginPage').style.display='none';
                document.getElementById('app').style.display='block';
                initializeApp();
            }
        };

        // Dashboard & Summary Updates
        function updateDashboard() {
            document.getElementById('totalMembers').textContent = members.length;
            document.getElementById('activeMembers').textContent = members.filter(m=>m.status==='aktif').length;
        }
        function updateFinanceSummary() {
            let bal = 0; finance.forEach(f => bal += (f.type==='pemasukan'?1:-1)*parseInt(f.amount));
            document.getElementById('totalBalance').textContent = 'Rp ' + bal.toLocaleString();
        }
        function updateReports() {} 
        function showImportModal() { document.getElementById('importModal').style.display='flex'; }
        function closeImportModal() { document.getElementById('importModal').style.display='none'; }
        function closeDetailModal() { document.getElementById('detailModal').style.display='none'; }
        function generateFamilyHierarchyReport() { generateMemberReport(); } // Placeholder reuse
    </script>
</body>
</html>
