<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üèõÔ∏è Girsang Boru Panagolan Tangerang - Management System</title>
    <style>
        *{margin:0;padding:0;box-sizing:border-box;}
        body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:#f8f9fa;color:#333;}
        .header{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;padding:20px;text-align:center;box-shadow:0 2px 10px rgba(0,0,0,0.1);position:relative;}
        .header h1{font-size:24px;margin:0;font-weight:600;}
        .header p{font-size:14px;opacity:0.9;margin-top:5px;}
        .close-btn-logout{position:absolute;top:20px;right:20px;cursor:pointer;font-size:24px;background:rgba(255,255,255,0.2);width:40px;height:40px;line-height:40px;border-radius:50%;}

        .status-indicator{position:absolute;top:20px;left:20px;display:flex;align-items:center;gap:5px;font-size:12px;}
        .status-dot{width:8px;height:8px;border-radius:50%;background:#28a745;}
        .status-offline{background:#dc3545;}
        .status-syncing{background:#ffc107;animation:pulse 1.5s infinite;}
        .status-admin-only{background:#17a2b8;color:white;}

        @keyframes pulse{0%,100%{opacity:1;}50%{opacity:0.5;}}

        .navbar{background:#fff;padding:15px;box-shadow:0 2px 5px rgba(0,0,0,0.1);position:sticky;top:0;z-index:100;overflow-x:auto;}
        .nav-links{display:flex;justify-content:center;gap:15px;white-space:nowrap;min-width:max-content;}
        .nav-links a{color:#495057;text-decoration:none;font-weight:500;padding:8px 16px;border-radius:20px;transition:all 0.3s;cursor:pointer;font-size:14px;}
        .nav-links a:hover,.nav-links a.active{background:#667eea;color:white;}

        .container{max-width:1200px;margin:20px auto;padding:0 15px;}

        .stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:15px;margin-bottom:20px;}
        .stat-card{background:white;padding:20px;border-radius:12px;box-shadow:0 4px 6px rgba(0,0,0,0.05);text-align:center;}
        .stat-number{font-size:28px;font-weight:bold;color:#667eea;margin-bottom:5px;}
        .stat-label{color:#666;font-size:12px;text-transform:uppercase;letter-spacing:1px;}

        .section{background:white;margin-bottom:30px;border-radius:12px;overflow:hidden;box-shadow:0 4px 6px rgba(0,0,0,0.05);display:none;animation:fadeIn 0.5s;}
        .section.active{display:block;}
        @keyframes fadeIn{from{opacity:0;transform:translateY(10px);}to{opacity:1;transform:translateY(0);}}

        .section-header{padding:20px;background:linear-gradient(135deg,#f093fb 0%,#f5576c 100%);color:white;position:relative;}
        .section-header.admin-only::after{content:'üëë ADMIN ONLY';position:absolute;right:20px;top:50%;transform:translateY(-50%);font-size:12px;background:#17a2b8;padding:4px 8px;border-radius:12px;}
        .section-header h2{font-size:18px;margin:0;}
        .section-content{padding:20px;}

        .form-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin-bottom:20px;background:#f8f9fa;padding:20px;border-radius:10px;}
        input,select,textarea{width:100%;padding:10px;border:1px solid #ced4da;border-radius:6px;font-size:14px;}
        input:focus,select:focus{outline:none;border-color:#667eea;box-shadow:0 0 0 3px rgba(102,126,234,0.1);}

        .btn{padding:10px 20px;border:none;border-radius:6px;cursor:pointer;font-size:14px;font-weight:600;transition:0.3s;width:100%;}
        .btn-primary{background:#667eea;color:white;}
        .btn-primary:hover{background:#5a6fd6;}
        .btn-danger{background:#ff6b6b;color:white;}
        .btn-success{background:#28a745;color:white;}
        .btn-sync{background:#17a2b8;color:white;margin-top:10px;}
        .btn-sync:hover{background:#138496;}
        .btn-admin{background:#ffc107;color:#212529;font-weight:bold;}

        .table-responsive{overflow-x:auto;}
        table{width:100%;border-collapse:collapse;font-size:14px;}
        th{padding:12px;background:#f1f3f5;color:#495057;text-align:left;font-weight:600;}
        td{padding:12px;border-bottom:1px solid #dee2e6;}
        tr:last-child td{border-bottom:none;}

        .status-badge{padding:4px 10px;border-radius:12px;font-size:11px;font-weight:600;text-transform:uppercase;}
        .status-aktif{background:#d4edda;color:#155724;}
        .status-nonaktif{background:#f8d7da;color:#721c24;}
        .status-admin{background:#17a2b8;color:white;}
        .money-plus{color:#28a745;font-weight:bold;}
        .money-minus{color:#dc3545;font-weight:bold;}

        .login-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:#f8f9fa;display:flex;align-items:center;justify-content:center;z-index:2000;}
        .login-box{background:white;padding:40px;border-radius:20px;width:90%;max-width:350px;box-shadow:0 10px 25px rgba(0,0,0,0.1);text-align:center;}

        .user-info{display:flex;align-items:center;gap:10px;background:#e9ecef;padding:10px;border-radius:8px;margin-bottom:15px;}
        .user-role-badge{padding:4px 12px;border-radius:20px;font-size:12px;font-weight:600;}
        .role-admin{background:#17a2b8;color:white;}
        .role-user{background:#6c757d;color:white;}

        .users-section{background:#f8f9fa;padding:20px;border-radius:12px;margin-bottom:20px;}
        .user-row{display:flex;align-items:center;justify-content:space-between;padding:12px;background:white;margin-bottom:8px;border-radius:8px;box-shadow:0 2px 4px rgba(0,0,0,0.05);}
        .user-actions{display:flex;gap:5px;}
        .btn-sm{padding:6px 12px;font-size:12px;}

        .hidden{display:none !important;}

        @media(max-width:768px){.nav-links{justify-content:flex-start;padding-bottom:5px;}.btn{width:100% !important;}.user-row{flex-direction:column;gap:10px;text-align:center;}}
    </style>
</head>
<body>
    <!-- üî• FIREBASE SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

    <div id="loginOverlay" class="login-overlay">
        <div class="login-box">
            <h2 style="color:#667eea;margin-bottom:10px;">üèõÔ∏è Sistem Manajemen</h2>
            <p style="color:#666;margin-bottom:30px;font-size:14px;">Girsang Boru Panagolan Tangerang</p>
            <input type="text" id="username" placeholder="Username" style="margin-bottom:10px;">
            <input type="password" id="password" placeholder="Password" style="margin-bottom:20px;">
            <button onclick="login()" class="btn btn-primary">Masuk</button>
            <p style="margin-top:20px;font-size:12px;color:#aaa;">
                Admin: <strong>admin</strong> / <strong>admin123</strong><br>
                User: <strong>user1</strong> / <strong>user123</strong>
            </p>
        </div>
    </div>

    <div class="header" id="header" style="display:none;">
        <div class="status-indicator" id="statusIndicator">
            <div class="status-dot" id="statusDot"></div>
            <span id="statusText">Memuat...</span>
        </div>
        <h1>üèõÔ∏è Girsang Boru Panagolan</h1>
        <p id="headerSubtitle">Dashboard Manajemen & Keuangan</p>
        <div class="close-btn-logout" onclick="logout()" title="Keluar">‚èª</div>
    </div>

    <nav class="navbar" id="navbar" style="display:none;">
        <div class="nav-links">
            <a onclick="showSection('dashboard', this)" class="active">üìä Dashboard</a>
            <a onclick="showSection('members', this)">üë• Anggota</a>
            <a onclick="showSection('attendance', this)">üìã Absensi</a>
            <a onclick="showSection('finance', this)">üí∞ Keuangan</a>
            <a id="usersNav" onclick="showSection('users', this)" style="display:none;">üë®‚Äçüíº Pengguna</a>
        </div>
    </nav>

    <div class="container" id="mainContainer" style="display:none;">
        <!-- User Info Bar -->
        <div id="userInfoBar" class="user-info hidden">
            <span>üë§ <strong id="currentUsername"></strong></span>
            <span class="user-role-badge" id="currentRole"></span>
            <button id="switchUserBtn" onclick="showLoginOverlay()" class="btn btn-sm btn-primary">Ganti User</button>
        </div>

        <section class="section active" id="dashboard">
            <div class="section-header"><h2>üìä Ringkasan Data</h2></div>
            <div class="section-content">
                <div class="stats">
                    <div class="stat-card">
                        <div class="stat-number" id="activeMembers">0</div>
                        <div class="stat-label">Anggota Aktif</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="todayAttendance">0</div>
                        <div class="stat-label">Hadir Hari Ini</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="saldoKas">Rp 0</div>
                        <div class="stat-label">Saldo Kas</div>
                    </div>
                </div>
                <div id="syncStatus" class="sync-status" style="display:none;"></div>
                <button id="manualSyncBtn" onclick="manualSync()" class="btn btn-sync" style="max-width:200px;">üîÑ Sinkron Manual</button>
            </div>
        </section>

        <section class="section hidden" id="users">
            <div class="section-header admin-only"><h2>üë®‚Äçüíº Manajemen Pengguna</h2></div>
            <div class="section-content">
                <div class="users-section">
                    <h3>Tambah Pengguna Baru</h3>
                    <div class="form-grid" style="grid-template-columns:repeat(auto-fit,minmax(150px,1fr));">
                        <input type="text" id="newUsername" placeholder="Username *">
                        <input type="password" id="newPassword" placeholder="Password *">
                        <select id="newRole">
                            <option value="user">User Biasa</option>
                            <option value="admin">Administrator</option>
                        </select>
                        <button onclick="addUser()" class="btn btn-success">‚ûï Tambah User</button>
                    </div>
                </div>
                
                <h3>Pengguna Aktif</h3>
                <div id="usersList"></div>
            </div>
        </section>

        <section class="section" id="members">
            <div class="section-header admin-only"><h2>üë• Data Anggota</h2></div>
            <div class="section-content">
                <div class="form-grid">
                    <input type="text" id="nama" placeholder="Nama Lengkap *">
                    <input type="text" id="alamat" placeholder="Alamat *">
                    <input type="text" id="no_hp" placeholder="No. HP">
                    <input type="text" id="jabatan" placeholder="Jabatan">
                    <button onclick="addMember()" class="btn btn-primary">‚ûï Tambah</button>
                </div>
                <div class="table-responsive">
                    <table id="membersTable">
                        <thead><tr><th>Nama</th><th>Alamat/HP</th><th>Jabatan</th><th>Status</th><th>Aksi</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </section>

        <section class="section" id="attendance">
            <div class="section-header admin-only"><h2>üìã Input Absensi</h2></div>
            <div class="section-content">
                <div class="form-grid">
                    <select id="member_id_att"><option value="">-- Pilih Anggota --</option></select>
                    <input type="date" id="tanggal_att">
                    <select id="status_hadir">
                        <option value="hadir">Hadir</option>
                        <option value="sakit">Sakit</option>
                        <option value="izin">Izin</option>
                    </select>
                    <button onclick="addAttendance()" class="btn btn-primary">‚úÖ Simpan</button>
                </div>
                <h3 style="margin:20px 0 10px;font-size:16px;">Riwayat Absensi</h3>
                <div class="table-responsive">
                    <table id="attendanceTable">
                        <thead><tr><th>Tanggal</th><th>Nama</th><th>Status</th><th>Waktu</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </section>

        <section class="section" id="finance">
            <div class="section-header admin-only"><h2>üí∞ Kas & Keuangan</h2></div>
            <div class="section-content">
                <div class="form-grid">
                    <input type="text" id="deskripsi_fin" placeholder="Keterangan Transaksi *">
                    <input type="number" id="jumlah_fin" placeholder="Nominal (Rp) *">
                    <select id="jenis_fin">
                        <option value="pemasukan">‚ûï Pemasukan</option>
                        <option value="pengeluaran">‚ûñ Pengeluaran</option>
                    </select>
                    <input type="date" id="tanggal_fin">
                    <button onclick="addFinance()" class="btn btn-primary">üí∏ Simpan Transaksi</button>
                </div>
                <h3 style="margin:20px 0 10px;font-size:16px;">Riwayat Transaksi</h3>
                <div class="table-responsive">
                    <table id="financeTable">
                        <thead><tr><th>Tanggal</th><th>Keterangan</th><th>Jenis</th><th>Jumlah</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </section>
    </div>

    <script>
        // üî• FIREBASE CONFIG - SUDAH TERINSTAL
        const firebaseConfig = {
            apiKey: "AIzaSyCqF5VG2T03yaHOAq8dPhtvgMYrbVq-DIs",
            authDomain: "girsangborupanagolantangerang.firebaseapp.com",
            databaseURL: "https://girsangborupanagolantangerang-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "girsangborupanagolantangerang",
            storageBucket: "girsangborupanagolantangerang.firebasestorage.app",
            messagingSenderId: "823404152768",
            appId: "1:823404152768:web:c743fa07b22455452b2a25",
            measurementId: "G-716P2TK99Y"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // --- GLOBAL STATE ---
        let currentUser = {username: '', role: 'user'};
        let connectionStatus = 'offline';
        let syncQueue = [], isSyncing = false;
        let members = [], attendance = [], finance = [], users = [];
        let appInitialized = false;

        // Default users (simpan di Firebase)
        const defaultUsers = {
            admin: {username: 'admin', password: 'admin123', role: 'admin'},
            user1: {username: 'user1', password: 'user123', role: 'user'}
        };

        // --- CONNECTION MONITOR (HANYA ADMIN LIHAT) ---
        db.ref('.info/connected').on('value', (snap) => {
            if (snap.val() === true && connectionStatus !== 'online' && currentUser.role === 'admin') {
                connectionStatus = 'online';
                updateStatus('üü¢ Online & Sinkron', '#28a745');
                if(appInitialized) processSyncQueue();
            } else if (snap.val() === false && connectionStatus !== 'offline') {
                connectionStatus = 'offline';
                if(currentUser.role === 'admin') updateStatus('üî¥ Offline (Lokal OK)', '#dc3545');
            }
        });

        function updateStatus(text, color) {
            if(currentUser.role === 'admin') {
                document.getElementById('statusText').textContent = text;
                document.getElementById('statusDot').style.background = color;
            }
        }

        // --- AUTH SYSTEM ---
        function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            // Check local first, then Firebase
            const localUser = users.find(u => u.username === username && u.password === password);
            if(localUser || (defaultUsers[username] && defaultUsers[username].password === password)) {
                currentUser = localUser || defaultUsers[username] || {username, role: 'user'};
                localStorage.setItem('gbp_currentUser', JSON.stringify(currentUser));
                initApp();
            } else {
                alert('‚ùå Login Gagal! Cek username/password');
            }
        }

        function logout() {
            if(confirm('Keluar dari sistem?')) {
                localStorage.removeItem('gbp_currentUser');
                localStorage.clear();
                currentUser = {username: '', role: 'user'};
                location.reload();
            }
        }

        function showLoginOverlay() {
            document.getElementById('loginOverlay').style.display = 'flex';
            document.getElementById('mainContainer').style.display = 'none';
        }

        // --- APP INIT ---
        async function initApp() {
            document.getElementById('loginOverlay').style.display = 'none';
            document.getElementById('header').style.display = 'block';
            document.getElementById('navbar').style.display = 'block';
            document.getElementById('mainContainer').style.display = 'block';

            // Update UI berdasarkan role
            updateUserUI();
            
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('tanggal_att').value = today;
            document.getElementById('tanggal_fin').value = today;

            await loadAllData();
            appInitialized = true;
        }

        function updateUserUI() {
            document.getElementById('currentUsername').textContent = currentUser.username;
            const roleBadge = document.getElementById('currentRole');
            roleBadge.textContent = currentUser.role.toUpperCase();
            roleBadge.className = `user-role-badge role-${currentUser.role}`;

            document.getElementById('userInfoBar').classList.remove('hidden');
            document.getElementById('headerSubtitle').textContent = currentUser.role === 'admin' ? 
                'Dashboard Admin - Offline + Auto Sync' : 'Dashboard User';

            // Show/hide admin features
            const adminElements = document.querySelectorAll('.admin-only, #usersNav');
            adminElements.forEach(el => {
                el.style.display = currentUser.role === 'admin' ? 'block' : 'none';
            });

            // Status indicator hanya untuk admin
            document.querySelector('.status-indicator').style.display = currentUser.role === 'admin' ? 'flex' : 'none';

            if(currentUser.role === 'admin') {
                updateStatus('üü¢ Siap!', '#28a745');
            }
        }

        // --- USER MANAGEMENT (ADMIN ONLY) ---
        async function addUser() {
            if(currentUser.role !== 'admin') return alert('‚ùå Hanya admin yang bisa menambah user!');

            const username = document.getElementById('newUsername').value.trim();
            const password = document.getElementById('newPassword').value;
            const role = document.getElementById('newRole').value;

            if(!username || !password) return alert('‚ùå Username dan password wajib diisi!');

            if(users.find(u => u.username === username)) {
                return alert('‚ùå Username sudah ada!');
            }

            const newUser = {
                id: Date.now(),
                username, password, role,
                createdAt: Date.now(),
                createdBy: currentUser.username
            };

            users.push(newUser);
            await saveUsersToFirebase();
            localStorage.setItem('gbp_users', JSON.stringify(users));
            
            document.getElementById('newUsername').value = '';
            document.getElementById('newPassword').value = '';
            loadUsersTable();
            alert('‚úÖ User baru ditambahkan!');
        }

        async function deleteUser(userId) {
            if(currentUser.role !== 'admin') return;
            if(!confirm('Hapus user ini?')) return;

            users = users.filter(u => u.id != userId);
            await saveUsersToFirebase();
            localStorage.setItem('gbp_users', JSON.stringify(users));
            loadUsersTable();
        }

        function loadUsersTable() {
            const container = document.getElementById('usersList');
            container.innerHTML = '';
            users.forEach(user => {
                const div = document.createElement('div');
                div.className = 'user-row';
                div.innerHTML = `
                    <div>
                        <strong>${user.username}</strong> 
                        <span style="color:#666;font-size:12px;">(${user.role})</span>
                        ${user.createdBy ? `<br><small>Dibuat oleh: ${user.createdBy}</small>` : ''}
                    </div>
                    <div class="user-actions">
                        <button onclick="deleteUser(${user.id})" class="btn btn-danger btn-sm">Hapus</button>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        async function saveUsersToFirebase() {
            if(connectionStatus === 'online') {
                await db.ref('users').set(users);
            }
        }

        // --- DATA SYSTEM (SAME AS BEFORE) ---
        async function loadAllData() {
            // Load users
            users = JSON.parse(localStorage.getItem('gbp_users')) || Object.values(defaultUsers);
            
            // Load other data
            members = JSON.parse(localStorage.getItem('gbp_members')) || [];
            attendance = JSON.parse(localStorage.getItem('gbp_attendance')) || [];
            finance = JSON.parse(localStorage.getItem('gbp_finance')) || [];
            syncQueue = JSON.parse(localStorage.getItem('gbp_syncQueue')) || [];

            // Admin sync from Firebase
            if(currentUser.role === 'admin' && connectionStatus === 'online') {
                try {
                    const snapshot = await db.ref().once('value');
                    if (snapshot.exists()) {
                        const data = snapshot.val();
                        if (data.members) members = Object.values(data.members);
                        if (data.attendance) attendance = Object.values(data.attendance);
                        if (data.finance) finance = Object.values(data.finance);
                        if (data.users) users = Object.values(data.users);
                    }
                    localStorage.setItem('gbp_members', JSON.stringify(members));
                    localStorage.setItem('gbp_attendance', JSON.stringify(attendance));
                    localStorage.setItem('gbp_finance', JSON.stringify(finance));
                    localStorage.setItem('gbp_users', JSON.stringify(users));
                } catch(e) {
                    console.error('Sync failed:', e);
                }
            }

            renderAll();
            if(currentUser.role === 'admin') loadUsersTable();
        }

        // --- RENDER & ACTIONS (SAME AS BEFORE, dengan role check) ---
        function renderAll() {
            loadDashboard();
            loadMembersTable();
            loadAttendanceTable();
            loadFinanceTable();
            loadDropdowns();
        }

        // [REMAINDER OF FUNCTIONS SAME AS PREVIOUS VERSION - loadDashboard, addMember, etc.]
        // Untuk singkat, saya tidak copy ulang semua fungsi yang sama

        function queueAction(action, data) {
            if(currentUser.role !== 'admin') return; // Hanya admin yang sync
            const queueItem = {action, data, timestamp: Date.now(), id: Date.now()};
            syncQueue.unshift(queueItem);
            localStorage.setItem('gbp_syncQueue', JSON.stringify(syncQueue));
            if (connectionStatus === 'online' && !isSyncing) processSyncQueue();
        }

        // Auto login check
        const savedUser = localStorage.getItem('gbp_currentUser');
        if(savedUser) {
            currentUser = JSON.parse(savedUser);
            initApp();
        }
    </script>
</body>
</html>
