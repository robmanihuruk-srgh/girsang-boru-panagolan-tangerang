                </div>
            `;
            
            document.body.appendChild(printModal);
        }

        // Fungsi untuk mencetak laporan gabungan
        function printCombinedReport() {
            const printContent = document.getElementById('combinedReportContent').innerHTML;
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Laporan Lengkap - Girsang Boru Panagolan</title>
                    <style>
                        body { 
                            font-family: 'Arial', sans-serif; 
                            padding: 20px; 
                            margin: 0;
                            color: #333;
                        }
                        @page {
                            size: A4;
                            margin: 1.5cm;
                        }
                        .print-header { 
                            text-align: center; 
                            margin-bottom: 40px;
                            border-bottom: 3px solid #3498db;
                            padding-bottom: 20px;
                        }
                        .print-header h1 {
                            color: #2c3e50;
                            margin-bottom: 10px;
                            font-size: 28px;
                        }
                        .print-header h2 {
                            color: #3498db;
                            margin-bottom: 15px;
                            font-size: 20px;
                        }
                        table { 
                            width: 100%; 
                            border-collapse: collapse; 
                            margin-bottom: 30px;
                            font-size: 12px;
                        }
                        th, td { 
                            padding: 12px 8px; 
                            border: 1px solid #ddd; 
                            text-align: left; 
                            vertical-align: top;
                        }
                        th { 
                            background-color: #f8f9fa; 
                            font-weight: bold;
                            color: #2c3e50;
                        }
                        tr:nth-child(even) {
                            background-color: #f9f9f9;
                        }
                        .section-title {
                            color: #2c3e50;
                            margin-top: 40px;
                            margin-bottom: 20px;
                            padding-bottom: 10px;
                            border-bottom: 2px solid #e9ecef;
                            page-break-after: avoid;
                        }
                        .stats-grid {
                            display: grid;
                            grid-template-columns: repeat(3, 1fr);
                            gap: 15px;
                            margin: 25px 0;
                        }
                        .stat-box {
                            background: #f8f9fa;
                            padding: 20px;
                            border-radius: 8px;
                            text-align: center;
                            border-left: 4px solid #3498db;
                        }
                        .stat-box h4 {
                            margin: 0 0 10px 0;
                            color: #3498db;
                            font-size: 24px;
                        }
                        .stat-box p {
                            margin: 0;
                            color: #666;
                            font-size: 14px;
                        }
                        .footer-note {
                            text-align: center;
                            color: #666;
                            margin-top: 50px;
                            padding-top: 20px;
                            border-top: 1px solid #eee;
                            font-size: 11px;
                        }
                        @media print {
                            .no-print { display: none !important; }
                            .page-break { page-break-before: always; }
                            body { padding: 0; }
                        }
                    </style>
                </head>
                <body>
                    <div class="print-header">
                        <h1>Girsang Boru Panagolan Tangerang</h1>
                        <h2>Laporan Lengkap Sistem Manajemen</h2>
                        <p><strong>Tanggal Cetak:</strong> ${new Date().toLocaleDateString('id-ID', {
                            weekday: 'long',
                            year: 'numeric',
                            month: 'long',
                            day: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        })}</p>
                    </div>
                    ${printContent}
                </body>
                </html>
            `);
            
            printWindow.document.close();
            
            // Tunggu sebentar sebelum print untuk memastikan konten terbaca
            setTimeout(() => {
                printWindow.print();
                printWindow.close();
            }, 500);
        }

        // ==================== IMPORT FUNCTIONS ====================
        function showImportModal() {
            if (!['administrator', 'supervisor', 'manager'].includes(currentUser.role)) {
                showToast('error', 'Akses Ditolak', 'Anda tidak memiliki izin untuk mengimport data.');
                return;
            }
            
            importCurrentStep = 1;
            importData = null;
            importColumnMapping = {};
            
            document.getElementById('selectedFileName').textContent = '';
            document.getElementById('columnMappingSection').style.display = 'none';
            document.getElementById('previewHeader').innerHTML = '';
            document.getElementById('previewBody').innerHTML = '';
            document.getElementById('totalRows').textContent = '0';
            document.getElementById('validRows').textContent = '0';
            document.getElementById('duplicateRows').textContent = '0';
            document.getElementById('errorRows').textContent = '0';
            
            updateImportStep();
            document.getElementById('importModal').style.display = 'flex';
        }

        function closeImportModal() {
            document.getElementById('importModal').style.display = 'none';
        }

        function updateImportStep() {
            // Hide all steps
            for (let i = 1; i <= 3; i++) {
                document.getElementById(`step${i}`).classList.remove('active-step');
            }
            
            // Show current step
            document.getElementById(`step${importCurrentStep}`).classList.add('active-step');
            
            // Update buttons
            document.getElementById('prevBtn').style.display = importCurrentStep > 1 ? 'flex' : 'none';
            document.getElementById('nextBtn').style.display = importCurrentStep < 3 ? 'flex' : 'none';
            document.getElementById('importBtn').style.display = importCurrentStep === 2 ? 'flex' : 'none';
            document.getElementById('closeBtn').style.display = importCurrentStep === 3 ? 'flex' : 'none';
        }

        function prevStep() {
            if (importCurrentStep > 1) {
                importCurrentStep--;
                updateImportStep();
            }
        }

        function nextStep() {
            if (importCurrentStep === 1 && !importData) {
                showToast('error', 'Data Kosong', 'Harap pilih file Excel terlebih dahulu.');
                return;
            }
            
            if (importCurrentStep < 3) {
                importCurrentStep++;
                updateImportStep();
            }
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            document.getElementById('selectedFileName').textContent = file.name;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                    
                    processImportData(jsonData);
                } catch (error) {
                    console.error('Error reading file:', error);
                    showToast('error', 'Error File', 'Gagal membaca file. Pastikan format file benar.');
                }
            };
            
            reader.readAsArrayBuffer(file);
        }

        function processImportData(jsonData) {
            if (jsonData.length < 2) {
                showToast('error', 'Data Kosong', 'File tidak mengandung data.');
                return;
            }
            
            const headers = jsonData[0];
            const rows = jsonData.slice(1).filter(row => row.some(cell => cell != null));
            
            // Auto-map columns
            const columnMapping = {};
            const headerMap = {
                'NO': 'no_kep',
                'NOMOR': 'no_kep',
                'NAMA': 'nama',
                'NAMA LENGKAP': 'nama',
                'TANGGAL LAHIR': 'tgl_lahir',
                'TGL LAHIR': 'tgl_lahir',
                'ALAMAT': 'alamat',
                'NO HP': 'no_hp',
                'TELEPON': 'no_hp',
                'JABATAN': 'jabatan',
                'STATUS': 'status',
                'KATEGORI': 'category'
            };
            
            headers.forEach((header, index) => {
                if (header) {
                    const normalizedHeader = header.toString().trim().toUpperCase();
                    columnMapping[index] = headerMap[normalizedHeader] || normalizedHeader.toLowerCase();
                }
            });
            
            importColumnMapping = columnMapping;
            importData = { headers, rows };
            
            // Show column mapping if auto-map is checked
            const autoMap = document.getElementById('autoMapColumns').checked;
            if (autoMap) {
                showColumnMapping(columnMapping);
            }
            
            // Show preview
            showPreview(headers, rows.slice(0, 10));
            
            // Calculate stats
            calculateImportStats(rows);
            
            showToast('success', 'File Dimuat', `Berhasil memuat ${rows.length} baris data.`);
        }

        function showColumnMapping(mapping) {
            const grid = document.getElementById('columnMappingGrid');
            grid.innerHTML = '';
            
            Object.keys(mapping).forEach(index => {
                const excelCol = importData.headers[index];
                const dbCol = mapping[index];
                
                const div = document.createElement('div');
                div.style.cssText = 'background: #f8f9fa; padding: 10px; border-radius: 5px; border: 1px solid #e9ecef;';
                div.innerHTML = `
                    <div><strong>Excel:</strong> ${excelCol}</div>
                    <div><strong>‚Üí Database:</strong> ${dbCol}</div>
                `;
                grid.appendChild(div);
            });
            
            document.getElementById('columnMappingSection').style.display = 'block';
        }

        function showPreview(headers, rows) {
            const headerRow = document.getElementById('previewHeader');
            const body = document.getElementById('previewBody');
            
            // Clear previous content
            headerRow.innerHTML = '';
            body.innerHTML = '';
            
            // Create header
            const headerTr = document.createElement('tr');
            headers.forEach(header => {
                const th = document.createElement('th');
                th.textContent = header || '';
                headerTr.appendChild(th);
            });
            headerRow.appendChild(headerTr);
            
            // Create rows
            rows.forEach(row => {
                const tr = document.createElement('tr');
                headers.forEach((_, index) => {
                    const td = document.createElement('td');
                    td.textContent = row[index] || '';
                    tr.appendChild(td);
                });
                body.appendChild(tr);
            });
        }

        function calculateImportStats(rows) {
            const totalRows = rows.length;
            let validRows = 0;
            let duplicateRows = 0;
            let errorRows = 0;
            
            // Simple validation - count rows with at least 3 non-empty cells
            rows.forEach(row => {
                const nonEmptyCells = row.filter(cell => 
                    cell !== null && 
                    cell !== undefined && 
                    cell.toString().trim() !== ''
                ).length;
                
                if (nonEmptyCells >= 3) {
                    validRows++;
                } else {
                    errorRows++;
                }
            });
            
            document.getElementById('totalRows').textContent = totalRows;
            document.getElementById('validRows').textContent = validRows;
            document.getElementById('duplicateRows').textContent = duplicateRows;
            document.getElementById('errorRows').textContent = errorRows;
        }

        async function startImport() {
            if (!importData || !importData.rows || importData.rows.length === 0) {
                showToast('error', 'Data Kosong', 'Tidak ada data untuk diimport.');
                return;
            }
            
            importCurrentStep = 3;
            updateImportStep();
            
            const overwrite = document.getElementById('overwriteData').checked;
            const skipDuplicates = document.getElementById('skipDuplicates').checked;
            const totalRows = importData.rows.length;
            
            let imported = 0;
            let errors = 0;
            let duplicates = 0;
            
            // Process each row
            for (let i = 0; i < totalRows; i++) {
                const row = importData.rows[i];
                
                // Update progress
                const progress = Math.round((i + 1) / totalRows * 100);
                document.getElementById('progressBar').style.width = `${progress}%`;
                document.getElementById('progressText').textContent = `Memproses baris ${i + 1} dari ${totalRows}`;
                document.getElementById('progressDetails').innerHTML = `
                    <div>‚úÖ Berhasil: ${imported}</div>
                    <div>‚ö†Ô∏è Duplikat: ${duplicates}</div>
                    <div>‚ùå Error: ${errors}</div>
                `;
                
                try {
                    // Convert row to member data
                    const memberData = mapRowToMember(row);
                    
                    if (!memberData || !memberData.no_kep || !memberData.nama) {
                        errors++;
                        continue;
                    }
                    
                    // Check for duplicates
                    const existingMember = members.find(m => 
                        m.no_kep === memberData.no_kep || 
                        (m.nama === memberData.nama && m.no_hp === memberData.no_hp)
                    );
                    
                    if (existingMember) {
                        if (skipDuplicates) {
                            duplicates++;
                            continue;
                        }
                        
                        if (overwrite) {
                            // Update existing member
                            await saveToFirebase(`members/${existingMember.firebaseKey}`, {
                                ...existingMember,
                                ...memberData,
                                updatedAt: Date.now(),
                                updatedBy: currentUser.username
                            });
                            imported++;
                        } else {
                            duplicates++;
                        }
                    } else {
                        // Create new member
                        const newKey = db.ref('members').push().key;
                        await saveToFirebase(`members/${newKey}`, {
                            firebaseKey: newKey,
                            ...memberData,
                            createdAt: Date.now(),
                            createdBy: currentUser.username,
                            updatedAt: Date.now(),
                            updatedBy: currentUser.username
                        });
                        imported++;
                    }
                    
                } catch (error) {
                    console.error(`Error importing row ${i}:`, error);
                    errors++;
                }
                
                // Small delay to show progress
                await new Promise(resolve => setTimeout(resolve, 50));
            }
            
            // Final update
            document.getElementById('progressBar').style.width = '100%';
            document.getElementById('progressText').textContent = 'Import selesai!';
            document.getElementById('progressDetails').innerHTML = `
                <div><strong>Hasil Import:</strong></div>
                <div>‚úÖ Berhasil: ${imported} anggota</div>
                <div>‚ö†Ô∏è Duplikat: ${duplicates}</div>
                <div>‚ùå Error: ${errors}</div>
            `;
            
            showToast('success', 'Import Selesai', `Berhasil mengimport ${imported} data anggota.`);
        }

        function mapRowToMember(row) {
            const memberData = {};
            
            // Map columns based on mapping
            Object.keys(importColumnMapping).forEach(colIndex => {
                const dbField = importColumnMapping[colIndex];
                const cellValue = row[colIndex];
                
                if (cellValue !== null && cellValue !== undefined) {
                    const stringValue = cellValue.toString().trim();
                    
                    switch(dbField) {
                        case 'no_kep':
                            memberData.no_kep = stringValue;
                            break;
                        case 'nama':
                            memberData.nama = stringValue;
                            break;
                        case 'tgl_lahir':
                            memberData.tgl_lahir = formatExcelDate(stringValue);
                            break;
                        case 'alamat':
                            memberData.alamat = stringValue;
                            break;
                        case 'no_hp':
                            memberData.no_hp = stringValue;
                            break;
                        case 'jabatan':
                            memberData.jabatan = stringValue || 'Anggota';
                            break;
                        case 'status':
                            memberData.status = stringValue.toLowerCase().includes('nonaktif') ? 'nonaktif' : 'aktif';
                            break;
                        default:
                            memberData[dbField] = stringValue;
                    }
                }
            });
            
            // Auto-generate nomor KK jika tidak ada
            if (!memberData.no_kep && memberData.nama) {
                const randomNum = Math.floor(Math.random() * 1000).toString().padStart(4, '0');
                memberData.no_kep = `TGBP-W3TGR-S-${randomNum}-G`;
            }
            
            // Parse nomor KK untuk mendapatkan kategori
            const parsedKK = parseNomorKK(memberData.no_kep);
            if (parsedKK) {
                memberData.parsed_kk = parsedKK;
            }
            
            return memberData;
        }

        function formatExcelDate(excelDate) {
            if (!excelDate) return '';
            
            // Handle Excel serial date numbers
            if (typeof excelDate === 'number') {
                const date = new Date((excelDate - 25569) * 86400 * 1000);
                return date.toISOString().split('T')[0];
            }
            
            // Handle string dates
            const date = new Date(excelDate);
            if (isNaN(date.getTime())) return excelDate;
            
            return date.toISOString().split('T')[0];
        }

        // ==================== EXPORT FUNCTIONS ====================
        function exportToExcel() {
            if (members.length === 0) {
                showToast('error', 'Data Kosong', 'Tidak ada data anggota untuk diexport.');
                return;
            }
            
            // Prepare data for Excel
            const data = [
                ['No', 'Nomor KK', 'Nama Lengkap', 'Tanggal Lahir', 'Alamat', 'No HP', 'Jabatan', 'Status', 'Kategori', 'Jumlah Anak']
            ];
            
            members.forEach((member, index) => {
                const parsed = parseNomorKK(member.no_kep);
                const kategori = parsed ? formatKategori(parsed.kategori) : '-';
                
                data.push([
                    index + 1,
                    member.no_kep || '',
                    member.nama || '',
                    member.tgl_lahir ? formatDate(member.tgl_lahir) : '',
                    member.alamat || '',
                    member.no_hp || '',
                    member.jabatan || '',
                    member.status === 'aktif' ? 'Aktif' : 'Nonaktif',
                    kategori,
                    member.jumlah_anak || 0
                ]);
            });
            
            // Create worksheet
            const ws = XLSX.utils.aoa_to_sheet(data);
            
            // Set column widths
            const wscols = [
                { wch: 5 },   // No
                { wch: 25 },  // Nomor KK
                { wch: 30 },  // Nama
                { wch: 12 },  // Tgl Lahir
                { wch: 40 },  // Alamat
                { wch: 15 },  // No HP
                { wch: 15 },  // Jabatan
                { wch: 10 },  // Status
                { wch: 15 },  // Kategori
                { wch: 10 }   // Jml Anak
            ];
            ws['!cols'] = wscols;
            
            // Create workbook
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Data Anggota');
            
            // Generate filename
            const today = new Date().toISOString().split('T')[0];
            const filename = `Data_Anggota_Girsang_${today}.xlsx`;
            
            // Export to Excel
            XLSX.writeFile(wb, filename);
            
            showToast('success', 'Export Berhasil', `Data berhasil diexport ke ${filename}`);
        }

        function exportToPDF() {
            if (members.length === 0) {
                showToast('error', 'Data Kosong', 'Tidak ada data anggota untuk diexport.');
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('landscape');
            
            // Add header
            doc.setFontSize(20);
            doc.setTextColor(40, 40, 40);
            doc.text('Girsang Boru Panagolan Tangerang', 15, 15);
            doc.setFontSize(12);
            doc.text('Data Anggota', 15, 22);
            doc.text(`Tanggal: ${new Date().toLocaleDateString('id-ID')}`, 15, 28);
            
            // Prepare table data
            const tableData = members.map((member, index) => {
                const parsed = parseNomorKK(member.no_kep);
                const kategori = parsed ? formatKategori(parsed.kategori) : '-';
                
                return [
                    index + 1,
                    member.no_kep || '-',
                    member.nama || '-',
                    member.tgl_lahir ? formatDate(member.tgl_lahir) : '-',
                    member.alamat || '-',
                    member.no_hp || '-',
                    member.jabatan || '-',
                    member.status === 'aktif' ? 'Aktif' : 'Nonaktif',
                    kategori,
                    member.jumlah_anak || 0
                ];
            });
            
            // Create table
            doc.autoTable({
                startY: 35,
                head: [['No', 'Nomor KK', 'Nama', 'Tgl Lahir', 'Alamat', 'No HP', 'Jabatan', 'Status', 'Kategori', 'Jml Anak']],
                body: tableData,
                theme: 'grid',
                headStyles: { fillColor: [52, 152, 219] },
                margin: { left: 10 },
                styles: { fontSize: 8 },
                columnStyles: {
                    0: { cellWidth: 10 },
                    1: { cellWidth: 30 },
                    2: { cellWidth: 25 },
                    3: { cellWidth: 20 },
                    4: { cellWidth: 35 },
                    5: { cellWidth: 20 },
                    6: { cellWidth: 20 },
                    7: { cellWidth: 15 },
                    8: { cellWidth: 15 },
                    9: { cellWidth: 10 }
                }
            });
            
            // Add footer
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(10);
                doc.text(
                    `Halaman ${i} dari ${pageCount} - Dicetak oleh ${currentUser.username}`,
                    doc.internal.pageSize.width - 15,
                    doc.internal.pageSize.height - 10,
                    { align: 'right' }
                );
            }
            
            // Save PDF
            const filename = `Data_Anggota_${new Date().toISOString().slice(0, 10)}.pdf`;
            doc.save(filename);
            
            showToast('success', 'PDF Berhasil', `Data berhasil diexport ke ${filename}`);
        }

        function exportAttendance() {
            if (attendance.length === 0) {
                showToast('error', 'Data Kosong', 'Tidak ada data kehadiran untuk diexport.');
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Add header
            doc.setFontSize(18);
            doc.text('Data Kehadiran Anggota', 15, 15);
            doc.setFontSize(12);
            doc.text(`Periode: ${formatDate(attendance[0].date)} - ${formatDate(attendance[attendance.length - 1].date)}`, 15, 22);
            doc.text(`Total: ${attendance.length} catatan`, 15, 28);
            
            // Prepare table data
            const tableData = attendance.map(record => {
                const statusText = record.status === 'hadir' ? 'Hadir' :
                                record.status === 'sakit' ? 'Sakit' :
                                record.status === 'izin' ? 'Izin' : 'Alfa';
                
                return [
                    formatDate(record.date),
                    record.memberName || '-',
                    statusText,
                    record.note || '-',
                    formatDateTime(record.createdAt)
                ];
            });
            
            // Create table
            doc.autoTable({
                startY: 35,
                head: [['Tanggal', 'Nama Anggota', 'Status', 'Keterangan', 'Waktu']],
                body: tableData,
                theme: 'grid',
                headStyles: { fillColor: [52, 152, 219] }
            });
            
            // Save PDF
            const filename = `Data_Kehadiran_${new Date().toISOString().slice(0, 10)}.pdf`;
            doc.save(filename);
            
            showToast('success', 'Export Berhasil', `Data kehadiran berhasil diexport.`);
        }

        function printDetail() {
            const detailContent = document.getElementById('detailContent').innerHTML;
            const printWindow = window.open('', '_blank');
            
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Detail Anggota</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; }
                        .header { text-align: center; margin-bottom: 30px; }
                        .detail-row { margin-bottom: 10px; }
                        .detail-label { font-weight: bold; display: inline-block; width: 150px; }
                        @media print {
                            body { padding: 10px; }
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h2>Girsang Boru Panagolan Tangerang</h2>
                        <h3>Detail Anggota</h3>
                    </div>
                    ${detailContent}
                </body>
                </html>
            `);
            
            printWindow.document.close();
            printWindow.print();
        }

        function printMemberReport() {
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Laporan Data Anggota</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; }
                        .print-header { text-align: center; margin-bottom: 30px; }
                        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
                        th, td { padding: 8px; border: 1px solid #ddd; text-align: left; }
                        th { background-color: #f8f9fa; }
                    </style>
                </head>
                <body>
                    <div class="print-header">
                        <h1>Girsang Boru Panagolan Tangerang</h1>
                        <h2>Laporan Data Anggota</h2>
                        <p>Tanggal: ${new Date().toLocaleDateString('id-ID')}</p>
                    </div>
                    ${document.getElementById('memberReportContent').innerHTML}
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        // ==================== FAMILY HIERARCHY FUNCTIONS ====================
        function generateFamilyHierarchyReport() {
            if (members.length === 0) {
                showToast('error', 'Data Kosong', 'Tidak ada data anggota untuk laporan keluarga.');
                return;
            }
            
            // Group members by nomor induk (first 4 digits of nomor KK)
            const familyGroups = {};
            
            members.forEach(member => {
                const parsed = parseNomorKK(member.no_kep);
                if (parsed && parsed.nomorInduk) {
                    const familyKey = parsed.nomorInduk;
                    
                    if (!familyGroups[familyKey]) {
                        familyGroups[familyKey] = {
                            nomorInduk: familyKey,
                            anggota: []
                        };
                    }
                    
                    familyGroups[familyKey].anggota.push({
                        nama: member.nama,
                        status: parsed.status,
                        kategori: parsed.kategori,
                        memberData: member
                    });
                }
            });
            
            // Sort keluarga by nomor induk
            const sortedFamilies = Object.values(familyGroups).sort((a, b) => {
                return parseInt(a.nomorInduk) - parseInt(b.nomorInduk);
            });
            
            let reportHTML = `
                <div style="text-align: center; margin-bottom: 30px;">
                    <h2>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Laporan Hierarki Keluarga</h2>
                    <p>Total Keluarga: ${sortedFamilies.length}</p>
                    <p>Total Anggota: ${members.length}</p>
                </div>
            `;
            
            sortedFamilies.forEach((family, index) => {
                // Sort anggota dalam keluarga: Suami -> Istri -> Anak 1 -> Anak 2 -> dst
                const sortedAnggota = family.anggota.sort((a, b) => {
                    const order = { 'S': 1, 'I': 2, 'A1': 3, 'A2': 4, 'A3': 5, 'A4': 6, 'A5': 7, 'A6': 8, 'A7': 9, 'A8': 10, 'A9': 11 };
                    return (order[a.status] || 99) - (order[b.status] || 99);
                });
                
                reportHTML += `
                    <div style="background: #f8f9fa; border-radius: 10px; padding: 20px; margin-bottom: 20px;">
                        <h3 style="color: #3498db; margin-bottom: 15px;">
                            Keluarga #${index + 1} (Induk: ${family.nomorInduk})
                        </h3>
                        <div style="margin-left: 20px;">
                `;
                
                sortedAnggota.forEach(anggota => {
                    const statusText = formatStatusKeluarga(anggota.status);
                    const kategoriText = formatKategori(anggota.kategori);
                    
                    reportHTML += `
                        <div style="margin-bottom: 10px; padding: 10px; background: white; border-radius: 5px;">
                            <strong>${anggota.nama}</strong>
                            <br>
                            <small style="color: #666;">
                                Status: ${statusText} | 
                                Kategori: ${kategoriText} | 
                                Anak: ${anggota.memberData.jumlah_anak || 0}
                            </small>
                        </div>
                    `;
                });
                
                reportHTML += `
                        </div>
                    </div>
                `;
            });
            
            // Create modal for family report
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.style.display = 'flex';
            modal.innerHTML = `
                <div class="modal-box" style="max-width: 800px;">
                    <div class="modal-header">
                        <h3>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Laporan Hierarki Keluarga</h3>
                        <div class="modal-close" onclick="this.parentElement.parentElement.remove()">√ó</div>
                    </div>
                    <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                        ${reportHTML}
                    </div>
                    <div class="modal-footer">
                        <button onclick="printFamilyReport()" class="btn btn-primary">üñ®Ô∏è Cetak</button>
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" class="btn btn-danger">Tutup</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            showToast('success', 'Laporan Siap', `Berhasil menghasilkan laporan ${sortedFamilies.length} keluarga.`);
        }

        function printFamilyReport() {
            const modal = document.querySelector('.modal-overlay .modal-body');
            if (!modal) return;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Laporan Hierarki Keluarga</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; }
                        .print-header { text-align: center; margin-bottom: 30px; }
                        .family-group { 
                            background: #f8f9fa; 
                            border-radius: 10px; 
                            padding: 20px; 
                            margin-bottom: 20px; 
                            page-break-inside: avoid;
                        }
                        h3 { color: #3498db; }
                        .member-item { 
                            margin-bottom: 10px; 
                            padding: 10px; 
                            background: white; 
                            border-radius: 5px; 
                            border-left: 4px solid #3498db;
                        }
                    </style>
                </head>
                <body>
                    <div class="print-header">
                        <h1>Girsang Boru Panagolan Tangerang</h1>
                        <h2>Laporan Hierarki Keluarga</h2>
                        <p>Tanggal Cetak: ${new Date().toLocaleDateString('id-ID')}</p>
                    </div>
                    ${modal.innerHTML}
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        // ==================== DRAG & DROP HANDLING ====================
        function setupDragAndDrop() {
            const dropArea = document.getElementById('dropArea');
            const fileInput = document.getElementById('fileInput');
            
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, preventDefaults, false);
            });
            
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            ['dragenter', 'dragover'].forEach(eventName => {
                dropArea.addEventListener(eventName, highlight, false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, unhighlight, false);
            });
            
            function highlight() {
                dropArea.style.background = '#e9ecef';
                dropArea.style.borderColor = '#2980b9';
            }
            
            function unhighlight() {
                dropArea.style.background = '#f8f9fa';
                dropArea.style.borderColor = '#3498db';
            }
            
            dropArea.addEventListener('drop', handleDrop, false);
            
            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                
                if (files.length) {
                    fileInput.files = files;
                    
                    const event = new Event('change', { bubbles: true });
                    fileInput.dispatchEvent(event);
                }
            }
        }

        // ==================== INITIALIZATION ====================
        document.addEventListener('DOMContentLoaded', function() {
            checkAuthOnLoad();
            setupDragAndDrop();
            
            // Set today's date in date inputs
            const today = new Date().toISOString().split('T')[0];
            document.querySelectorAll('input[type="date"]').forEach(input => {
                if (!input.id.includes('BirthDate')) {
                    input.value = today;
                }
            });
            
            // Add event listeners for Enter key in login form
            document.getElementById('password').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    login();
                }
            });
        });

        // ==================== BACKUP & RESTORE FUNCTIONS ====================
        async function backupData() {
            try {
                const allData = {
                    members: members,
                    attendance: attendance,
                    finance: finance,
                    users: users,
                    metadata: {
                        exportDate: new Date().toISOString(),
                        exportedBy: currentUser.username,
                        totalRecords: members.length + attendance.length + finance.length + users.length
                    }
                };
                
                const dataStr = JSON.stringify(allData, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                
                const exportFileDefaultName = `backup_girsang_${new Date().toISOString().slice(0, 10)}.json`;
                
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileDefaultName);
                linkElement.click();
                
                showToast('success', 'Backup Berhasil', 'Data berhasil di-backup.');
                
            } catch (error) {
                console.error('Backup error:', error);
                showToast('error', 'Backup Gagal', 'Gagal melakukan backup data.');
            }
        }

        async function restoreData() {
            if (!confirm('PERINGATAN: Restore data akan menimpa data yang ada. Lanjutkan?')) {
                return;
            }
            
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = '.json';
            
            fileInput.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                try {
                    const reader = new FileReader();
                    reader.onload = async (event) => {
                        const data = JSON.parse(event.target.result);
                        
                        // Validate data structure
                        if (!data.members || !data.attendance || !data.finance || !data.users) {
                            showToast('error', 'File Tidak Valid', 'Format file backup tidak valid.');
                            return;
                        }
                        
                        // Show progress
                        showToast('info', 'Memulihkan Data', 'Sedang memulihkan data...');
                        
                        // Restore members
                        for (const member of data.members) {
                            await saveToFirebase(`members/${member.firebaseKey}`, member);
                        }
                        
                        // Restore attendance
                        for (const record of data.attendance) {
                            await saveToFirebase(`attendance/${record.firebaseKey}`, record);
                        }
                        
                        // Restore finance
                        for (const transaction of data.finance) {
                            await saveToFirebase(`finance/${transaction.firebaseKey}`, transaction);
                        }
                        
                        // Restore users (skip default admin)
                        for (const user of data.users) {
                            if (user.username !== 'admin') {
                                await saveToFirebase(`users/${user.firebaseKey}`, user);
                            }
                        }
                        
                        showToast('success', 'Restore Berhasil', 'Data berhasil dipulihkan dari backup.');
                    };
                    
                    reader.readAsText(file);
                    
                } catch (error) {
                    console.error('Restore error:', error);
                    showToast('error', 'Restore Gagal', 'Gagal memulihkan data dari backup.');
                }
            };
            
            fileInput.click();
        }

        // ==================== UTILITY FUNCTIONS ====================
        function formatExcelDate(dateValue) {
            if (!dateValue) return '';
            
            if (typeof dateValue === 'number') {
                // Excel dates are number of days since 1900-01-00
                const excelEpoch = new Date(1900, 0, 0);
                const days = dateValue - 2; // Excel bug: thinks 1900 is a leap year
                const date = new Date(excelEpoch.getTime() + days * 86400000);
                return date.toISOString().split('T')[0];
            }
            
            const date = new Date(dateValue);
            if (isNaN(date.getTime())) return dateValue;
            
            return date.toISOString().split('T')[0];
        }

        function showLoading(message = 'Memuat...') {
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'loadingOverlay';
            loadingDiv.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.7);
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                z-index: 9999;
                color: white;
            `;
            
            loadingDiv.innerHTML = `
                <div class="spinner"></div>
                <div style="margin-top: 20px; font-size: 18px;">${message}</div>
            `;
            
            document.body.appendChild(loadingDiv);
        }

        function hideLoading() {
            const loadingDiv = document.getElementById('loadingOverlay');
            if (loadingDiv) {
                loadingDiv.remove();
            }
        }

        function validatePhoneNumber(phone) {
            const phoneRegex = /^[0-9]{10,13}$/;
            return phoneRegex.test(phone.replace(/[-\s]/g, ''));
        }

        function validateEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }

        // ==================== AUTO-REFRESH FUNCTIONS ====================
        let autoRefreshInterval;
        
        function startAutoRefresh(intervalMinutes = 5) {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
            
            autoRefreshInterval = setInterval(() => {
                loadAllData();
                console.log(`üîÑ Auto-refresh pada ${new Date().toLocaleTimeString()}`);
            }, intervalMinutes * 60 * 1000);
        }
        
        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
        }

        // Start auto-refresh on app initialization
        if (appInitialized) {
            startAutoRefresh(10); // Refresh every 10 minutes
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            stopAutoRefresh();
        });

        // ==================== NOTIFICATION SYSTEM ====================
        function checkForNotifications() {
            // Check for upcoming birthdays
            const today = new Date();
            const nextWeek = new Date(today);
            nextWeek.setDate(today.getDate() + 7);
            
            const upcomingBirthdays = members.filter(member => {
                if (!member.tgl_lahir) return false;
                
                const birthDate = new Date(member.tgl_lahir);
                const thisYearBirthday = new Date(
                    today.getFullYear(),
                    birthDate.getMonth(),
                    birthDate.getDate()
                );
                
                return thisYearBirthday >= today && thisYearBirthday <= nextWeek;
            });
            
            if (upcomingBirthdays.length > 0) {
                showToast('info', 'Ulang Tahun Mendatang', 
                    `${upcomingBirthdays.length} anggota akan berulang tahun minggu ini.`);
            }
            
            // Check for inactive members
            const inactiveMembers = members.filter(m => m.status === 'nonaktif');
            if (inactiveMembers.length > 5) {
                showToast('warning', 'Anggota Nonaktif', 
                    `Terdapat ${inactiveMembers.length} anggota yang nonaktif.`);
            }
        }

        // Run notification check every hour
        setInterval(checkForNotifications, 60 * 60 * 1000);

        // ==================== ERROR HANDLING ====================
        window.onerror = function(msg, url, lineNo, columnNo, error) {
            console.error('Global error:', msg, url, lineNo, error);
            showToast('error', 'System Error', 'Terjadi kesalahan sistem. Periksa console untuk detail.');
            return false;
        };

        // Handle offline/online status
        window.addEventListener('online', () => {
            updateConnectionStatus(true);
            showToast('success', 'Koneksi Pulih', 'Koneksi internet telah pulih.');
        });

        window.addEventListener('offline', () => {
            updateConnectionStatus(false);
            showToast('warning', 'Koneksi Terputus', 'Anda sedang offline. Data akan disinkronkan saat online.');
        });

        // ==================== DATA VALIDATION ====================
        function validateMemberData(memberData) {
            const errors = [];
            
            if (!memberData.nama || memberData.nama.trim().length < 2) {
                errors.push('Nama harus diisi (minimal 2 karakter)');
            }
            
            if (!memberData.no_kep) {
                errors.push('Nomor KK harus diisi');
            } else {
                const parsed = parseNomorKK(memberData.no_kep);
                if (!parsed) {
                    errors.push('Format nomor KK tidak valid');
                }
            }
            
            if (!memberData.alamat || memberData.alamat.trim().length < 5) {
                errors.push('Alamat harus diisi (minimal 5 karakter)');
            }
            
            if (memberData.no_hp && !validatePhoneNumber(memberData.no_hp)) {
                errors.push('Format nomor HP tidak valid');
            }
            
            return errors;
        }

        // ==================== BATCH OPERATIONS ====================
        async function batchUpdateStatus(status) {
            if (!confirm(`Apakah Anda yakin ingin mengubah status ${members.length} anggota menjadi "${status}"?`)) {
                return;
            }
            
            showLoading('Memperbarui status anggota...');
            
            try {
                const updates = {};
                const timestamp = Date.now();
                
                members.forEach(member => {
                    updates[`members/${member.firebaseKey}/status`] = status;
                    updates[`members/${member.firebaseKey}/updatedAt`] = timestamp;
                    updates[`members/${member.firebaseKey}/updatedBy`] = currentUser.username;
                });
                
                await db.ref().update(updates);
                showToast('success', 'Berhasil', `Status ${members.length} anggota telah diperbarui.`);
                
            } catch (error) {
                console.error('Batch update error:', error);
                showToast('error', 'Gagal', 'Gagal memperbarui status anggota.');
            } finally {
                hideLoading();
            }
        }

        // ==================== DATA CLEANUP ====================
        async function cleanupOrphanedData() {
            if (!confirm('Membersihkan data yang tidak terhubung? Ini akan menghapus data kehadiran untuk anggota yang sudah tidak ada.')) {
                return;
            }
            
            showLoading('Membersihkan data...');
            
            try {
                const memberIds = members.map(m => m.firebaseKey);
                const orphanedAttendance = attendance.filter(a => !memberIds.includes(a.memberId));
                
                let deletedCount = 0;
                
                for (const record of orphanedAttendance) {
                    await deleteFromFirebase(`attendance/${record.firebaseKey}`);
                    deletedCount++;
                }
                
                showToast('success', 'Berhasil', `${deletedCount} data orphaned telah dibersihkan.`);
                
            } catch (error) {
                console.error('Cleanup error:', error);
                showToast('error', 'Gagal', 'Gagal membersihkan data.');
            } finally {
                hideLoading();
            }
        }

        // ==================== SYSTEM INFO ====================
        function showSystemInfo() {
            const info = {
                'Total Anggota': members.length,
                'Total Kehadiran': attendance.length,
                'Total Transaksi': finance.length,
                'Total Pengguna': users.length,
                'Versi Sistem': '2.0.0',
                'Terakhir Update': formatDateTime(Math.max(
                    ...members.map(m => m.updatedAt || 0),
                    ...attendance.map(a => a.updatedAt || 0),
                    ...finance.map(f => f.updatedAt || 0)
                )),
                'Pengguna Aktif': currentUser.username,
                'Role': getRoleDisplayText(currentUser.role)
            };
            
            let infoHTML = '<div style="padding: 20px;"><h3>üìä Informasi Sistem</h3><table style="width: 100%;">';
            
            Object.entries(info).forEach(([key, value]) => {
                infoHTML += `
                    <tr>
                        <td style="padding: 8px; font-weight: bold; color: #2c3e50;">${key}</td>
                        <td style="padding: 8px;">${value}</td>
                    </tr>
                `;
            });
            
            infoHTML += '</table></div>';
            
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.style.display = 'flex';
            modal.innerHTML = `
                <div class="modal-box" style="max-width: 500px;">
                    <div class="modal-header">
                        <h3>‚ÑπÔ∏è Informasi Sistem</h3>
                        <div class="modal-close" onclick="this.parentElement.parentElement.remove()">√ó</div>
                    </div>
                    <div class="modal-body">
                        ${infoHTML}
                    </div>
                    <div class="modal-footer">
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" class="btn btn-danger">Tutup</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        // ==================== INITIALIZATION COMPLETE ====================
        console.log('‚úÖ Sistem Girsang Boru Panagolan Tangerang siap digunakan.');
    </script>
</body>
</html>
